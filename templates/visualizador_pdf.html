<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visualizador de Documento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Biblioteca PDF.js (versão estável) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #525659; /* Cor de fundo cinza, comum em visualizadores */
        }
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #viewer-main-container {
            flex-grow: 1;
            overflow: auto; /* Permite scroll se o zoom for aplicado */
            -webkit-overflow-scrolling: touch; /* Melhora a rolagem em iOS */
        }
        #viewer-container {
            position: relative;
        }
        #viewer-container canvas {
            display: block;
            margin: 1rem auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            max-width: 100%;
        }
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Cabeçalho fixo com o botão Voltar -->
        <header class="bg-gray-800 text-white p-3 flex items-center justify-between flex-shrink-0 z-10 shadow-lg">
            <h1 class="text-lg font-semibold truncate">Visualizador</h1>

            <!-- Container dos Botões -->
            <div class="flex items-center gap-2">
                <!-- Botão de Download -->
                <button id="download-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded flex items-center gap-2 whitespace-nowrap" title="Baixar o documento">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <span class="hidden sm:inline">Baixar</span>
                </button>
                                
                <!-- Botão Voltar -->
                <button onclick="history.back()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded flex items-center gap-2 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Voltar
                </button>
            </div>
        </header>

        <!-- Container principal onde o PDF será renderizado -->
        <div id="viewer-main-container">
            <div id="viewer-container">
                <div id="loading-indicator">Carregando documento...</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

            const viewerContainer = document.getElementById('viewer-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const downloadBtn = document.getElementById('download-btn');
            const params = new URLSearchParams(window.location.search);
            const pdfUrl = params.get('url');

            // --- INÍCIO DA NOVA FUNÇÃO DE DOWNLOAD ---
            async function forceDownload(url) {
                // Desabilita o botão para evitar cliques múltiplos
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = 'Baixando...';

                try {
                    // 1. Busca o arquivo PDF como um conjunto de bytes (blob)
                    const response = await fetch(url);
                    const blob = await response.blob();
                    
                    // 2. Extrai o nome do arquivo da URL
                    let filename = "documento.pdf";
                    try {
                        let decodedUrl = decodeURIComponent(url);
                        filename = decodedUrl.substring(decodedUrl.lastIndexOf('/') + 1).split('?')[0];
                    } catch(e) { /* Usa o nome padrão se falhar */ }

                    // 3. Cria um link temporário na memória
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;

                    // 4. Simula o clique no link para iniciar o download
                    document.body.appendChild(link);
                    link.click();
                    
                    // 5. Limpa o link da memória
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(link.href);

                } catch (error) {
                    console.error('Erro ao baixar o PDF:', error);
                    alert('Não foi possível baixar o arquivo. Verifique sua conexão e tente novamente.');
                } finally {
                    // Reabilita o botão após a tentativa de download
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <span class="hidden sm:inline">Baixar</span>`;
                }
            }
            // --- FIM DA NOVA FUNÇÃO DE DOWNLOAD ---


            if (!pdfUrl) {
                loadingIndicator.textContent = "Erro: URL do PDF não encontrada.";
                if (downloadBtn) downloadBtn.style.display = 'none';
                return;
            }
            
            // Atribui o evento de clique ao botão
            if (downloadBtn) {
                downloadBtn.addEventListener('click', () => {
                    forceDownload(pdfUrl);
                });
            }
            
            async function renderPdf() {
                try {
                    const pdf = await pdfjsLib.getDocument(pdfUrl).promise;
                    loadingIndicator.style.display = 'none';

                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const viewport = page.getViewport({ scale: 1.5 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        viewerContainer.appendChild(canvas);
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                    }
                } catch (error) {
                    console.error("Erro ao carregar ou renderizar o PDF:", error);
                    loadingIndicator.textContent = "Falha ao carregar o documento.";
                }
            }
            
            renderPdf();
        });
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => { // <-- CORREÇÃO AQUI
                console.log('ServiceWorker registrado com sucesso na raiz:', registration.scope);
            }).catch(error => {
                console.log('Falha ao registrar o ServiceWorker na raiz:', error);
            });
        });
    }
</script>
</body>
</html>