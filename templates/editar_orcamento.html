<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Orçamento #{{ orcamento.numero }}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body>
    <script>
        const orcamentoData = JSON.parse('{{ orcamento.json() | safe }}');
    </script>
</body>

<header class="bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg px-4 sm:px-6 py-3 flex items-center justify-between text-white sticky top-0 z-50">
  <!-- Esquerda: Avatar + Nome -->
  <div class="flex items-center gap-3">
    <!-- Avatar -->
    <div class="w-10 h-10 rounded-full bg-white/20 ring-2 ring-white/50 flex items-center justify-center text-white font-bold text-xl shadow-md flex-shrink-0">
      {{ user.username[0]|upper }}
    </div>
    <!-- Nome do Usuário: sempre visível -->
    <div class="font-semibold text-base sm:text-lg">
      Olá, <span class="font-bold">{{ user.username }}</span>
    </div>
  </div>
  <!-- Direita: Botões de Ação -->
  <div class="flex items-center gap-2 sm:gap-3">
    <!-- Botão Orçamentos -->
    <a href="/orcamentos"
       class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h4a1 1 0 100-2H7zm0 4a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" />
      </svg>
      <span class="font-semibold hidden sm:inline">Orçamentos</span>
    </a>
    <!-- Botão Sair -->
    <a href="/logout"
       class="flex items-center gap-2 px-3 py-2 bg-red-500/80 hover:bg-red-500 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
      </svg>
      <span class="font-semibold hidden sm:inline">Sair</span>
    </a>
  </div>
</header>

    <div class="flex flex-col gap-8 p-8 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-3xl md:text-4xl font-extrabold text-center mb-1 bg-gradient-to-tr from-green-600 to-green-400 bg-clip-text text-transparent drop-shadow">
        Editar Orçamento #{{ orcamento.numero }}
        </h1>
        <form id="orcamentoForm" action="/atualizar-orcamento/{{ orcamento.id }}" method="post" class="flex flex-col gap-4">

            <!-- DADOS DO CLIENTE E ENDEREÇO -->
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="nome" class="text-sm font-bold">Nome do Cliente:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.99 5.99 0 0 0-4.793 2.39A6.483 6.483 0 0 0 10 16.5a6.483 6.483 0 0 0 4.793-2.11A5.99 5.99 0 0 0 10 12Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input class="h-10 w-full ps-10 pe-20 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="nome" name="nome" required>
                </div>
            </div>
            <input type="hidden" name="cliente_id" id="cliente_id">
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="cep" class="text-sm font-bold">CEP:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="cep" name="cep" placeholder="_____-___" maxlength="9" inputmode="numeric">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="numero_casa" class="text-sm font-bold">Número:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M9.493 2.852a.75.75 0 0 0-1.486-.204L7.545 6H4.198a.75.75 0 0 0 0 1.5h3.14l-.69 5H3.302a.75.75 0 0 0 0 1.5h3.14l-.435 3.148a.75.75 0 0 0 1.486.204L7.955 14h2.986l-.434 3.148a.75.75 0 0 0 1.486.204L12.456 14h3.346a.75.75 0 0 0 0-1.5h-3.14l.69-5h3.346a.75.75 0 0 0 0-1.5h-3.14l.435-3.148a.75.75 0 0 0-1.486-.204L12.045 6H9.059l.434-3.148ZM8.852 7.5l-.69 5h2.986l.69-5H8.852Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="numero_casa" name="numero_casa" required inputmode="numeric">
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="logradouro" class="text-sm font-bold">Rua:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="m9.69 18.933.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 0 0 .281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 1 0 3 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 0 0 2.273 1.765 11.842 11.842 0 0 0 .976.544l.062.029.018.008.006.003ZM10 11.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="logradouro" name="logradouro" required>
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="complemento" class="text-sm font-bold">Complemento:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="complemento" name="complemento">
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="bairro" class="text-sm font-bold">Bairro:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M8.157 2.176a1.5 1.5 0 0 0-1.147 0l-4.084 1.69A1.5 1.5 0 0 0 2 5.25v10.877a1.5 1.5 0 0 0 2.074 1.386l3.51-1.452 4.26 1.762a1.5 1.5 0 0 0 1.146 0l4.083-1.69A1.5 1.5 0 0 0 18 14.75V3.872a1.5 1.5 0 0 0-2.073-1.386l-3.51 1.452-4.26-1.762ZM7.58 5a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1-1.5 0v-6.5A.75.75 0 0 1 7.58 5Zm5.59 2.75a.75.75 0 0 0-1.5 0v6.5a.75.75 0 0 0 1.5 0v-6.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="bairro" name="bairro" required>
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="cidade_uf" class="text-sm font-bold">Cidade/UF:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M1 2.75A.75.75 0 0 1 1.75 2h10.5a.75.75 0 0 1 0 1.5H12v13.75a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1-.75-.75v-2.5a.75.75 0 0 0-.75-.75h-2.5a.75.75 0 0 0-.75.75v2.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5H2v-13h-.25A.75.75 0 0 1 1 2.75ZM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM4.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM8 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM8.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM14.25 6a.75.75 0 0 0-.75.75V17a1 1 0 0 0 1 1h3.75a.75.75 0 0 0 0-1.5H18v-9h.25a.75.75 0 0 0 0-1.5h-4Zm.5 3.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm.5 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="cidade_uf" name="cidade_uf" required>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="telefone" class="text-sm font-bold">Telefone:</label>
                <div class="relative w-full">
                    <!-- Ícone do Telefone (como no original) -->
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 0 0 6.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 0 1 1.767-1.052l3.223.716A1.5 1.5 0 0 1 18 15.352V16.5a1.5 1.5 0 0 1-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 0 1 2.43 8.326 13.019 13.019 0 0 1 2 5V3.5Z" clip-rule="evenodd" /></svg>
                    </div>

                    <!-- O campo de Telefone (como no original, mas com padding à direita) -->
                    <input class="h-10 w-full ps-10 pe-12 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="tel" id="telefone" name="telefone" placeholder="(99) 99999-9999" maxlength="15">
                    
                    <!-- NOVO: O botão "+" discreto, posicionado dentro do campo -->
                    <button type="button" id="btnAdicionarContato" class="absolute inset-y-0 end-0 flex items-center justify-center h-10 w-10 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg border-l border-zinc-300">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                          <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Container onde as linhas extras de contato serão inseridas pelo JavaScript -->
            <div id="lista-contatos-visivel" class="w-full flex flex-wrap gap-2 mt-1"> </div>

            <!-- Input oculto para os contatos extras -->
            <input type="hidden" name="contatos" id="hiddenContatos">


            <div class="flex items-center justify-start -mt-3">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleSalvarCliente" name="salvar_cliente" class="sr-only peer">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900">Salvar cliente?</span>
                </label>
            </div>
            
            <!-- DETALHES DO ORÇAMENTO -->
            <h1 class="text-3xl sm:text-3xl md:text-4xl font-extrabold text-center mb-1 bg-gradient-to-tr from-green-600 to-green-400 bg-clip-text text-transparent drop-shadow">
            Detalhamento
            </h1>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="descricaoServico" class="text-sm font-bold">Descrição do serviço:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" /></svg></div>
                    <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="descricaoServico" name="descricao_servico" placeholder="Descreva o serviço a ser executado" required>
                </div>
            </div>
            
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="selectServico" class="text-sm font-bold">Serviço do Catálogo:</label>
                <div id="containerServico" class="relative w-full">
                    <!-- O JavaScript vai preencher este espaço -->
                </div>
            </div>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="selectMaterial" class="text-sm font-bold">Material do Catálogo:</label>
                <div id="containerMaterial" class="relative w-full">
                    <!-- O JavaScript vai preencher este espaço -->
                </div>
            </div>

            <div class="flex flex-col items-start justify-start gap-2">
                <label for="item" class="text-sm font-bold">Item:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" /></svg></div>
                    <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="item" name="item">
                </div>
            </div>
            <div class="flex flex-wrap items-start justify-start gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="itemQtd">Qtd:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M10 1c-1.716 0-3.408.106-5.07.31C3.806 1.45 3 2.414 3 3.517V16.75A2.25 2.25 0 0 0 5.25 19h9.5A2.25 2.25 0 0 0 17 16.75V3.517c0-1.103-.806-2.068-1.93-2.207A41.403 41.403 0 0 0 10 1ZM5.99 8.75A.75.75 0 0 1 6.74 8h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm1.417-5.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm1.42-5.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01ZM12.5 8.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm0 2.166a.75.75 0 0 1 .75.75v2.167a.75.75 0 1 1-1.5 0v-2.167a.75.75 0 0 1 .75-.75ZM6.75 4a.75.75 0 0 0-.75.75v.5c0 .414.336.75.75.75h6.5a.75.75 0 0 0 .75-.75v-.5a.75.75 0 0 0-.75-.75h-6.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="number" id="itemQtd" value="1" inputmode="numeric" pattern="[0-9]*">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="itemValor">Valor(unit):</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="M10.75 10.818v2.614A3.13 3.13 0 0 0 11.888 13c.482-.315.612-.648.612-.875 0-.227-.13-.56-.612-.875a3.13 3.13 0 0 0-1.138-.432ZM8.33 8.62c.053.055.115.11.184.164.208.16.46.284.736.363V6.603a2.45 2.45 0 0 0-.35.13c-.14.065-.27.143-.386.233-.377.292-.514.627-.514.909 0 .184.058.39.202.592.037.051.08.102.128.152Z" /><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-6a.75.75 0 0 1 .75.75v.316a3.78 3.78 0 0 1 1.653.713c.426.33.744.74.925 1.2a.75.75 0 0 1-1.395.55 1.35 1.35 0 0 0-.447-.563 2.187 2.187 0 0 0-.736-.363V9.3c.698.093 1.383.32 1.959.696.787.514 1.29 1.27 1.29 2.13 0 .86-.504 1.616-1.29 2.13-.576.377-1.261.603-1.96.696v.299a.75.75 0 1 1-1.5 0v-.3c-.697-.092-1.382-.318-1.958-.695-.482-.315-.857-.717-1.078-1.188a.75.75 0 1 1 1.359-.636c.08.173.245.376.54.569.313.205.706.353 1.138.432v-2.748a3.782 3.782 0 0 1-1.653-.713C6.9 9.433 6.5 8.681 6.5 7.875c0-.805.4-1.558 1.097-2.096a3.78 3.78 0 0 1 1.653-.713V4.75A.75.75 0 0 1 10 4Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="itemValor" name="itemValor" inputmode="decimal">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="tipoItem">Tipo:</label>
                    <div class="relative w-full">
                        <div id="tipoItemIcon" class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"></div>
                        <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none tipoItemSeta">                           
                        </div>
                        <select class="h-10 w-full ps-9 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400 appearance-none" id="tipoItem" name="tipoItem">
                            <option value="default">Seleção</option>
                            <option value="servico">Serviço</option>
                            <option value="material">Material</option>
                        </select>
                    </div>
                </div>
            </div>
                <div class="flex items-center justify-start gap-6 mb-4">
            
                        <!-- Esquerda: Toggle para Salvar no Catálogo -->
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleSalvar" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-900">Salvar item?</span>
                        </label>

                        <!-- Direita: Campo do Número do Orçamento -->
                        <div class="flex items-center gap-2">
                            <label for="numero_orcamento" class="text-sm font-medium text-gray-700">Nº:</label>
                            <input type="text" id="numero_orcamento" name="numero_orcamento" 
                                class="w-20 h-6 text-center font-semibold border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400" value="">
                        </div>
                        <button
                            type="button"
                            id="btn-abrir-modal-info"
                            title="Adicionar Informações Complementares"
                            class="flex items-center justify-center h-10 w-10 rounded-full bg-white shadow-md border border-emerald-200 text-emerald-600 hover:bg-emerald-50 hover:scale-105 active:scale-95 active:shadow-sm transition-all duration-150 group"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-6 group-hover:scale-110 transition-transform duration-200">
                                <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                <path fill-rule="evenodd" d="M10 14a1 1 0 0 1-1-1V9a1 1 0 1 1 2 0v4a1 1 0 0 1-1 1zm0-6a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
            
            <div class="flex flex-col gap-2">
                <button id="adicionarItemBtn" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold uppercase tracking-wide rounded-2xl shadow-lg transform hover:-translate-y-0.5 transition-all duration-200" type="button">Adicionar Item</button>
                <button id="gerarOrcamentoBtn" class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold uppercase tracking-wide rounded-xl shadow-md transform hover:-translate-y-0.5 transition-all duration-200" type="submit">Atualizar Orçamento</button>
            </div>
            
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden" id="tableContainer">
                <table class="w-full text-sm text-left rtl:text-right">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3">Item / Tipo</th>
                            <th scope="col" class="px-4 py-3 text-center">Qtd</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Unit</th>
                            <th scope="col" class="px-4 py-3 text-right">Total</th>
                            <th scope="col" class="px-4 py-3 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="itensContainer">
                    </tbody>
                </table>
            </div>
        <input type="hidden" name="itens" id="hiddenItens" />
        <input type="hidden" name="condicao_pagamento" id="hidden_condicao_pagamento" />
        <input type="hidden" name="prazo_entrega" id="hidden_prazo_entrega" />
        <input type="hidden" name="garantia" id="hidden_garantia" />
        <input type="hidden" name="observacoes" id="hidden_observacoes" />    
        </form>
    </div>

    <!-- O Modal de Clientes (começa escondido) -->
            <div id="modalClientes" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
            <div id="modalClientesBox" class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
                <div class="flex items-center justify-between p-4 border-b">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 bg-gray-100 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-600">
                                <path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.25 1.25 0 0 1 2.228-1.567l.11-.128a5 5 0 0 1 7.4-2.228l.11.128a1.25 1.25 0 0 1 2.228 1.567l-.11.128a3.5 3.5 0 0 1-5.18 1.567l-.255.255a.75.75 0 0 1-1.06 0l-.255-.255a3.5 3.5 0 0 1-5.18-1.567l-.11-.128Z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Selecione um Cliente</h3>
                    </div>
                    <button id="btnFecharModalClientes" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
                </div>
                <div class="p-1">
                    <input type="text" id="filtroCliente" class="w-full h-10 px-3 my-2 border border-zinc-200 rounded-md" placeholder="Buscar por nome...">
                </div>
                <div id="listaClientesModal" class="p-2 max-h-80 overflow-y-auto">
                    <!-- A lista de clientes será inserida aqui pelo JavaScript -->
                </div>
            </div>
        </div>
        <div id="modal-info" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-info-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Informações Adicionais do Orçamento</h3>
                <button id="btn-fechar-modal-info" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            <div class="mt-4 space-y-4">
                
                <div>
                    <label for="info-condicao-pagamento" class="block text-sm font-medium text-gray-700">Condição de Pagamento:</label>
                    <select id="info-condicao-pagamento" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">-- Selecione --</option>
                        <option value="À vista">À vista</option>
                        <option value="Pix">Pix</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="50% de entrada, 50% na entrega">50% de entrada, 50% na entrega</option>
                        <option value="30 dias">30 dias</option>
                        <option value="A combinar">A combinar</option>
                    </select>
                </div>

                <div>
                    <label for="info-prazo-entrega" class="block text-sm font-medium text-gray-700">Prazo de Entrega/Execução:</label>
                    <input type="text" id="info-prazo-entrega" placeholder="Ex: 7 dias úteis após aprovação" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="info-garantia" class="block text-sm font-medium text-gray-700">Garantia:</label>
                    <input type="text" id="info-garantia" placeholder="Ex: 90 dias para o serviço prestado" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="info-observacoes" class="block text-sm font-medium text-gray-700">Observações Adicionais:</label>
                    <textarea id="info-observacoes" rows="3" placeholder="Informações extras, detalhes específicos, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

            </div>
            <div class="mt-6 text-right">
                <button id="btn-salvar-info" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
      <div id="modal-contato" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-contato-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Adicionar Novo Contato</h3>
                <button id="btn-fechar-modal-contato" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            <div class="mt-4 space-y-4">
                
                <div>
                    <label for="modal-contato-nome" class="block text-sm font-medium text-gray-700">Nome do Contato:</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.25 1.25 0 0 1 2.228-1.567l.11-.128a5 5 0 0 1 7.4-2.228l.11.128a1.25 1.25 0 0 1 2.228 1.567l-.11.128a3.5 3.5 0 0 1-5.18 1.567l-.255.255a.75.75 0 0 1-1.06 0l-.255-.255a3.5 3.5 0 0 1-5.18-1.567l-.11-.128Z" /></svg>
                        </div>
                        <input type="text" id="modal-contato-nome" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400">
                    </div>
                </div>

                <div>
                    <label for="modal-contato-telefone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 0 0 6.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 0 1 1.767-1.052l3.223.716A1.5 1.5 0 0 1 18 15.352V16.5a1.5 1.5 0 0 1-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 0 1 2.43 8.326 13.019 13.019 0 0 1 2 5V3.5Z" clip-rule="evenodd" /></svg>
                        </div>
                        <input type="tel" id="modal-contato-telefone" placeholder="(99) 99999-9999" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" maxlength="15" oninput="mascara(event, '(##) #####-####')">
                    </div>
                </div>

            </div>
            <div class="mt-6 text-right">
                <button id="btn-salvar-contato-modal" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Adicionar
                </button>
            </div>
        </div>
    </div>
        <div id="modal-catalogo" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] transition-opacity duration-300">
        <div id="modal-catalogo-box" class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh] transform transition-all -translate-y-10 opacity-0 duration-300">
            <!-- Cabeçalho do Modal -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 id="modal-catalogo-titulo" class="text-xl font-semibold text-gray-800">Buscar no Catálogo</h3>
                <button id="btn-fechar-modal-catalogo" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            
            <!-- Campo de Busca -->
            <div class="p-4 border-b">
                <input type="text" id="filtro-catalogo-input" class="w-full h-10 px-3 border border-zinc-300 rounded-md shadow-sm" placeholder="Digite para buscar...">
            </div>
            
            <!-- Lista de Itens (com rolagem) -->
            <div id="lista-catalogo-modal" class="p-2 overflow-y-auto">
                <!-- A lista de itens do catálogo será inserida aqui pelo JavaScript -->
            </div>
        </div>
    </div>

<script>


document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1. VARIÁVEIS GLOBAIS ---
    const API_BASE_URL = window.location.origin;
    let itens = orcamentoData.itens || [];
    let contatosExtras = (orcamentoData.cliente && orcamentoData.cliente.contatos) ? orcamentoData.cliente.contatos : [];
    let servicosCatalogo = [];
    let materiaisCatalogo = [];

    // --- 2. ELEMENTOS DO DOM ---
    const form = document.getElementById("orcamentoForm");
    const tableContainer = document.getElementById("tableContainer");
    const itensContainer = document.getElementById("itensContainer");
    const itemInput = document.getElementById("item");
    const itemQtdInput = document.getElementById("itemQtd");
    const itemValorInput = document.getElementById("itemValor");
    const adicionarItemBtn = document.getElementById("adicionarItemBtn");
    const tipoItemSelect = document.getElementById("tipoItem");
    const telefoneInput = document.getElementById("telefone");
    const listaContatosVisivel = document.getElementById('lista-contatos-visivel');
    const btnAdicionarContato = document.getElementById("btnAdicionarContato");
    const modalContato = document.getElementById('modal-contato');
    const modalContatoBox = document.getElementById('modal-contato-box');
    const btnFecharModalContato = document.getElementById('btn-fechar-modal-contato');
    const btnSalvarContatoModal = document.getElementById('btn-salvar-contato-modal');
    const modalInfo = document.getElementById('modal-info');
    const modalInfoBox = document.getElementById('modal-info-box');
    const btnAbrirModalInfo = document.getElementById('btn-abrir-modal-info');
    const btnFecharModalInfo = document.getElementById('btn-fechar-modal-info');
    const btnSalvarInfo = document.getElementById('btn-salvar-info');
    const tipoItemIconDiv = document.getElementById("tipoItemIcon");

    // ELEMENTOS DO MODAL DE CATÁLOGO
    const modalCatalogo = document.getElementById('modal-catalogo');
    const modalCatalogoBox = document.getElementById('modal-catalogo-box');
    const modalCatalogoTitulo = document.getElementById('modal-catalogo-titulo');
    const btnFecharModalCatalogo = document.getElementById('btn-fechar-modal-catalogo');
    const filtroCatalogoInput = document.getElementById('filtro-catalogo-input');
    const listaCatalogoModal = document.getElementById('lista-catalogo-modal');

    const icons = {
        servico: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M14.5 10a4.5 4.5 0 004.284-5.882c-.105-.324-.51-.391-.752-.15L15.34 6.66a.454.454 0 01-.493.11 3.01 3.01 0 01-1.618-1.616.455.455 0 01.11-.494l2.694-2.692c.24-.241.174-.647-.15-.752a4.5 4.5 0 00-5.873 4.575c.055.873-.128 1.808-.8 2.368l-7.23 6.024a2.724 2.724 0 103.837 3.837l6.024-7.23c.56-.672 1.495-.855 2.368-.8.096.007.193.01.291.01ZM5 16a1 1 0 10-2 0 1 1 0 002 0Z" clip-rule="evenodd" /><path d="M14.5 11.5c.173 0 .345-.007.514-.022l3.754 3.754a2.5 2.5 0 01-3.536 3.536l-4.41-4.41 2.172-2.607c.052-.063.147-.138.342-.196.202-.06.469-.087.777-.067.128.008.257.012.387.012ZM6 4.586l2.33 2.33a.452.452 0 01-.08.09L6.8 8.214 4.586 6H3.309a.5.5 0 01-.447-.276l-1.7-3.402a.5.5 0 01.093-.577l.49-.49a.5.5 0 01.577-.094l3.402 1.7A.5.5 0 016 3.31v1.277Z" /></svg>`,
        material: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" /></svg>`,
        default: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>`
    };
    
    // --- 3. FUNÇÕES ---

    function formatarMoeda(e) { let v = e.target.value.replace(/\D/g,""); e.target.value = !v ? "" : (parseFloat(v)/100).toLocaleString("pt-BR", {minimumFractionDigits: 2}); }
    window.mascara = (e,p) => { let i=0, v=e.target.value.replace(/\D/g,""); e.target.value = p.replace(/#/g, ()=> v[i++]||""); };
    const updateTableVisibility = () => tableContainer.classList.toggle("hidden", itens.length === 0);
    function limparCamposItem() { itemInput.value = ""; itemQtdInput.value = "1"; itemValorInput.value = ""; tipoItemSelect.value = "default"; updateTipoItemIcon(); itemInput.focus(); }
    const updateTipoItemIcon = () => tipoItemIconDiv.innerHTML = icons[tipoItemSelect.value] || icons.default;

    // --- Funções do Modal de Catálogo ---
    function abrirModalCatalogo(tipo) {
        modalCatalogoTitulo.textContent = `Buscar em ${tipo === 'servico' ? 'Serviços' : 'Materiais'}`;
        modalCatalogo.dataset.tipoAtual = tipo;
        popularListaModalCatalogo(tipo, '');
        modalCatalogo.classList.remove('hidden');
        modalCatalogo.classList.add('flex');
        setTimeout(() => { modalCatalogoBox.classList.remove('-translate-y-10', 'opacity-0'); filtroCatalogoInput.focus(); }, 50);
    }

    function fecharModalCatalogo() {
        modalCatalogoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalCatalogo.classList.add('hidden'); modalCatalogo.classList.remove('flex'); filtroCatalogoInput.value = ''; }, 300);
    }

    function popularListaModalCatalogo(tipo, filtro) {
        const catalogo = tipo === 'servico' ? servicosCatalogo : materiaisCatalogo;
        const termoBusca = filtro.toLowerCase();
        const itensFiltrados = catalogo.filter(item => item.nome.toLowerCase().includes(termoBusca));
        
        listaCatalogoModal.innerHTML = '';
        if (itensFiltrados.length === 0) {
            listaCatalogoModal.innerHTML = '<p class="p-4 text-center text-gray-400">Nenhum item encontrado.</p>';
            return;
        }
        
        itensFiltrados.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'p-3 flex justify-between items-center rounded-lg hover:bg-emerald-50 border-b last:border-b-0';
            itemDiv.innerHTML = `
                <div class="flex flex-col flex-grow cursor-pointer">
                    <span class="font-semibold text-gray-800">${item.nome}</span>
                    <span class="text-sm text-gray-500">${item.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</span>
                </div>
                <button type="button" class="btn-excluir-item-catalogo p-2 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600">
                    <svg class="size-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM6.05 6a.75.75 0 0 1 .787.71l.5 5a.75.75 0 1 1-1.474.14l-.5-5A.75.75 0 0 1 6.05 6Zm3.9 0a.75.75 0 0 1 .71.787l-.5 5a.75.75 0 1 1-1.474-.14l.5-5a.75.75 0 0 1 .764-.647Z" clip-rule="evenodd" /></svg>
                </button>
            `;
            itemDiv.querySelector(".flex-grow").addEventListener('click', () => selecionarItemDoModal(item.id, tipo));
            itemDiv.querySelector(".btn-excluir-item-catalogo").addEventListener('click', (e) => {
                e.stopPropagation();
                confirmarExclusao(item.id, item.nome);
            });
            listaCatalogoModal.appendChild(itemDiv);
        });
    }

    function selecionarItemDoModal(itemId, tipo) {
        const selectId = tipo === 'servico' ? 'containerServico' : 'containerMaterial';
        const select = document.querySelector(`#${selectId} select`);
        select.value = itemId;
        select.dispatchEvent(new Event('change'));
        fecharModalCatalogo();
    }

    async function confirmarExclusao(itemId, itemName) {
        if (!confirm(`Tem certeza que deseja excluir "${itemName}" do catálogo?`)) return;
        try {
            const response = await fetch(`${API_BASE_URL}/api/item/${itemId}`, { method: 'DELETE' });
            if (response.status !== 204) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || "Falha ao excluir o item.");
            }
            if(itemInput.value === itemName) limparCamposItem();
            await carregarCatalogosAPI();
            const tipoAtual = modalCatalogo.dataset.tipoAtual;
            const filtroAtual = filtroCatalogoInput.value;
            popularListaModalCatalogo(tipoAtual, filtroAtual);
        } catch (error) {
            console.error("Erro ao excluir item:", error);
            alert(`Ocorreu um erro: ${error.message}`);
        }
    }

    // --- Funções do Catálogo (Renderização no formulário) ---
    async function carregarCatalogosAPI() {
        try {
            const [respServ, respMat] = await Promise.all([ fetch(`${API_BASE_URL}/api/servico/`), fetch(`${API_BASE_URL}/api/materiais/`) ]);
            if (!respServ.ok || !respMat.ok) throw new Error("Falha ao carregar catálogos.");
            servicosCatalogo = await respServ.json();
            materiaisCatalogo = await respMat.json();
            renderizarSeletor("servico");
            renderizarSeletor("material");
        } catch (error) { console.error(error); }
    }
    
    function renderizarSeletor(tipo) {
        const container = document.getElementById(tipo === "servico" ? "containerServico" : "containerMaterial");
        const catalogo = tipo === "servico" ? servicosCatalogo : materiaisCatalogo;
        const placeholder = tipo === "servico" ? "-- Selecione um Serviço --" : "-- Selecione um Material --";
        container.innerHTML = `
            <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">${icons[tipo]}</div>
            <select class="select-catalogo h-10 w-full ps-10 pe-20 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400 appearance-none">
                <option value="">${placeholder}</option>
                ${catalogo.map(item => `<option value="${item.id}">${item.nome}</option>`).join("")}
            </select>
            <button type="button" data-tipo-catalogo="${tipo}" class="btn-abrir-modal-catalogo absolute inset-y-0 end-0 flex items-center justify-center px-3 border-l border-zinc-300 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
            </button>`;
        container.querySelector("select").addEventListener("change", (e) => handleSelecaoCatalogo(e, tipo));
        container.querySelector(".btn-abrir-modal-catalogo").addEventListener("click", (e) => {
            abrirModalCatalogo(e.currentTarget.dataset.tipoCatalogo);
        });
    }

    function handleSelecaoCatalogo(e, tipo) {
        const selectElement = e.target;
        const id = selectElement.value;
        if (!id) { itemInput.value = ''; itemValorInput.value = ''; return; }
        const itemSelecionado = (tipo === "servico" ? servicosCatalogo : materiaisCatalogo).find(item => String(item.id) === id);
        if (itemSelecionado) {
            itemInput.value = itemSelecionado.nome;
            itemValorInput.value = itemSelecionado.valor.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
            tipoItemSelect.value = tipo;
            updateTipoItemIcon();
            itemQtdInput.focus();
        }
    }
    
    // --- Funções de Itens do Orçamento ---
    function adicionarItemNaTela(item) {
        const rowId = item.id || `temp-${Date.now()}`;
        item.id = rowId;
        const total = (item.quantidade || 0) * (item.valor || 0);
        const tr = document.createElement("tr");
        tr.className = "bg-white border-b hover:bg-gray-50";
        tr.dataset.id = rowId;
        tr.innerHTML = `
            <td class="px-4 py-3 font-medium text-gray-900 capitalize">${item.nome} (${item.tipo})</td>
            <td class="px-4 py-3 text-center">${item.quantidade}</td>
            <td class="px-4 py-3 text-right">${(item.valor || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
            <td class="px-4 py-3 text-right">${total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
            <td class="px-4 py-3 text-center"><button type="button" class="text-red-500" data-action="remover-item">Excluir</button></td>`;
        tr.querySelector("[data-action='remover-item']").addEventListener("click", () => removerItem(rowId));
        itensContainer.appendChild(tr);
    }

    function renderizarItensNaTabela() {
        itensContainer.innerHTML = "";
        itens.forEach(item => adicionarItemNaTela(item));
        updateTableVisibility();
    }
    
    function removerItem(rowId) {
        itens = itens.filter(item => String(item.id) !== String(rowId));
        renderizarItensNaTabela();
    }

    function adicionarItem() {
        const nomeVal = itemInput.value.trim(), qtdVal = parseInt(itemQtdInput.value, 10), valStr = itemValorInput.value, tipoVal = tipoItemSelect.value;
        if (!nomeVal || isNaN(qtdVal) || !valStr || tipoVal === "default") { alert("Preencha todos os campos do item."); return; }
        const valVal = parseFloat(valStr.replace(/\./g, "").replace(",", "."));
        // Na tela de edição, não salvamos itens novos no catálogo
        itens.push({ id: `temp-${Date.now()}`, nome: nomeVal, quantidade: qtdVal, valor: valVal, tipo: tipoVal });
        renderizarItensNaTabela();
        limparCamposItem();
    }


    // --- Funções de Contatos Extras e Modal de Info (SEM ALTERAÇÃO) ---
    function abrirModalContato() { document.getElementById('modal-contato-nome').value=''; document.getElementById('modal-contato-telefone').value=''; modalContato.classList.remove('hidden'); modalContato.classList.add('flex'); setTimeout(()=>modalContatoBox.classList.remove('-translate-y-10','opacity-0'),50); }
    function fecharModalContato() { modalContatoBox.classList.add('-translate-y-10','opacity-0'); setTimeout(()=>{ modalContato.classList.add('hidden'); modalContato.classList.remove('flex');},300); }
    function salvarContatoDoModal() { const n=document.getElementById('modal-contato-nome').value.trim(), t=document.getElementById('modal-contato-telefone').value.trim(); if(!n||!t){alert("Preencha nome e telefone.");return} contatosExtras.push({id:null,nome:n,telefone:t}); renderizarTagsDeContato(); fecharModalContato(); }
    function renderizarTagsDeContato() { listaContatosVisivel.innerHTML=''; contatosExtras.forEach((c,i)=>{const d=document.createElement('div'); d.className="flex items-center gap-2 bg-emerald-100 text-emerald-800 text-sm font-semibold px-3 py-1 rounded-full"; d.innerHTML=`<span>${c.nome} - ${c.telefone}</span><button type="button" onclick="removerContatoExtra(${i})" class="text-emerald-600 hover:text-emerald-900"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4"><path d="M2.22 2.22a.75.75 0 0 1 1.06 0L8 6.94l4.72-4.72a.75.75 0 1 1 1.06 1.06L9.06 8l4.72 4.72a.75.75 0 1 1-1.06 1.06L8 9.06l-4.72 4.72a.75.75 0 0 1-1.06-1.06L6.94 8 2.22 3.28a.75.75 0 0 1 0-1.06Z" /></svg></button>`; listaContatosVisivel.appendChild(d);}); }
    window.removerContatoExtra = (i) => { contatosExtras.splice(i,1); renderizarTagsDeContato(); };
    function abrirModalInfo() { document.getElementById('info-condicao-pagamento').value = document.getElementById('hidden_condicao_pagamento').value; document.getElementById('info-prazo-entrega').value = document.getElementById('hidden_prazo_entrega').value; document.getElementById('info-garantia').value = document.getElementById('hidden_garantia').value; document.getElementById('info-observacoes').value = document.getElementById('hidden_observacoes').value; modalInfo.classList.remove('hidden'); modalInfo.classList.add('flex'); setTimeout(()=>modalInfoBox.classList.remove('-translate-y-10','opacity-0'),50); }
    function fecharModalInfo() { modalInfoBox.classList.add('-translate-y-10','opacity-0'); setTimeout(() => { modalInfo.classList.add('hidden'); modalInfo.classList.remove('flex'); }, 300); }
    function salvarInfoModal() { document.getElementById('hidden_condicao_pagamento').value=document.getElementById('info-condicao-pagamento').value; document.getElementById('hidden_prazo_entrega').value=document.getElementById('info-prazo-entrega').value; document.getElementById('hidden_garantia').value=document.getElementById('info-garantia').value; document.getElementById('hidden_observacoes').value=document.getElementById('info-observacoes').value; fecharModalInfo(); }

    // --- INICIALIZAÇÃO ---
    function preencherFormulario() {
        const cliente = orcamentoData.cliente;
        document.getElementById('nome').value = cliente?.nome || orcamentoData.nome_cliente || '';
        document.getElementById('telefone').value = cliente?.telefone || orcamentoData.telefone_cliente || '';
        document.getElementById('cep').value = cliente?.cep || orcamentoData.cep_cliente || '';
        document.getElementById('logradouro').value = cliente?.logradouro || orcamentoData.logradouro_cliente || '';
        document.getElementById('numero_casa').value = cliente?.numero_casa || orcamentoData.numero_casa_cliente || '';
        document.getElementById('complemento').value = cliente?.complemento || orcamentoData.complemento_cliente || '';
        document.getElementById('bairro').value = cliente?.bairro || orcamentoData.bairro_cliente || '';
        document.getElementById('cidade_uf').value = cliente?.cidade_uf || orcamentoData.cidade_uf_cliente || '';
        document.getElementById('numero_orcamento').value = orcamentoData.numero;
        document.getElementById('descricaoServico').value = orcamentoData.descricao_servico;
        document.getElementById('hidden_condicao_pagamento').value = orcamentoData.condicao_pagamento || '';
        document.getElementById('hidden_prazo_entrega').value = orcamentoData.prazo_entrega || '';
        document.getElementById('hidden_garantia').value = orcamentoData.garantia || '';
        document.getElementById('hidden_observacoes').value = orcamentoData.observacoes || '';
        renderizarItensNaTabela();
        renderizarTagsDeContato();
    }
    
    function inicializar() {
        preencherFormulario();
        carregarCatalogosAPI();
        updateTipoItemIcon();

        // Listeners
        adicionarItemBtn.addEventListener("click", adicionarItem);
        itemValorInput.addEventListener("input", formatarMoeda);
        telefoneInput.addEventListener("input", (e) => mascara(e, "(##) #####-####"));
        tipoItemSelect.addEventListener("change", updateTipoItemIcon);

        btnAbrirModalInfo.addEventListener('click', abrirModalInfo);
        btnFecharModalInfo.addEventListener('click', fecharModalInfo);
        btnSalvarInfo.addEventListener('click', salvarInfoModal);
        
        btnAdicionarContato.addEventListener('click', abrirModalContato);
        btnFecharModalContato.addEventListener('click', fecharModalContato);
        btnSalvarContatoModal.addEventListener('click', salvarContatoDoModal);

        // Listeners do Modal de Catálogo
        btnFecharModalCatalogo.addEventListener('click', fecharModalCatalogo);
        modalCatalogo.addEventListener('click', (event) => { if (event.target === modalCatalogo) fecharModalCatalogo(); });
        filtroCatalogoInput.addEventListener('input', (e) => {
            const tipoAtual = modalCatalogo.dataset.tipoAtual;
            popularListaModalCatalogo(tipoAtual, e.target.value);
        });

        // Submissão
        form.addEventListener("submit", (e) => {
            if (itens.length === 0) { e.preventDefault(); alert("O orçamento deve ter pelo menos um item."); return; }
            document.getElementById("hiddenItens").value = JSON.stringify(itens);
            document.getElementById("hiddenContatos").value = JSON.stringify(contatosExtras);
        });
    }

    inicializar();
});

</script>

</body>
</html>