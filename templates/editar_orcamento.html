<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Orçamento #{{ orcamento.numero }}</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body>
    <script id="orcamento-json" type="application/json">
    {{ orcamento.model_dump_json() | safe }}
    </script>

<header class="bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg px-4 sm:px-6 py-3 flex items-center justify-between text-white sticky top-0 z-50">
  <!-- Esquerda: Avatar + Nome -->
  <div class="flex items-center gap-3">
    <!-- Avatar -->
    <div class="w-10 h-10 rounded-full bg-white/20 ring-2 ring-white/50 flex items-center justify-center text-white font-bold text-xl shadow-md flex-shrink-0">
      {{ user.username[0]|upper }}
    </div>
    <!-- Nome do Usuário: sempre visível -->
    <div class="font-semibold text-base sm:text-lg">
      Olá, <span class="font-bold">{{ user.username }}</span>
    </div>
  </div>
  <!-- Direita: Botões de Ação -->
  <div class="flex items-center gap-2 sm:gap-3">
    <!-- Botão Orçamentos -->
    <a href="/orcamentos"
       class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h4a1 1 0 100-2H7zm0 4a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" />
      </svg>
      <span class="font-semibold hidden sm:inline">Orçamentos</span>
    </a>
    <!-- Botão Sair -->
    <a href="/logout"
       class="flex items-center gap-2 px-3 py-2 bg-red-500/80 hover:bg-red-500 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
      </svg>
      <span class="font-semibold hidden sm:inline">Sair</span>
    </a>
  </div>
</header>

    <div class="flex flex-col gap-8 p-8 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-3xl md:text-4xl font-extrabold text-center mb-1 bg-gradient-to-tr from-green-600 to-green-400 bg-clip-text text-transparent drop-shadow">
        Editar Orçamento #{{ orcamento.numero }}
        </h1>
        <form id="orcamentoForm" action="/atualizar-orcamento/{{ orcamento.id }}" method="post" class="flex flex-col gap-4">

            <!-- DADOS DO CLIENTE E ENDEREÇO -->
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="nome" class="text-sm font-bold">Nome do Cliente:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.99 5.99 0 0 0-4.793 2.39A6.483 6.483 0 0 0 10 16.5a6.483 6.483 0 0 0 4.793-2.11A5.99 5.99 0 0 0 10 12Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input class="h-10 w-full ps-10 pe-20 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="nome" name="nome" required>
                </div>
            </div>
            <input type="hidden" name="cliente_id" id="cliente_id">
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="cep" class="text-sm font-bold">CEP:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="cep" name="cep" placeholder="_____-___" maxlength="9" inputmode="numeric">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="numero_casa" class="text-sm font-bold">Número:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M9.493 2.852a.75.75 0 0 0-1.486-.204L7.545 6H4.198a.75.75 0 0 0 0 1.5h3.14l-.69 5H3.302a.75.75 0 0 0 0 1.5h3.14l-.435 3.148a.75.75 0 0 0 1.486.204L7.955 14h2.986l-.434 3.148a.75.75 0 0 0 1.486.204L12.456 14h3.346a.75.75 0 0 0 0-1.5h-3.14l.69-5h3.346a.75.75 0 0 0 0-1.5h-3.14l.435-3.148a.75.75 0 0 0-1.486-.204L12.045 6H9.059l.434-3.148ZM8.852 7.5l-.69 5h2.986l.69-5H8.852Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="numero_casa" name="numero_casa" required inputmode="numeric">
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="logradouro" class="text-sm font-bold">Rua:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="m9.69 18.933.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 0 0 .281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 1 0 3 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 0 0 2.273 1.765 11.842 11.842 0 0 0 .976.544l.062.029.018.008.006.003ZM10 11.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="logradouro" name="logradouro" required>
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="complemento" class="text-sm font-bold">Complemento:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="complemento" name="complemento">
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="bairro" class="text-sm font-bold">Bairro:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M8.157 2.176a1.5 1.5 0 0 0-1.147 0l-4.084 1.69A1.5 1.5 0 0 0 2 5.25v10.877a1.5 1.5 0 0 0 2.074 1.386l3.51-1.452 4.26 1.762a1.5 1.5 0 0 0 1.146 0l4.083-1.69A1.5 1.5 0 0 0 18 14.75V3.872a1.5 1.5 0 0 0-2.073-1.386l-3.51 1.452-4.26-1.762ZM7.58 5a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1-1.5 0v-6.5A.75.75 0 0 1 7.58 5Zm5.59 2.75a.75.75 0 0 0-1.5 0v6.5a.75.75 0 0 0 1.5 0v-6.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="bairro" name="bairro" required>
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="cidade_uf" class="text-sm font-bold">Cidade/UF:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M1 2.75A.75.75 0 0 1 1.75 2h10.5a.75.75 0 0 1 0 1.5H12v13.75a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1-.75-.75v-2.5a.75.75 0 0 0-.75-.75h-2.5a.75.75 0 0 0-.75.75v2.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5H2v-13h-.25A.75.75 0 0 1 1 2.75ZM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM4.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM8 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM8.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM14.25 6a.75.75 0 0 0-.75.75V17a1 1 0 0 0 1 1h3.75a.75.75 0 0 0 0-1.5H18v-9h.25a.75.75 0 0 0 0-1.5h-4Zm.5 3.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm.5 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="cidade_uf" name="cidade_uf" required>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="telefone" class="text-sm font-bold">Telefone:</label>
                <div class="relative w-full">
                    <!-- Ícone do Telefone (como no original) -->
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 0 0 6.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 0 1 1.767-1.052l3.223.716A1.5 1.5 0 0 1 18 15.352V16.5a1.5 1.5 0 0 1-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 0 1 2.43 8.326 13.019 13.019 0 0 1 2 5V3.5Z" clip-rule="evenodd" /></svg>
                    </div>

                    <!-- O campo de Telefone (como no original, mas com padding à direita) -->
                    <input class="h-10 w-full ps-10 pe-12 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="tel" id="telefone" name="telefone" placeholder="(99) 99999-9999" maxlength="15">
                    
                    <!-- NOVO: O botão "+" discreto, posicionado dentro do campo -->
                    <button type="button" id="btnAdicionarContato" class="absolute inset-y-0 end-0 flex items-center justify-center h-10 w-10 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg border-l border-zinc-300">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                          <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Container onde as linhas extras de contato serão inseridas pelo JavaScript -->
            <div id="lista-contatos-visivel" class="w-full flex flex-wrap gap-2 mt-1"> </div>

            <!-- Input oculto para os contatos extras -->
            <input type="hidden" name="contatos" id="hiddenContatos">


            <div class="flex items-center justify-start -mt-3">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleSalvarCliente" name="salvar_cliente" class="sr-only peer">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900">Salvar cliente?</span>
                </label>
            </div>
            
            <!-- DETALHES DO ORÇAMENTO -->
            <h1 class="text-3xl sm:text-3xl md:text-4xl font-extrabold text-center mb-1 bg-gradient-to-tr from-green-600 to-green-400 bg-clip-text text-transparent drop-shadow">
            Detalhamento
            </h1>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="descricaoServico" class="text-sm font-bold">Descrição do serviço:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" /></svg></div>
                    <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="descricaoServico" name="descricao_servico" placeholder="Descreva o serviço a ser executado" required>
                </div>
            </div>
            
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="selectServico" class="text-sm font-bold">Serviço do Catálogo:</label>
                <div id="containerServico" class="relative w-full">
                    <!-- O JavaScript vai preencher este espaço -->
                </div>
            </div>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="selectMaterial" class="text-sm font-bold">Material do Catálogo:</label>
                <div id="containerMaterial" class="relative w-full">
                    <!-- O JavaScript vai preencher este espaço -->
                </div>
            </div>

            <div class="flex flex-col items-start justify-start gap-2">
                <label for="item" class="text-sm font-bold">Item:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" /></svg></div>
                    <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="item" name="item">
                </div>
            </div>
            <div class="flex flex-wrap items-start justify-start gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="itemQtd">Qtd:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M10 1c-1.716 0-3.408.106-5.07.31C3.806 1.45 3 2.414 3 3.517V16.75A2.25 2.25 0 0 0 5.25 19h9.5A2.25 2.25 0 0 0 17 16.75V3.517c0-1.103-.806-2.068-1.93-2.207A41.403 41.403 0 0 0 10 1ZM5.99 8.75A.75.75 0 0 1 6.74 8h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm1.417-5.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm1.42-5.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01ZM12.5 8.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm0 2.166a.75.75 0 0 1 .75.75v2.167a.75.75 0 1 1-1.5 0v-2.167a.75.75 0 0 1 .75-.75ZM6.75 4a.75.75 0 0 0-.75.75v.5c0 .414.336.75.75.75h6.5a.75.75 0 0 0 .75-.75v-.5a.75.75 0 0 0-.75-.75h-6.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="number" id="itemQtd" value="1" inputmode="numeric" pattern="[0-9]*">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="itemValor">Valor(unit):</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="M10.75 10.818v2.614A3.13 3.13 0 0 0 11.888 13c.482-.315.612-.648.612-.875 0-.227-.13-.56-.612-.875a3.13 3.13 0 0 0-1.138-.432ZM8.33 8.62c.053.055.115.11.184.164.208.16.46.284.736.363V6.603a2.45 2.45 0 0 0-.35.13c-.14.065-.27.143-.386.233-.377.292-.514.627-.514.909 0 .184.058.39.202.592.037.051.08.102.128.152Z" /><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-6a.75.75 0 0 1 .75.75v.316a3.78 3.78 0 0 1 1.653.713c.426.33.744.74.925 1.2a.75.75 0 0 1-1.395.55 1.35 1.35 0 0 0-.447-.563 2.187 2.187 0 0 0-.736-.363V9.3c.698.093 1.383.32 1.959.696.787.514 1.29 1.27 1.29 2.13 0 .86-.504 1.616-1.29 2.13-.576.377-1.261.603-1.96.696v.299a.75.75 0 1 1-1.5 0v-.3c-.697-.092-1.382-.318-1.958-.695-.482-.315-.857-.717-1.078-1.188a.75.75 0 1 1 1.359-.636c.08.173.245.376.54.569.313.205.706.353 1.138.432v-2.748a3.782 3.782 0 0 1-1.653-.713C6.9 9.433 6.5 8.681 6.5 7.875c0-.805.4-1.558 1.097-2.096a3.78 3.78 0 0 1 1.653-.713V4.75A.75.75 0 0 1 10 4Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="itemValor" name="itemValor" inputmode="decimal">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="tipoItem">Tipo:</label>
                    <div class="relative w-full">
                        <div id="tipoItemIcon" class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"></div>
                        <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none tipoItemSeta">                           
                        </div>
                        <select class="h-10 w-full ps-9 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400 appearance-none" id="tipoItem" name="tipoItem">
                            <option value="default">Seleção</option>
                            <option value="servico">Serviço</option>
                            <option value="material">Material</option>
                        </select>
                    </div>
                </div>
            </div>
                <div class="flex items-center justify-start gap-6 mb-4">
            
                        <!-- Esquerda: Toggle para Salvar no Catálogo -->
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleSalvar" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-900">Salvar item?</span>
                        </label>

                        <!-- Direita: Campo do Número do Orçamento -->
                        <div class="flex items-center gap-2">
                            <label for="numero_orcamento" class="text-sm font-medium text-gray-700">Nº:</label>
                            <input type="text" id="numero_orcamento" name="numero_orcamento" 
                                class="w-20 h-6 text-center font-semibold border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400" value="">
                        </div>
                        <div class="relative">
                            <button
                                type="button"
                                id="btn-abrir-modal-info"
                                title="Adicionar Informações Complementares"
                                class="flex items-center justify-center h-10 w-10 rounded-full bg-white shadow-md border border-emerald-200 text-emerald-600 hover:bg-emerald-50 hover:scale-105 active:scale-95 active:shadow-sm transition-all duration-150 group"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-6 group-hover:scale-110 transition-transform duration-200">
                                    <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                    <path fill-rule="evenodd" d="M10 14a1 1 0 0 1-1-1V9a1 1 0 1 1 2 0v4a1 1 0 0 1-1 1zm0-6a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <span id="info-btn-alert-icon" class="hidden absolute -top-1 -right-1 flex h-4 w-4">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-4 w-4 bg-amber-500 border-2 border-white"></span>
                            </span>
                        </div>
                    </div>
            
            <div class="flex flex-col gap-2">
                <button id="adicionarItemBtn" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold uppercase tracking-wide rounded-2xl shadow-lg transform hover:-translate-y-0.5 transition-all duration-200" type="button">Adicionar Item</button>
                <button id="gerarOrcamentoBtn" class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold uppercase tracking-wide rounded-xl shadow-md transform hover:-translate-y-0.5 transition-all duration-200" type="submit">Atualizar Orçamento</button>
            </div>
            
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden" id="tableContainer">
                <table class="w-full text-sm text-left rtl:text-right">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3">Item / Tipo</th>
                            <th scope="col" class="px-4 py-3 text-center">Qtd</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Unit</th>
                            <th scope="col" class="px-4 py-3 text-right">Total</th>
                            <th scope="col" class="px-4 py-3 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="itensContainer">
                    </tbody>
                </table>
            </div>
        <input type="hidden" name="itens" id="hiddenItens" />
        <input type="hidden" name="condicao_pagamento" id="hidden_condicao_pagamento" />
        <input type="hidden" name="prazo_entrega" id="hidden_prazo_entrega" />
        <input type="hidden" name="garantia" id="hidden_garantia" />
        <input type="hidden" name="observacoes" id="hidden_observacoes" />    
        </form>
    </div>

    <!-- O Modal de Clientes (começa escondido) -->
            <div id="modalClientes" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
            <div id="modalClientesBox" class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
                <div class="flex items-center justify-between p-4 border-b">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 bg-gray-100 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-600">
                                <path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.25 1.25 0 0 1 2.228-1.567l.11-.128a5 5 0 0 1 7.4-2.228l.11.128a1.25 1.25 0 0 1 2.228 1.567l-.11.128a3.5 3.5 0 0 1-5.18 1.567l-.255.255a.75.75 0 0 1-1.06 0l-.255-.255a3.5 3.5 0 0 1-5.18-1.567l-.11-.128Z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Selecione um Cliente</h3>
                    </div>
                    <button id="btnFecharModalClientes" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
                </div>
                <div class="p-1">
                    <input type="text" id="filtroCliente" class="w-full h-10 px-3 my-2 border border-zinc-200 rounded-md" placeholder="Buscar por nome...">
                </div>
                <div id="listaClientesModal" class="p-2 max-h-80 overflow-y-auto">
                    <!-- A lista de clientes será inserida aqui pelo JavaScript -->
                </div>
            </div>
        </div>
        <div id="modal-info" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-info-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Informações Adicionais do Orçamento</h3>
                <button id="btn-fechar-modal-info" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            <div class="mt-4 space-y-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Condição de Pagamento:</label>
                    <div class="mt-1 flex items-center gap-2">
                        <!-- Campo para exibir o resultado -->
                        <div id="display-condicao-pagamento" class="flex-grow h-10 px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600 truncate">
                            A definir...
                        </div>
                        <!-- ÍCONE DE AVISO (COMEÇA ESCONDIDO) -->
                        <span id="pagamento-aviso-icon" class="hidden text-amber-500" title="O total do orçamento mudou! Por favor, revise as condições de pagamento.">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-6 animate-pulse">
                                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd" />
                            </svg>
                        </span>
                        <!-- Botão que abrirá o novo modal -->
                        <button type="button" id="btn-abrir-modal-pagamento" class="flex-shrink-0 h-10 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition-colors">
                            Definir
                        </button>
                    </div>
                </div>

                <div>
                    <label for="info-prazo-entrega" class="block text-sm font-medium text-gray-700">Prazo de Entrega/Execução:</label>
                    <input type="text" id="info-prazo-entrega" placeholder="Ex: 7 dias úteis após aprovação" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="info-garantia" class="block text-sm font-medium text-gray-700">Garantia:</label>
                    <input type="text" id="info-garantia" placeholder="Ex: 90 dias para o serviço prestado" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="info-observacoes" class="block text-sm font-medium text-gray-700">Observações Adicionais:</label>
                    <textarea id="info-observacoes" rows="3" placeholder="Informações extras, detalhes específicos, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

            </div>
            <div class="mt-6 text-right">
                <button id="btn-salvar-info" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
      <div id="modal-contato" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-contato-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Adicionar Novo Contato</h3>
                <button id="btn-fechar-modal-contato" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            <div class="mt-4 space-y-4">
                
                <div>
                    <label for="modal-contato-nome" class="block text-sm font-medium text-gray-700">Nome do Contato:</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.25 1.25 0 0 1 2.228-1.567l.11-.128a5 5 0 0 1 7.4-2.228l.11.128a1.25 1.25 0 0 1 2.228 1.567l-.11.128a3.5 3.5 0 0 1-5.18 1.567l-.255.255a.75.75 0 0 1-1.06 0l-.255-.255a3.5 3.5 0 0 1-5.18-1.567l-.11-.128Z" /></svg>
                        </div>
                        <input type="text" id="modal-contato-nome" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400">
                    </div>
                </div>

                <div>
                    <label for="modal-contato-telefone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 0 0 6.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 0 1 1.767-1.052l3.223.716A1.5 1.5 0 0 1 18 15.352V16.5a1.5 1.5 0 0 1-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 0 1 2.43 8.326 13.019 13.019 0 0 1 2 5V3.5Z" clip-rule="evenodd" /></svg>
                        </div>
                        <input type="tel" id="modal-contato-telefone" placeholder="(99) 99999-9999" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" maxlength="15" oninput="mascara(event, '(##) #####-####')">
                    </div>
                </div>
                <div>
                <label for="modal-contato-email" class="block text-sm font-medium text-gray-700">E-mail (Opcional):</label>
                <div class="relative mt-1">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400">
                           <path d="M3 4a2 2 0 0 0-2 2v1.161l8.441 4.221a1.25 1.25 0 0 0 1.118 0L19 7.162V6a2 2 0 0 0-2-2H3Z" />
                           <path d="M19 8.839l-7.77 3.885a2.75 2.75 0 0 1-2.46 0L1 8.839V14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.839Z" />
                       </svg>
                    </div>
                    <input type="email" id="modal-contato-email" placeholder="email@exemplo.com" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400">
                </div>
            </div>

            </div>
            <div class="mt-6 text-right">
                <button id="btn-salvar-contato-modal" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Adicionar
                </button>
            </div>
        </div>
    </div>
        <div id="modal-catalogo" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] transition-opacity duration-300">
        <div id="modal-catalogo-box" class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh] transform transition-all -translate-y-10 opacity-0 duration-300">
            <!-- Cabeçalho do Modal -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 id="modal-catalogo-titulo" class="text-xl font-semibold text-gray-800">Buscar no Catálogo</h3>
                <button id="btn-fechar-modal-catalogo" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            
            <!-- Campo de Busca -->
            <div class="p-4 border-b">
                <input type="text" id="filtro-catalogo-input" class="w-full h-10 px-3 border border-zinc-300 rounded-md shadow-sm" placeholder="Digite para buscar...">
            </div>
            
            <!-- Lista de Itens (com rolagem) -->
            <div id="lista-catalogo-modal" class="p-2 overflow-y-auto">
                <!-- A lista de itens do catálogo será inserida aqui pelo JavaScript -->
            </div>
        </div>
    </div>
        <div id="modal-tipo-documento" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60]">
        <div id="modal-tipo-documento-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <!-- Título -->
            <h3 class="text-lg font-medium text-gray-900 text-center">Qual documento deseja enviar?</h3>
            
            <!-- Conteúdo/Opções -->
            <div class="mt-4 space-y-3">
                <p class="text-sm text-center text-gray-500">
                    Selecione o tipo de documento que será gerado para o compartilhamento.
                </p>
                <div class="pt-2">
                    <label class="flex items-center p-3 w-full bg-white border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="tipo_documento_escolha" value="Orçamento" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-sm font-medium text-gray-800">Enviar como Orçamento</span>
                    </label>
                </div>
                <div>
                    <label class="flex items-center p-3 w-full bg-white border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="tipo_documento_escolha" value="Nota de Serviço" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-sm font-medium text-gray-800">Enviar como Nota de Serviço</span>
                    </label>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" class="btn-fechar-modal-tipo-documento px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button type="button" id="btn-confirmar-tipo-documento" class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-md hover:bg-emerald-700">Confirmar e Continuar</button>
            </div>
        </div>
    </div>

    <div id="modal-pagamento" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] transition-opacity duration-300">
    <div id="modal-pagamento-box" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh] transform transition-all -translate-y-10 opacity-0 duration-300">
        
        <div class="flex items-center justify-between p-4 border-b sticky top-0 bg-white">
            <h3 class="text-xl font-semibold text-gray-800">Definir Condições de Pagamento</h3>
            <button id="btn-fechar-modal-pagamento" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
        </div>

        <!-- Corpo do Modal -->
        <div class="p-6 space-y-5 overflow-y-auto">

            <!-- Indicadores de Valor (sem mudanças na estrutura) -->
            <div class="bg-gray-50 p-4 rounded-lg border sticky top-0">
                <!-- ... (o conteúdo dos indicadores de valor continua o mesmo) ... -->
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-gray-600">Total com Desconto:</span>
                    <span id="pagamento-valor-total" class="font-bold text-emerald-600 text-xl">R$ 0,00</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-3">
                    <span class="font-medium text-amber-600">Desconto aplicado:</span>
                    <span id="pagamento-valor-desconto" class="font-bold text-amber-700">- R$ 0,00</span>
                </div>
                <div class="flex justify-between items-center text-lg mb-2">
                    <span class="font-medium text-gray-600">Restante a alocar (nesta opção):</span>
                    <span id="pagamento-valor-restante" class="font-bold text-blue-600">R$ 0,00</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="pagamento-progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
                <!-- Formulário para Adicionar Parcelas -->
                <div class="space-y-4 pt-2">
                    <!-- Linha 1: Descrição da Parcela -->
                    <div>
                        <label for="pagamento-descricao-select" class="block text-sm font-medium text-gray-700">Descrição</label>
                        <select id="pagamento-descricao-select" class="mt-1 block w-full h-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">-- Selecione --</option>
                            <option value="Entrada">Entrada</option>
                            <option value="Sinal">Sinal</option>
                            <option value="À vista">À vista</option>
                            <option value="Pix">Pix</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="outro">Outro (especificar)</option>
                        </select>
                        <input type="text" id="pagamento-descricao-input-outro" placeholder="Especifique a descrição" class="hidden mt-2 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <div class="flex items-end gap-2">
                        <!-- Tipo (R$ / %) -->
                        <div class="flex-none">
                            <label for="pagamento-tipo-valor-input" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="pagamento-tipo-valor-input" class="mt-1 block w-full h-10 px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="percent">%</option>
                                <option value="valor">R$</option>
                            </select>
                        </div>
                        <!-- Valor -->
                        <div class="flex-grow">
                            <label for="pagamento-valor-input" class="block text-sm font-medium text-gray-700">Valor</label>
                            <input type="text" id="pagamento-valor-input" inputmode="decimal" placeholder="Ex: 50" class="mt-1 block w-full h-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <!-- Desconto na Parcela (%) -->
                        <div class="flex-none">
                            <label for="pagamento-desconto-parcela" class="block text-sm font-medium text-gray-700">Desc. (%)</label>
                            <input type="text" id="pagamento-desconto-parcela" inputmode="decimal" placeholder="0" class="mt-1 block w-20 h-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                        </div>
                    </div>
                    
                    <!-- Linha 4: Botão de Adicionar -->
                        <button id="btn-add-parcela" class="w-full h-11 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                            <span>Adicionar Parcela a esta Opção</span>
                        </button>
                    </div>
                                
                <div id="grupo-atual-container" class="border-t pt-4 mt-4 hidden">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Opção em construção:</h4>
                    <div id="lista-parcelas-grupo-atual" class="space-y-2 p-2 bg-blue-50/50 rounded-lg border-l-4 border-blue-400">
                        <!-- As parcelas do grupo atual aparecerão aqui -->
                    </div>
                    <button id="btn-salvar-grupo" type="button" class="w-full mt-3 h-11 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                        <span>Finalizar e Adicionar Opção</span>
                    </button>
                </div>

                <!-- **** NOVA SEÇÃO: OPÇÕES JÁ SALVAS **** -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Opções de Pagamento Salvas:</h4>
                    <div id="grupos-salvos-container" class="space-y-2">
                        <p id="grupos-placeholder" class="text-center text-gray-400 py-4">Nenhuma opção de pagamento definida.</p>
                    </div>
                </div>

            </div>

            <!-- Rodapé -->
            <div class="flex items-center justify-end p-4 bg-gray-50 border-t sticky bottom-0">
                <button id="btn-salvar-pagamento" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Confirmar Todas as Condições
                </button>
            </div>
        </div>
    </div>
    <div id="modal-aviso" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[100] transition-opacity duration-300">
        <div id="modal-aviso-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            
            <div id="aviso-header" class="text-center mb-4">
                <!-- Conteúdo dinâmico aqui (ícone e título) -->
            </div>

            <div id="aviso-mensagem" class="text-center text-gray-600 mb-6">
                <!-- Mensagem dinâmica da API aqui -->
            </div>

            <div class="mt-5 sm:mt-6">
                <button id="btn-fechar-modal-aviso" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">
                    Entendi
                </button>
            </div>
        </div>
    </div>

<script>

const orcamentoData = JSON.parse(document.getElementById('orcamento-json').textContent);
const modalAviso = document.getElementById('modal-aviso');
const modalAvisoBox = document.getElementById('modal-aviso-box');
const avisoHeader = document.getElementById('aviso-header');
const avisoMensagem = document.getElementById('aviso-mensagem');
const btnFecharModalAviso = document.getElementById('btn-fechar-modal-aviso');

function exibirAviso(status, mensagem) {
    if (status === 'warning') {
        avisoHeader.innerHTML = `
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                <svg class="h-6 w-6 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
            </div>
            <h3 class="mt-4 text-lg font-semibold text-gray-900">Atenção!</h3>`;
    } else if (status === 'blocked') {
        avisoHeader.innerHTML = `
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
            </div>
            <h3 class="mt-4 text-lg font-semibold text-gray-900">Acesso Bloqueado</h3>`;
    }
    
    avisoMensagem.textContent = mensagem;
    
    modalAviso.classList.remove('hidden');
    setTimeout(() => { modalAvisoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
}

function fecharAviso() {
    modalAvisoBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => { modalAviso.classList.add('hidden'); }, 300);
}

document.addEventListener("DOMContentLoaded", function() {
    
    // --- 1. VARIÁVEIS GLOBAIS E DE DOM ---
    const API_BASE_URL = window.location.origin;
    let itens = orcamentoData.itens || [];
    let contatosExtras = []; 
    let servicosCatalogo = [];
    let materiaisCatalogo = [];
    let idItemEmEdicao = null;

    const form = document.getElementById("orcamentoForm");
    const tableContainer = document.getElementById("tableContainer");
    const itensContainer = document.getElementById("itensContainer");
    const itemInput = document.getElementById("item");
    const itemQtdInput = document.getElementById("itemQtd");
    const itemValorInput = document.getElementById("itemValor");
    const adicionarItemBtn = document.getElementById("adicionarItemBtn");
    const tipoItemSelect = document.getElementById("tipoItem");
    const telefoneInput = document.getElementById("telefone");
    const listaContatosVisivel = document.getElementById('lista-contatos-visivel');
    const btnAdicionarContato = document.getElementById("btnAdicionarContato");
    const modalContato = document.getElementById('modal-contato');
    const modalContatoBox = document.getElementById('modal-contato-box');
    const btnFecharModalContato = document.getElementById('btn-fechar-modal-contato');
    const btnSalvarContatoModal = document.getElementById('btn-salvar-contato-modal');
    const modalInfo = document.getElementById('modal-info');
    const modalInfoBox = document.getElementById('modal-info-box');
    const btnAbrirModalInfo = document.getElementById('btn-abrir-modal-info');
    const btnFecharModalInfo = document.getElementById('btn-fechar-modal-info');
    const btnSalvarInfo = document.getElementById('btn-salvar-info');
    const tipoItemIconDiv = document.getElementById("tipoItemIcon");

    const modalCatalogo = document.getElementById('modal-catalogo');
    const modalCatalogoBox = document.getElementById('modal-catalogo-box');
    const modalCatalogoTitulo = document.getElementById('modal-catalogo-titulo');
    const btnFecharModalCatalogo = document.getElementById('btn-fechar-modal-catalogo');
    const filtroCatalogoInput = document.getElementById('filtro-catalogo-input');
    const listaCatalogoModal = document.getElementById('lista-catalogo-modal');

    // ELEMENTOS DO MODAL DE PAGAMENTO
    const modalPagamento = document.getElementById('modal-pagamento');
    const modalPagamentoBox = document.getElementById('modal-pagamento-box');
    const btnAbrirModalPagamento = document.getElementById('btn-abrir-modal-pagamento');
    const btnFecharModalPagamento = document.getElementById('btn-fechar-modal-pagamento');
    const btnSalvarPagamento = document.getElementById('btn-salvar-pagamento');
    const pagamentoValorTotalEl = document.getElementById('pagamento-valor-total');
    const pagamentoValorDescontoEl = document.getElementById('pagamento-valor-desconto');
    const pagamentoValorRestanteEl = document.getElementById('pagamento-valor-restante');
    const pagamentoProgressBar = document.getElementById('pagamento-progress-bar');
    const pagamentoDescricaoSelect = document.getElementById('pagamento-descricao-select');
    const pagamentoDescricaoInputOutro = document.getElementById('pagamento-descricao-input-outro');
    const pagamentoTipoValorInput = document.getElementById('pagamento-tipo-valor-input');
    const pagamentoValorInput = document.getElementById('pagamento-valor-input');
    const pagamentoDescontoParcelaInput = document.getElementById('pagamento-desconto-parcela');
    const btnAddParcela = document.getElementById('btn-add-parcela');
    const displayCondicaoPagamento = document.getElementById('display-condicao-pagamento');
    const grupoAtualContainer = document.getElementById('grupo-atual-container');
    const listaParcelasGrupoAtual = document.getElementById('lista-parcelas-grupo-atual');
    const btnSalvarGrupo = document.getElementById('btn-salvar-grupo');
    const gruposSalvosContainer = document.getElementById('grupos-salvos-container');
    const gruposPlaceholder = document.getElementById('grupos-placeholder');
    

    let gruposDePagamento = []; // Lista principal que conterá os grupos
    let grupoAtual = [];         // Lista temporária para o grupo que está sendo montado no modal
    let idGrupoEmEdicao = null;  // Para saber se estamos editando um grupo existente
    let valorOrcamentoBruto = 0;
    let descontoTotalEmValor = 0;
    let initialTotal = 0;

    const icons = {
        servico: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M14.5 10a4.5 4.5 0 004.284-5.882c-.105-.324-.51-.391-.752-.15L15.34 6.66a.454.454 0 01-.493.11 3.01 3.01 0 01-1.618-1.616.455.455 0 01.11-.494l2.694-2.692c.24-.241.174-.647-.15-.752a4.5 4.5 0 00-5.873 4.575c.055.873-.128 1.808-.8 2.368l-7.23 6.024a2.724 2.724 0 103.837 3.837l6.024-7.23c.56-.672 1.495-.855 2.368-.8.096.007.193.01.291.01ZM5 16a1 1 0 10-2 0 1 1 0 002 0Z" clip-rule="evenodd" /><path d="M14.5 11.5c.173 0 .345-.007.514-.022l3.754 3.754a2.5 2.5 0 01-3.536 3.536l-4.41-4.41 2.172-2.607c.052-.063.147-.138.342-.196.202-.06.469-.087.777-.067.128.008.257.012.387.012ZM6 4.586l2.33 2.33a.452.452 0 01-.08.09L6.8 8.214 4.586 6H3.309a.5.5 0 01-.447-.276l-1.7-3.402a.5.5 0 01.093-.577l.49-.49a.5.5 0 01.577-.094l3.402 1.7A.5.5 0 016 3.31v1.277Z" /></svg>`,
        material: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" /></svg>`,
        default: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>`
    };
    const updateTipoItemIcon = () => tipoItemIconDiv.innerHTML = icons[tipoItemSelect.value] || icons.default;
    window.mascara = (e,p) => { let i=0, v=e.target.value.replace(/\D/g,""); e.target.value = p.replace(/#/g, ()=> v[i++]||""); };

    function formatarMoeda(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (!value) { e.target.value = ""; return; }
        const numericValue = parseFloat(value) / 100;
        e.target.value = numericValue.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
    }
    
    function formatarMoedaLocal(valor) {
        // Verifica se o valor é numérico antes de formatar para evitar erros
        if (typeof valor !== 'number') {
            return 'R$ 0,00';
        }
        return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }
    
    function abrirModalCatalogo(tipo) {
        modalCatalogoTitulo.textContent = `Buscar em ${tipo === 'servico' ? 'Serviços' : 'Materiais'}`;
        modalCatalogo.dataset.tipoAtual = tipo;
        popularListaModalCatalogo(tipo, '');
        modalCatalogo.classList.remove('hidden');
        modalCatalogo.classList.add('flex');
        setTimeout(() => { 
            modalCatalogoBox.classList.remove('-translate-y-10', 'opacity-0');
            filtroCatalogoInput.focus();
        }, 50);
    }

    function fecharModalCatalogo() {
        modalCatalogoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { 
            modalCatalogo.classList.add('hidden'); 
            modalCatalogo.classList.remove('flex');
            filtroCatalogoInput.value = '';
        }, 300);
    }

    function verificarEAtualizarAvisoPagamento() {
        const newTotal = calcularValorTotalOrcamento();
        const avisoIconModal = document.getElementById('pagamento-aviso-icon');      // Ícone dentro do modal
        const avisoIconBtn = document.getElementById('info-btn-alert-icon');          // Ícone NOVO sobre o botão (i)
        const btnPagamentoModal = document.getElementById('btn-abrir-modal-pagamento'); // Botão dentro do modal
        const btnInfoMain = document.getElementById('btn-abrir-modal-info');          // Botão (i) na tela principal

        if (Math.abs(newTotal - initialTotal) > 0.01) {
            // Mostra os alertas visuais
            avisoIconModal.classList.remove('hidden');
            avisoIconBtn.classList.remove('hidden');

            // Modifica o botão DENTRO do modal
            btnPagamentoModal.textContent = 'Revisar';
            btnPagamentoModal.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
            btnPagamentoModal.classList.add('bg-amber-500', 'hover:bg-amber-600');
            
            // Adiciona um anel de destaque no botão principal (i)
            btnInfoMain.classList.add('ring-2', 'ring-amber-400', 'ring-offset-2');

        } else {
            // Esconde os alertas visuais
            avisoIconModal.classList.add('hidden');
            avisoIconBtn.classList.add('hidden');

            // Restaura o botão DENTRO do modal
            btnPagamentoModal.textContent = document.getElementById('hidden_condicao_pagamento').value.length > 2 ? 'Editar' : 'Definir';
            btnPagamentoModal.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            btnPagamentoModal.classList.add('bg-emerald-600', 'hover:bg-emerald-700');

            // Remove o anel de destaque do botão principal (i)
            btnInfoMain.classList.remove('ring-2', 'ring-amber-400', 'ring-offset-2');
        }
    }

    function popularListaModalCatalogo(tipo, filtro) {
        const catalogo = tipo === 'servico' ? servicosCatalogo : materiaisCatalogo;
        const termoBusca = filtro.toLowerCase();
        
        const itensFiltrados = catalogo.filter(item => item.nome.toLowerCase().includes(termoBusca));
        
        listaCatalogoModal.innerHTML = '';
        
        if (itensFiltrados.length === 0) {
            listaCatalogoModal.innerHTML = '<p class="p-4 text-center text-gray-400">Nenhum item encontrado.</p>';
            return;
        }
        
        itensFiltrados.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'p-3 flex justify-between items-center rounded-lg hover:bg-emerald-50 cursor-pointer border-b last:border-b-0';
            
            // ** AQUI ESTÁ A MUDANÇA: ADICIONAMOS O BOTÃO DA LIXEIRA **
            itemDiv.innerHTML = `
                <div class="flex flex-col flex-grow cursor-pointer">
                    <span class="font-semibold text-gray-800">${item.nome}</span>
                    <span class="text-sm text-gray-500">${item.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</span>
                </div>
                <button type="button" class="btn-excluir-item-catalogo p-2 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600">
                    <svg class="size-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM6.05 6a.75.75 0 0 1 .787.71l.5 5a.75.75 0 1 1-1.474.14l-.5-5A.75.75 0 0 1 6.05 6Zm3.9 0a.75.75 0 0 1 .71.787l-.5 5a.75.75 0 1 1-1.474-.14l.5-5a.75.75 0 0 1 .764-.647Z" clip-rule="evenodd" /></svg>
                </button>
            `;
            
            // Registra o evento de clique que SELECIONA o item
            itemDiv.querySelector(".flex-grow").addEventListener('click', () => selecionarItemDoModal(item.id, tipo));

            // Registra o evento de clique que EXCLUI o item
            itemDiv.querySelector(".btn-excluir-item-catalogo").addEventListener('click', (e) => {
                e.stopPropagation(); // Impede que o clique na lixeira também selecione o item
                confirmarExclusao(item.id, item.nome);
            });
            
            listaCatalogoModal.appendChild(itemDiv);
        });
    }

    function selecionarItemDoModal(itemId, tipo) {
        const selectId = tipo === 'servico' ? 'containerServico' : 'containerMaterial';
        const select = document.querySelector(`#${selectId} select`);
        select.value = itemId;
        select.dispatchEvent(new Event('change'));
        fecharModalCatalogo();
    }

    async function confirmarExclusao(itemId, itemName) {
        if (!confirm(`Tem certeza que deseja excluir "${itemName}" do catálogo?`)) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/item/${itemId}`, { method: 'DELETE' });

            if (response.status !== 204) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || "Falha ao excluir o item.");
            }
            
            // Se o item que estava selecionado para ser adicionado ao orçamento foi o excluído, limpa os campos
            if(itemInput.value === itemName) {
                itemInput.value = "";
                itemValorInput.value = "";
                tipoItemSelect.value = "default";
                updateTipoItemIcon();
            }
            
            // Recarrega os catálogos da API para garantir que a lista de dados está atualizada
            await carregarCatalogosAPI(); 
            
            // Redesenha a lista DENTRO DO MODAL já com o item removido
            const tipoAtual = modalCatalogo.dataset.tipoAtual;
            const filtroAtual = filtroCatalogoInput.value;
            popularListaModalCatalogo(tipoAtual, filtroAtual);
            
        } catch (error) {
            console.error("Erro ao excluir item:", error);
            alert(`Ocorreu um erro: ${error.message}`);
        }
    }
    // --- LÓGICA PRINCIPAL ---

    function abrirModalContato() { 
        document.getElementById('modal-contato-nome').value=''; 
        document.getElementById('modal-contato-telefone').value=''; 
        document.getElementById('modal-contato-email').value = ''; 
        modalContato.classList.remove('hidden'); 
        modalContato.classList.add('flex'); 
        setTimeout(()=>modalContatoBox.classList.remove('-translate-y-10','opacity-0'),50); 
    }

    function fecharModalContato() { 
        modalContatoBox.classList.add('-translate-y-10','opacity-0'); 
        setTimeout(()=>{ modalContato.classList.add('hidden'); modalContato.classList.remove('flex');},300); 
    }

    function salvarContatoDoModal() {
        const nome = document.getElementById('modal-contato-nome').value.trim();
        const telefone = document.getElementById('modal-contato-telefone').value.trim();
        const email = document.getElementById('modal-contato-email').value.trim(); 

        if (!nome || !telefone) {
            alert("Por favor, preencha o nome e o telefone do contato.");
            return;
        }
        const novoTelefoneNormalizado = telefone.replace(/\D/g, '');
        const telefonePrincipalNormalizado = telefoneInput.value.replace(/\D/g, '');
        const contatoExistente = contatosExtras.find(c => c.telefone.replace(/\D/g, '') === novoTelefoneNormalizado);

        if (contatoExistente) {
            const querAtualizar = confirm(`Este telefone já pertence ao contato "${contatoExistente.nome}".\nDeseja atualizar as informações dele?`);
            if (querAtualizar) {
                contatoExistente.nome = nome;
                contatoExistente.email = email;
            } else {
                return;
            }
        } else if (novoTelefoneNormalizado === telefonePrincipalNormalizado && telefonePrincipalNormalizado !== '') {
            alert("Este telefone já está definido como o contato principal.");
            return;
        } else {
            contatosExtras.push({ nome: nome, telefone: telefone, email: email });
        }
        renderizarTagsDeContato();
        fecharModalContato();
    }

    function abrirModalInfo() {
        // Puxa os valores dos inputs ocultos para preencher os campos do modal
        document.getElementById('info-prazo-entrega').value = document.getElementById('hidden_prazo_entrega').value;
        document.getElementById('info-garantia').value = document.getElementById('hidden_garantia').value;
        document.getElementById('info-observacoes').value = document.getElementById('hidden_observacoes').value;
        
        modalInfo.classList.remove('hidden');
        modalInfo.classList.add('flex');
        setTimeout(() => { modalInfoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
    }

    function fecharModalInfo() {
        modalInfoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalInfo.classList.add('hidden'); modalInfo.classList.remove('flex'); }, 300);
    }
    
    function salvarInfoModal() {
        // Salva os valores dos campos nos inputs ocultos correspondentes do formulário
        document.getElementById('hidden_prazo_entrega').value = document.getElementById('info-prazo-entrega').value;
        document.getElementById('hidden_garantia').value = document.getElementById('info-garantia').value;
        document.getElementById('hidden_observacoes').value = document.getElementById('info-observacoes').value;
        
        // Dá um feedback visual no botão que abre o modal
        const btnAbrir = document.getElementById('btn-abrir-modal-info');
        btnAbrir.classList.add('border-emerald-500', 'ring-2', 'ring-emerald-200');

        fecharModalInfo();
    }
    
    function calcularValorTotalOrcamento() {
        return itens.reduce((total, item) => total + (item.quantidade * item.valor), 0);
    }


    function abrirModalPagamento() {
        valorOrcamentoBruto = calcularValorTotalOrcamento();
        if (valorOrcamentoBruto <= 0) {
            alert("Adicione itens ao orçamento primeiro para definir as condições de pagamento.");
            return;
        }

        // Sempre começamos sem um grupo em edição
        grupoAtual = [];
        idGrupoEmEdicao = null;

        // NOVO: carrega do hidden o que veio do banco (JSON ou string)
        const raw = document.getElementById('hidden_condicao_pagamento').value || '[]';
        let parsed = [];
        try { parsed = JSON.parse(raw); } catch (e) { parsed = []; }

        // Aceita tanto [[...],[...]] quanto [{...},{...}]
        if (Array.isArray(parsed) && parsed.length > 0) {
            if (Array.isArray(parsed[0])) {
            gruposDePagamento = parsed;
            } else if (typeof parsed[0] === 'object') {
            gruposDePagamento = [parsed];
            } else {
            gruposDePagamento = [];
            }

            // Normaliza objetos e garante ID numérico pra remover/editar
            gruposDePagamento = gruposDePagamento.map(grupo =>
            grupo.map((p, i) => ({
                id: p.id ?? (Date.now() + i),
                descricao: p.descricao,
                valor: Number(p.valor) || 0,
                desconto: Number(p.desconto) || 0
            }))
            );
        } else {
            gruposDePagamento = [];
        }

        renderizarGruposEParcelasUI();
        atualizarCabecalhoPagamentoUI();

        modalPagamento.classList.remove('hidden');
        modalPagamento.classList.add('flex');
        setTimeout(() => { modalPagamentoBox.classList.remove('-translate-y-10','opacity-0'); }, 50);
    }

    function fecharModalPagamento() {
        modalPagamentoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalPagamento.classList.add('hidden'); modalPagamento.classList.remove('flex'); }, 300);
    }

    function adicionarParcela() {
        // Esta função agora adiciona ao `grupoAtual`
        let descricao = pagamentoDescricaoSelect.value === 'outro' ? pagamentoDescricaoInputOutro.value.trim() : pagamentoDescricaoSelect.value;
        if (!descricao || !pagamentoValorInput.value) { alert("Preencha a descrição e o valor."); return; }

        const valorNumerico = parseFloat(pagamentoValorInput.value.replace(/\./g, "").replace(",", "."));
        const descontoNumerico = parseFloat(pagamentoDescontoParcelaInput.value.replace(/\./g, "").replace(",", ".") || '0');
        if (isNaN(valorNumerico) || valorNumerico <= 0) { alert("Insira um valor válido."); return; }

        const valorTotalGrupoLiquido = valorOrcamentoBruto - grupoAtual.reduce((acc, p) => acc + p.desconto, 0);
        const valorAlocadoGrupo = grupoAtual.reduce((acc, p) => acc + p.valor, 0);
        const valorRestanteGrupo = valorTotalGrupoLiquido - valorAlocadoGrupo;

        let valorBrutoParcela = pagamentoTipoValorInput.value === 'valor' ? valorNumerico : (valorOrcamentoBruto * valorNumerico) / 100;
        let descontoDaParcela = (valorBrutoParcela * descontoNumerico) / 100;
        let valorLiquidoParcela = valorBrutoParcela - descontoDaParcela;
        
        if (valorLiquidoParcela > valorRestanteGrupo + 0.01) {
            alert(`O valor da parcela (${formatarMoedaLocal(valorLiquidoParcela)}) excede o restante a pagar nesta opção (${formatarMoedaLocal(valorRestanteGrupo)}).`);
            return;
        }

        grupoAtual.push({ id: Date.now(), descricao, valor: valorLiquidoParcela, desconto: descontoDaParcela });
        
        // Limpa os campos do formulário
        pagamentoDescricaoSelect.value = '';
        pagamentoDescricaoInputOutro.value = '';
        pagamentoDescricaoInputOutro.classList.add('hidden');
        pagamentoValorInput.value = '';
        pagamentoDescontoParcelaInput.value = '';
        
        renderizarGruposEParcelasUI(); // Atualiza a lista "em construção"
        atualizarCabecalhoPagamentoUI(); // Recalcula os totais
    }

    
    function salvarGrupoAtual() {
        if (grupoAtual.length === 0) { alert("Adicione pelo menos uma parcela para criar uma opção de pagamento."); return; }

        const descontoTotalGrupo = grupoAtual.reduce((acc, p) => acc + p.desconto, 0);
        const valorTotalGrupo = grupoAtual.reduce((acc, p) => acc + p.valor, 0);
        const valorAlvo = valorOrcamentoBruto - descontoTotalGrupo;
        if (Math.abs(valorTotalGrupo - valorAlvo) > 0.01) {
            if (!confirm("O total desta opção de pagamento não corresponde ao valor total do orçamento com desconto. Deseja adicionar mesmo assim?")) return;
        }

        if (idGrupoEmEdicao !== null) {
            gruposDePagamento[idGrupoEmEdicao] = [...grupoAtual];
            idGrupoEmEdicao = null;
        } else {
            gruposDePagamento.push([...grupoAtual]); 
        }

        grupoAtual = [];
        renderizarGruposEParcelasUI();
        atualizarCabecalhoPagamentoUI();
    }

    function removerParcelaDoGrupoAtual(parcelaId) {
        grupoAtual = grupoAtual.filter(p => p.id !== parcelaId);
        renderizarGruposEParcelasUI();
        atualizarCabecalhoPagamentoUI();
    }

    function atualizarCabecalhoPagamentoUI() {
        const descontoTotalGrupo = grupoAtual.reduce((acc, p) => acc + p.desconto, 0);
        const valorTotalLiquido = valorOrcamentoBruto - descontoTotalGrupo;
        const valorAlocado = grupoAtual.reduce((acc, p) => acc + p.valor, 0);
        const valorRestante = valorTotalLiquido - valorAlocado;

        pagamentoValorTotalEl.textContent = formatarMoedaLocal(valorTotalLiquido);
        pagamentoValorDescontoEl.textContent = `- ${formatarMoedaLocal(descontoTotalGrupo)}`;
        pagamentoValorRestanteEl.textContent = formatarMoedaLocal(valorRestante);
        
        const progressoPercent = valorTotalLiquido > 0 ? (valorAlocado / valorTotalLiquido) * 100 : 0;
        pagamentoProgressBar.style.width = `${Math.min(progressoPercent, 100)}%`;
    }

    function renderizarGruposEParcelasUI() {
        // Renderiza o grupo que está sendo construído
        grupoAtualContainer.classList.toggle('hidden', grupoAtual.length === 0);
        listaParcelasGrupoAtual.innerHTML = '';
        grupoAtual.forEach(p => {
            let textoParcela = `${p.descricao}: ${formatarMoedaLocal(p.valor)}`;
            if (p.desconto > 0) textoParcela += ` (Desc. ${formatarMoedaLocal(p.desconto)})`;
            listaParcelasGrupoAtual.innerHTML += `<div class="flex justify-between items-center text-sm"><span>${textoParcela}</span><button onclick="removerParcelaDoGrupoAtual(${p.id})" class="text-red-500 font-bold">×</button></div>`;
        });
        
        // Renderiza os grupos já salvos
        gruposSalvosContainer.innerHTML = '';
        if (gruposDePagamento.length > 0) {
            gruposPlaceholder.classList.add('hidden');
            gruposDePagamento.forEach((grupo, index) => {
                const resumoGrupo = grupo.map(p => p.descricao).join(' + ');
                gruposSalvosContainer.innerHTML += `
                <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center">
                    <span>Opção ${index + 1}: ${resumoGrupo}</span>
                    <div class="flex gap-2">
                    <button onclick="editarGrupo(${index})" class="p-1 text-blue-600 rounded-full hover:bg-blue-100">Editar</button>
                    <button onclick="removerGrupo(${index})" class="p-1 text-red-500 rounded-full hover:bg-red-100">Remover</button>
                    </div>
                </div>`;
            });
        } else {
            gruposPlaceholder.classList.remove('hidden');
        }
    }

    // Funções para manipular os grupos salvos (serão adicionados os eventos depois)
    window.removerParcelaDoGrupoAtual = removerParcelaDoGrupoAtual;
    window.removerGrupo = function(index) {
        gruposDePagamento.splice(index, 1);
        renderizarGruposEParcelasUI();
    }

    window.editarGrupo = function(index) {
    grupoAtual = gruposDePagamento[index].map(p => ({
        id: p.id ?? (Date.now() + Math.floor(Math.random()*1000)),
        descricao: p.descricao,
        valor: Number(p.valor) || 0,
        desconto: Number(p.desconto) || 0
    }));
    idGrupoEmEdicao = index;
    renderizarGruposEParcelasUI();
    atualizarCabecalhoPagamentoUI();
    };

    function salvarPagamento() {
        if (grupoAtual.length > 0) {
            if (confirm("Você tem uma opção em construção. Deseja adicioná-la antes de confirmar?")) {
                salvarGrupoAtual();
            } else {
                grupoAtual = []; 
            }
        }
        
        // 1. Salva os DADOS COMPLETOS E ESTRUTURADOS no campo oculto para o backend
        document.getElementById('hidden_condicao_pagamento').value = JSON.stringify(gruposDePagamento);

        // 2. Cria o RESUMO VISUAL para o usuário
        if (gruposDePagamento.length > 0) {
            // Gera um resumo visual simples e funcional. Ex: "Opção 1: Entrada + Pix / Opção 2: À Vista"
            const resumoVisual = gruposDePagamento.map((grupo, i) => 
                `Opção ${i + 1}: ${grupo.map(p => p.descricao).join(' + ')}`
            ).join(' / ');
            
            displayCondicaoPagamento.textContent = resumoVisual;
            btnAbrirModalPagamento.textContent = "Editar";
        } else {
            displayCondicaoPagamento.textContent = 'A definir...';
            btnAbrirModalPagamento.textContent = "Definir";
            document.getElementById('hidden_condicao_pagamento').value = '[]'; // Garante que, ao limpar, salve um array vazio
        }
        
        fecharModalPagamento();
    }
    

    function preencherFormulario() {
        document.getElementById('nome').value = orcamentoData.nome_cliente || '';
        document.getElementById('telefone').value = orcamentoData.telefone_cliente || '';
        document.getElementById('cep').value = orcamentoData.cep_cliente || '';
        document.getElementById('logradouro').value = orcamentoData.logradouro_cliente || '';
        document.getElementById('numero_casa').value = orcamentoData.numero_casa_cliente || '';
        document.getElementById('complemento').value = orcamentoData.complemento_cliente || '';
        document.getElementById('bairro').value = orcamentoData.bairro_cliente || '';
        document.getElementById('cidade_uf').value = orcamentoData.cidade_uf_cliente || '';

        if (orcamentoData.cliente) { document.getElementById('cliente_id').value = orcamentoData.cliente.id; }
        document.getElementById('numero_orcamento').value = orcamentoData.numero;
        document.getElementById('descricaoServico').value = orcamentoData.descricao_servico;


        const condicaoPagamentoData = orcamentoData.condicao_pagamento;
        gruposDePagamento = [];

        let parsed = [];
        if (Array.isArray(condicaoPagamentoData)) {
        parsed = condicaoPagamentoData;
        } else if (condicaoPagamentoData && typeof condicaoPagamentoData === 'object') {
        parsed = [condicaoPagamentoData];
        } else if (typeof condicaoPagamentoData === 'string' && condicaoPagamentoData.trim().startsWith('[')) {
        try { parsed = JSON.parse(condicaoPagamentoData); } catch (e) { parsed = []; }
        }

        if (Array.isArray(parsed) && parsed.length > 0) {
        gruposDePagamento = Array.isArray(parsed[0]) ? parsed : [parsed];
        const resumoVisual = gruposDePagamento
            .map((grupo, i) => `Opção ${i + 1}: ${grupo.map(p => p.descricao).join(' + ')}`)
            .join(' / ');
        displayCondicaoPagamento.textContent = resumoVisual;
        btnAbrirModalPagamento.textContent = "Editar";
        } else {
        displayCondicaoPagamento.textContent =
            (typeof condicaoPagamentoData === 'string' && condicaoPagamentoData.trim() !== '')
            ? condicaoPagamentoData
            : 'A definir...';
        btnAbrirModalPagamento.textContent = "Definir";
        }

        // O campo oculto sempre começa com o dado original do banco
        const cp = orcamentoData.condicao_pagamento;
        document.getElementById('hidden_condicao_pagamento').value =
        Array.isArray(cp) || (cp && typeof cp === 'object')
            ? JSON.stringify(cp)
            : (cp || '[]');
        document.getElementById('hidden_prazo_entrega').value = orcamentoData.prazo_entrega || '';
        document.getElementById('hidden_garantia').value      = orcamentoData.garantia || '';
        document.getElementById('hidden_observacoes').value   = orcamentoData.observacoes || '';


    }

    function iniciarEdicaoItem(itemId) {
        // Encontra o item no nosso array de dados
        const itemParaEditar = itens.find(i => String(i.id) === String(itemId));
        if (!itemParaEditar) return;

        // Guarda o ID do item que estamos editando
        idItemEmEdicao = itemId;

        // 1. Preenche os campos do formulário com os dados do item
        itemInput.value = itemParaEditar.nome;
        itemQtdInput.value = itemParaEditar.quantidade;
        itemValorInput.value = itemParaEditar.valor.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
        tipoItemSelect.value = itemParaEditar.tipo;
        updateTipoItemIcon();

        // 2. Muda a aparência e o texto do botão
        adicionarItemBtn.textContent = 'Atualizar Item';
        adicionarItemBtn.classList.remove('from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');
        adicionarItemBtn.classList.add('from-amber-500', 'to-orange-600', 'hover:from-amber-600', 'hover:to-orange-700');

        // 3. Destaca a linha que está sendo editada
        document.querySelectorAll('#itensContainer tr').forEach(row => {
            row.classList.remove('bg-amber-100'); // Remove destaque de outras linhas
            if (row.dataset.id === String(itemId)) {
                row.classList.add('bg-amber-100'); // Adiciona destaque na linha atual
            }
        });
        
        // Rola a tela para o topo para que o usuário veja os campos preenchidos
        itemInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        itemInput.focus();
    }

    function renderizarItensNaTabela() {
        itensContainer.innerHTML = "";
        itens.forEach(item => {
            const rowId = (item.id ||= `temp-${crypto?.randomUUID?.() || Date.now()}`);
            const total = (item.quantidade || 0) * (item.valor || 0);
            const tr = document.createElement("tr");
            
            // Adiciona classes para o cursor e o hover para indicar que é clicável
            tr.className = "bg-white border-b hover:bg-gray-50 cursor-pointer"; 
            tr.dataset.id = rowId;
            
            // Adiciona o evento de clique para chamar a nossa nova função
            tr.onclick = () => iniciarEdicaoItem(rowId);

            tr.innerHTML = `<td class="px-4 py-3 font-medium text-gray-900 capitalize">${item.nome} (${item.tipo})</td>
                            <td class="px-4 py-3 text-center">${item.quantidade}</td>
                            <td class="px-4 py-3 text-right">${(item.valor || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
                            <td class="px-4 py-3 text-right">${total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
                            <td class="px-4 py-3 text-center"><button type="button" class="text-red-500 remove-item-btn" data-id="${rowId}">Excluir</button></td>`;
            
            // **IMPORTANTE**: Precisamos impedir que o clique no botão "Excluir" ative a edição da linha
            tr.querySelector('.remove-item-btn').onclick = function(event) {
                event.stopPropagation(); // Impede o evento de "borbulhar" para a linha (tr)
                const idToRemove = this.dataset.id;
                itens = itens.filter(i => String(i.id) !== idToRemove);
                renderizarItensNaTabela();

                verificarEAtualizarAvisoPagamento();
            };
            
            itensContainer.appendChild(tr);
        });
        tableContainer.classList.toggle("hidden", itens.length === 0);
    }

    function carregarContatosExtras() {
        contatosExtras = (orcamentoData.contatos_extras || []).map(c => ({ nome: c.nome, telefone: c.telefone, email: c.email || '' }));
        renderizarTagsDeContato();
    }

    function renderizarTagsDeContato() {
        listaContatosVisivel.innerHTML = '';
        contatosExtras.forEach((contato, index) => {
            const tagDiv = document.createElement('div');
            tagDiv.className = "flex items-center gap-2 bg-emerald-100 text-emerald-800 text-sm font-semibold px-3 py-1 rounded-full";
            let infoContato = `${contato.nome} - ${contato.telefone}${contato.email ? ` (${contato.email})` : ''}`;
            tagDiv.innerHTML = `<span>${infoContato}</span><button type="button" data-index="${index}" class="remove-contact-btn text-emerald-600 hover:text-emerald-900">×</button>`;
            listaContatosVisivel.appendChild(tagDiv);
        });
    }

    async function carregarCatalogosAPI() {
        try {
            const [respServ, respMat] = await Promise.all([ fetch(`/api/servico/`), fetch(`/api/materiais/`) ]);
            if (!respServ.ok || !respMat.ok) throw new Error("Falha ao carregar catálogos.");
            servicosCatalogo = await respServ.json(); materiaisCatalogo = await respMat.json();
            renderizarSeletor("servico"); renderizarSeletor("material");
        } catch (error) { console.error(error); }
    }

    function renderizarSeletor(tipo) {
        const container = document.getElementById(tipo === "servico" ? "containerServico" : "containerMaterial");
        const catalogo = tipo === "servico" ? servicosCatalogo : materiaisCatalogo;
        const placeholder = tipo === "servico" ? "-- Selecione um Serviço --" : "-- Selecione um Material --";
        const icon = icons[tipo];
        
        container.innerHTML = `
            <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">${icon}</div>
            <select class="select-catalogo h-10 w-full ps-10 pe-20 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400 appearance-none">
                <option value="">${placeholder}</option>
                ${catalogo.map(item => `<option value="${item.id}">${item.nome}</option>`).join("")}
            </select>
            <button type="button" data-tipo-catalogo="${tipo}" class="btn-abrir-modal-catalogo absolute inset-y-0 end-0 flex items-center justify-center px-3 border-l border-zinc-300 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
            </button>
        `;

        container.querySelector("select").addEventListener("change", (e) => handleSelecaoCatalogo(e, tipo));
        
        container.querySelector(".btn-abrir-modal-catalogo").addEventListener("click", (e) => {
            const tipoCatalogo = e.currentTarget.dataset.tipoCatalogo;
            abrirModalCatalogo(tipoCatalogo);
        });
    }

    function handleSelecaoCatalogo(e, tipo) {
        const id = e.target.value; if (!id) { return; }
        const itemSelecionado = (tipo === "servico" ? servicosCatalogo : materiaisCatalogo).find(item => String(item.id) === id);
        if (itemSelecionado) {
            itemInput.value = itemSelecionado.nome;
            itemValorInput.value = itemSelecionado.valor.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
            tipoItemSelect.value = tipo;
            updateTipoItemIcon();
            itemQtdInput.focus();
        }
    }

    function finalizarEdicao() {
        idItemEmEdicao = null;
        
        // Retorna o botão ao estado original
        adicionarItemBtn.textContent = 'Adicionar Item';
        adicionarItemBtn.classList.remove('from-amber-500', 'to-orange-600', 'hover:from-amber-600', 'hover:to-orange-700');
        adicionarItemBtn.classList.add('from-green-500', 'to-green-600', 'hover:from-green-600', 'hover:to-green-700');

        // Remove qualquer destaque da tabela
        document.querySelectorAll('#itensContainer tr').forEach(row => row.classList.remove('bg-amber-100'));
        
        limparCamposItem();
    }
    
    function adicionarItem() {
        const nomeVal = itemInput.value.trim();
        const qtdVal = parseInt(itemQtdInput.value, 10);
        const valStr = itemValorInput.value;
        const tipoVal = tipoItemSelect.value;
        
        if (!nomeVal || isNaN(qtdVal) || qtdVal <= 0 || !valStr || tipoVal === "default") {
            alert("Preencha todos os campos do item.");
            return;
        }
        
        const valVal = parseFloat(valStr.replace(/\./g, "").replace(",", "."));
        
        // --- LÓGICA ATUALIZADA ---
        if (idItemEmEdicao) {
            // MODO ATUALIZAÇÃO: Se estamos editando, a lógica é de atualizar o item existente.
            const itemAAtualizar = itens.find(i => String(i.id) === String(idItemEmEdicao));
            if(itemAAtualizar) {
                itemAAtualizar.nome = nomeVal;
                itemAAtualizar.quantidade = qtdVal;
                itemAAtualizar.valor = valVal;
                itemAAtualizar.tipo = tipoVal;
            }
        } else {
            // MODO ADIÇÃO: Se NÃO estamos editando, aplicamos a lógica de somar.
            const nomeNormalizado = nomeVal.toLowerCase();
            const itemExistente = itens.find(item => item.nome.toLowerCase() === nomeNormalizado);

            if (itemExistente) {
                // Se o item já existe, soma a quantidade e atualiza o valor.
                itemExistente.quantidade += qtdVal;
                itemExistente.valor = valVal;
            } else {
                // Se o item não existe, adiciona um novo.
                itens.push({ id: `temp-${Date.now()}`, nome: nomeVal, quantidade: qtdVal, valor: valVal, tipo: tipoVal });
            }
        }
        
        // Após adicionar ou atualizar, redesenha a tabela e reseta o formulário
        renderizarItensNaTabela();
        finalizarEdicao(); 
        verificarEAtualizarAvisoPagamento();
    }

    function limparCamposItem() {
        itemInput.value = "";
        itemQtdInput.value = "1";
        itemValorInput.value = "";
        tipoItemSelect.value = "default";
        document.getElementById("toggleSalvar").checked = false;
        updateTipoItemIcon();
    }

    async function handleUpdateSubmit(event) {
        event.preventDefault();
        if (itens.length === 0) {
            alert("O orçamento deve ter pelo menos um item.");
            return;
        }
        document.getElementById("hiddenItens").value = JSON.stringify(itens);
        document.getElementById("hiddenContatos").value = JSON.stringify(contatosExtras);

        const formData = new FormData(form);
        const submitButton = document.getElementById('gerarOrcamentoBtn');
        submitButton.disabled = true;
        submitButton.textContent = 'Atualizando...';

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData
            });

            // Primeiro, lemos a resposta JSON, não importa o status.
            const result = await response.json();

            if (!response.ok) { 
                // Se a resposta NÃO foi OK (ex: 403 Proibido), usamos o 'detail' para mostrar o modal de bloqueio.
                exibirAviso('blocked', result.detail || 'Acesso bloqueado.');
            } else {
                // Se a resposta foi OK (200), verificamos o status interno.
                if (result.status === 'success') {
                    // Se foi sucesso, redirecionamos para a lista.
                    window.location.href = '/orcamentos?atualizado=true';
                } else if (result.status === 'warning') {
                    // Se foi sucesso com aviso, mostramos o modal de aviso.
                    exibirAviso('warning', result.message);
                    
                    // E definimos que, ao fechar o modal, o usuário será redirecionado.
                    btnFecharModalAviso.onclick = () => {
                        fecharAviso();
                        window.location.href = '/orcamentos?atualizado=true';
                    };
                }
            }
        } catch (error) {
            console.error('Erro ao atualizar orçamento:', error);
            alert('Ocorreu um erro inesperado.');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Atualizar Orçamento';
        }
    }
    
    function adicionarEventListeners() {
        adicionarItemBtn.addEventListener("click", adicionarItem);
        itemValorInput.addEventListener("input", formatarMoeda);
        tipoItemSelect.addEventListener("change", updateTipoItemIcon);
        btnAdicionarContato.addEventListener('click', abrirModalContato);
        btnFecharModalContato.addEventListener('click', fecharModalContato);
        btnSalvarContatoModal.addEventListener('click', salvarContatoDoModal);
        btnFecharModalCatalogo.addEventListener('click', fecharModalCatalogo);
        btnFecharModalAviso.addEventListener('click', fecharAviso);
        modalCatalogo.addEventListener('click', (event) => { 
            if (event.target === modalCatalogo) fecharModalCatalogo(); 
        });
        filtroCatalogoInput.addEventListener('input', (e) => {
            const tipoAtual = modalCatalogo.dataset.tipoAtual;
            popularListaModalCatalogo(tipoAtual, e.target.value);
        });

        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-item-btn')) {
                const idToRemove = event.target.dataset.id;
                itens = itens.filter(i => String(i.id) !== idToRemove);
                renderizarItensNaTabela();

                verificarEAtualizarAvisoPagamento();
            }
            if (event.target.classList.contains('remove-contact-btn')) {
                const indexToRemove = parseInt(event.target.dataset.index, 10);
                contatosExtras.splice(indexToRemove, 1);
                renderizarTagsDeContato();
            }
        });
        
        form.addEventListener("submit", handleUpdateSubmit);

        btnAbrirModalInfo.addEventListener('click', abrirModalInfo);
        btnFecharModalInfo.addEventListener('click', fecharModalInfo);
        btnSalvarInfo.addEventListener('click', salvarInfoModal);

        btnAbrirModalPagamento.addEventListener('click', abrirModalPagamento);
        btnFecharModalPagamento.addEventListener('click', fecharModalPagamento);
        btnSalvarPagamento.addEventListener('click', salvarPagamento);
        btnAddParcela.addEventListener('click', adicionarParcela);
        btnSalvarGrupo.addEventListener('click', salvarGrupoAtual);

        pagamentoValorInput.addEventListener('input', formatarMoeda);
        pagamentoDescontoParcelaInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^\d,\.]/g,'');
        });

        pagamentoDescricaoSelect.addEventListener('change', () => {
            pagamentoDescricaoInputOutro.classList.toggle('hidden', pagamentoDescricaoSelect.value !== 'outro');
        });
    }

    // --- PONTO DE ENTRADA ---
    function inicializar() {
        preencherFormulario();
        renderizarItensNaTabela();
        initialTotal = calcularValorTotalOrcamento();

        carregarContatosExtras();
        carregarCatalogosAPI();
        updateTipoItemIcon();

        adicionarEventListeners();
    }

    inicializar();
});
</script>
</body>
</html>