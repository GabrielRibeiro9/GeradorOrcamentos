<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Orçamento</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
</head>
<header class="bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg px-4 sm:px-6 py-3 flex items-center justify-between text-white sticky top-0 z-50">
  <!-- Esquerda: Avatar + Nome -->
  <div class="flex items-center gap-3">
    <!-- Avatar -->
    <div class="w-10 h-10 rounded-full bg-white/20 ring-2 ring-white/50 flex items-center justify-center text-white font-bold text-xl shadow-md flex-shrink-0">
      {{ user.username[0]|upper }}
    </div>
    <!-- Nome do Usuário: sempre visível -->
    <div class="font-semibold text-base sm:text-lg">
      Olá, <span class="font-bold">{{ user.username }}</span>
    </div>
  </div>
  <!-- Direita: Botões de Ação -->
  <div class="flex items-center gap-2 sm:gap-3">
    <!-- Botão Orçamentos -->
    <a href="/orcamentos"
       class="flex items-center gap-2 px-3 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h4a1 1 0 100-2H7zm0 4a1 1 0 100 2h4a1 1 0 100-2H7z" clip-rule="evenodd" />
      </svg>
      <span class="font-semibold hidden sm:inline">Orçamentos</span>
    </a>
    <!-- Botão Sair -->
    <a href="/logout"
       class="flex items-center gap-2 px-3 py-2 bg-red-500/80 hover:bg-red-500 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
      </svg>
      <span class="font-semibold hidden sm:inline">Sair</span>
    </a>
  </div>
</header>

    <div class="flex flex-col gap-8 p-8 max-w-4xl mx-auto">
        <h1 class="text-3xl sm:text-3xl md:text-4xl font-extrabold text-center mb-1 bg-gradient-to-tr from-green-600 to-green-400 bg-clip-text text-transparent drop-shadow">
        Formulário para Orçamento
        </h1>
        <form id="orcamentoForm" action="/salvar-orcamento/" method="post" class="flex flex-col gap-4">

            <!-- DADOS DO CLIENTE E ENDEREÇO -->
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="nome" class="text-sm font-bold">Nome do Cliente:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.99 5.99 0 0 0-4.793 2.39A6.483 6.483 0 0 0 10 16.5a6.483 6.483 0 0 0 4.793-2.11A5.99 5.99 0 0 0 10 12Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input data-tippy-content="Nome do cliente ou da empresa. Se o cliente já existir, os dados podem ser carregados automaticamente." class="h-10 w-full ps-10 pe-20 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="nome" name="nome" required>
                    <!-- O botão que abre o modal -->
                    <button type="button" id="btnAbrirModalClientes" data-tippy-content="Buscar um cliente já cadastrado" class="absolute inset-y-0 end-0 flex items-center justify-center px-3 border-l border-zinc-300 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4"><path d="M2.5 3.5A1.5 1.5 0 0 1 4 2h8a1.5 1.5 0 0 1 1.5 1.5v9a1.5 1.5 0 0 1-1.5 1.5H4A1.5 1.5 0 0 1 2.5 12.5v-9ZM4 3a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5H4Z" /><path d="M7.25 5.5a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 0-1.5h-1.5Z" /><path fill-rule="evenodd" d="M4.75 9.75a.75.75 0 0 1 .75-.75h5.5a.75.75 0 0 1 0 1.5H5.5a.75.75 0 0 1-.75-.75Zm.75 2.25a.75.75 0 0 0 0 1.5h3.5a.75.75 0 0 0 0-1.5h-3.5Z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <input type="hidden" name="cliente_id" id="cliente_id">
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="cep" class="text-sm font-bold">CEP:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" /></svg></div>
                        <input data-tippy-content="Digite o CEP e pressione TAB para preencher o endereço automaticamente" class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="cep" name="cep" placeholder="_____-___" maxlength="9" inputmode="numeric">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="numero_casa" class="text-sm font-bold">Número:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M9.493 2.852a.75.75 0 0 0-1.486-.204L7.545 6H4.198a.75.75 0 0 0 0 1.5h3.14l-.69 5H3.302a.75.75 0 0 0 0 1.5h3.14l-.435 3.148a.75.75 0 0 0 1.486.204L7.955 14h2.986l-.434 3.148a.75.75 0 0 0 1.486.204L12.456 14h3.346a.75.75 0 0 0 0-1.5h-3.14l.69-5h3.346a.75.75 0 0 0 0-1.5h-3.14l.435-3.148a.75.75 0 0 0-1.486-.204L12.045 6H9.059l.434-3.148ZM8.852 7.5l-.69 5h2.986l.69-5H8.852Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="numero_casa" name="numero_casa" required inputmode="numeric">
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="logradouro" class="text-sm font-bold">Rua:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="m9.69 18.933.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 0 0 .281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 1 0 3 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 0 0 2.273 1.765 11.842 11.842 0 0 0 .976.544l.062.029.018.008.006.003ZM10 11.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="logradouro" name="logradouro" required>
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="complemento" class="text-sm font-bold">Complemento:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="complemento" name="complemento">
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap items-end justify-between gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[150px]">
                    <label for="bairro" class="text-sm font-bold">Bairro:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M8.157 2.176a1.5 1.5 0 0 0-1.147 0l-4.084 1.69A1.5 1.5 0 0 0 2 5.25v10.877a1.5 1.5 0 0 0 2.074 1.386l3.51-1.452 4.26 1.762a1.5 1.5 0 0 0 1.146 0l4.083-1.69A1.5 1.5 0 0 0 18 14.75V3.872a1.5 1.5 0 0 0-2.073-1.386l-3.51 1.452-4.26-1.762ZM7.58 5a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1-1.5 0v-6.5A.75.75 0 0 1 7.58 5Zm5.59 2.75a.75.75 0 0 0-1.5 0v6.5a.75.75 0 0 0 1.5 0v-6.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 pr-2 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="bairro" name="bairro" required>
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[120px]">
                    <label for="cidade_uf" class="text-sm font-bold">Cidade/UF:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M1 2.75A.75.75 0 0 1 1.75 2h10.5a.75.75 0 0 1 0 1.5H12v13.75a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1-.75-.75v-2.5a.75.75 0 0 0-.75-.75h-2.5a.75.75 0 0 0-.75.75v2.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5H2v-13h-.25A.75.75 0 0 1 1 2.75ZM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM4.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM8 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1ZM8.5 9a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1ZM14.25 6a.75.75 0 0 0-.75.75V17a1 1 0 0 0 1 1h3.75a.75.75 0 0 0 0-1.5H18v-9h.25a.75.75 0 0 0 0-1.5h-4Zm.5 3.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1Zm.5 3.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="cidade_uf" name="cidade_uf" required>
                    </div>
                </div>
            </div>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="telefone" class="text-sm font-bold">Telefone:</label>
                <div class="relative w-full">
                    <!-- Ícone do Telefone (como no original) -->
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 0 0 6.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 0 1 1.767-1.052l3.223.716A1.5 1.5 0 0 1 18 15.352V16.5a1.5 1.5 0 0 1-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 0 1 2.43 8.326 13.019 13.019 0 0 1 2 5V3.5Z" clip-rule="evenodd" /></svg>
                    </div>

                    <!-- O campo de Telefone (como no original, mas com padding à direita) -->
                    <input data-tippy-content="Telefone principal para contato com o cliente." class="h-10 w-full ps-10 pe-12 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="tel" id="telefone" name="telefone" placeholder="(99) 99999-9999" maxlength="15">
                    
                    <!-- NOVO: O botão "+" discreto, posicionado dentro do campo -->
                    <button type="button" id="btnAdicionarContato" data-tippy-content="Adicionar outros contatos (nome, telefone, e-mail) a este orçamento." class="absolute inset-y-0 end-0 flex items-center justify-center h-10 w-10 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg border-l border-zinc-300">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                          <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Container onde as linhas extras de contato serão inseridas pelo JavaScript -->
            <div id="lista-contatos-visivel" class="w-full flex flex-wrap gap-2 mt-1"> </div>

            <!-- Input oculto para os contatos extras -->
            <input type="hidden" name="contatos" id="hiddenContatos">


            <div class="flex items-center justify-start -mt-3">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggleSalvarCliente" name="salvar_cliente" class="sr-only peer" data-tippy-content="Se ativado, salva ou atualiza os dados deste cliente no seu cadastro para uso futuro.">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900">Salvar cliente?</span>
                </label>
            </div>
            
            <!-- DETALHES DO ORÇAMENTO -->
            <h1 class="text-3xl sm:text-3xl md:text-4xl font-extrabold text-center mb-1 bg-gradient-to-tr from-green-600 to-green-400 bg-clip-text text-transparent drop-shadow">
            Detalhamento
            </h1>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="descricaoServico" class="text-sm font-bold">Descrição do serviço:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" /><path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" /></svg></div>
                    <input data-tippy-content="Um resumo geral do trabalho a ser feito. Ex: 'Servico de pintura de area externa'" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="descricaoServico" name="descricao_servico" placeholder="Descreva o serviço a ser executado" required>
                </div>
            </div>
            
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="selectServico" class="text-sm font-bold">Serviço do Catálogo:</label>
                <div id="containerServico" class="relative w-full" data-tippy-content="Selecione um serviço pré-cadastrado no seu catálogo para preencher os campos de item automaticamente.">
                    <!-- O JavaScript vai preencher este espaço -->
                </div>
            </div>
            <div class="flex flex-col items-start justify-start gap-2">
                <label for="selectMaterial" class="text-sm font-bold">Material do Catálogo:</label>
                <div id="containerMaterial" class="relative w-full" data-tippy-content="Selecione um material pré-cadastrado no seu catálogo para preencher os campos de item automaticamente.">
                    <!-- O JavaScript vai preencher este espaço -->
                </div>
            </div>

            <div class="flex flex-col items-start justify-start gap-2">
                <label for="item" class="text-sm font-bold">Item:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="m2.695 14.762-1.262 3.155a.5.5 0 0 0 .65.65l3.155-1.262a4 4 0 0 0 1.343-.886L17.5 5.501a2.121 2.121 0 0 0-3-3L3.58 13.419a4 4 0 0 0-.885 1.343Z" /></svg></div>
                    <input data-tippy-content="Descreva o serviço ou material específico. Ex: 'Pintura de area externa' ou 'Tinta acrílica branca (lata 18L)'" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="item" name="item">
                </div>
            </div>
            <div id="ncm-field-container" class="hidden flex-col items-start justify-start gap-2">
                <label for="itemNCM" class="text-sm font-bold">NCM:</label>
                <div class="relative w-full">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                        <!-- Ícone para o NCM -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400">
                            <path fill-rule="evenodd" d="M2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H2Zm13 2a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0V8a1 1 0 0 0-1-1Zm-3 1a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v4a1 1 0 0 1-2 0V8Zm-4-1a1 1 0 0 0-1 1v4a1 1 0 0 0 2 0V8a1 1 0 0 0-1-1ZM4 8a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v4a1 1 0 0 1-2 0V8Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="itemNCM" name="itemNCM" placeholder="Ex: 1234.56.78" inputmode="numeric" oninput="mascaraNCM(event)" maxlength="10">
                </div>
            </div>
            <div class="flex flex-wrap items-start justify-start gap-2">
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="itemQtd">Qtd:</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M10 1c-1.716 0-3.408.106-5.07.31C3.806 1.45 3 2.414 3 3.517V16.75A2.25 2.25 0 0 0 5.25 19h9.5A2.25 2.25 0 0 0 17 16.75V3.517c0-1.103-.806-2.068-1.93-2.207A41.403 41.403 0 0 0 10 1ZM5.99 8.75A.75.75 0 0 1 6.74 8h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm1.417-5.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm1.42-5.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm-.75 2.916a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01ZM12.5 8.75a.75.75 0 0 1 .75-.75h.01a.75.75 0 0 1 .75.75v.01a.75.75 0 0 1-.75.75h-.01a.75.75 0 0 1-.75-.75v-.01Zm.75 1.417a.75.75 0 0 0-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 0 0 .75-.75v-.01a.75.75 0 0 0-.75-.75h-.01Zm0 2.166a.75.75 0 0 1 .75.75v2.167a.75.75 0 1 1-1.5 0v-2.167a.75.75 0 0 1 .75-.75ZM6.75 4a.75.75 0 0 0-.75.75v.5c0 .414.336.75.75.75h6.5a.75.75 0 0 0 .75-.75v-.5a.75.75 0 0 0-.75-.75h-6.5Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="number" id="itemQtd" value="1" inputmode="numeric" pattern="[0-9]*">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="itemValor">Valor(unit):</label>
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="M10.75 10.818v2.614A3.13 3.13 0 0 0 11.888 13c.482-.315.612-.648.612-.875 0-.227-.13-.56-.612-.875a3.13 3.13 0 0 0-1.138-.432ZM8.33 8.62c.053.055.115.11.184.164.208.16.46.284.736.363V6.603a2.45 2.45 0 0 0-.35.13c-.14.065-.27.143-.386.233-.377.292-.514.627-.514.909 0 .184.058.39.202.592.037.051.08.102.128.152Z" /><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-8-6a.75.75 0 0 1 .75.75v.316a3.78 3.78 0 0 1 1.653.713c.426.33.744.74.925 1.2a.75.75 0 0 1-1.395.55 1.35 1.35 0 0 0-.447-.563 2.187 2.187 0 0 0-.736-.363V9.3c.698.093 1.383.32 1.959.696.787.514 1.29 1.27 1.29 2.13 0 .86-.504 1.616-1.29 2.13-.576.377-1.261.603-1.96.696v.299a.75.75 0 1 1-1.5 0v-.3c-.697-.092-1.382-.318-1.958-.695-.482-.315-.857-.717-1.078-1.188a.75.75 0 1 1 1.359-.636c.08.173.245.376.54.569.313.205.706.353 1.138.432v-2.748a3.782 3.782 0 0 1-1.653-.713C6.9 9.433 6.5 8.681 6.5 7.875c0-.805.4-1.558 1.097-2.096a3.78 3.78 0 0 1 1.653-.713V4.75A.75.75 0 0 1 10 4Z" clip-rule="evenodd" /></svg></div>
                        <input class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" type="text" id="itemValor" name="itemValor" inputmode="decimal">
                    </div>
                </div>
                <div class="flex flex-col items-start justify-start flex-1 min-w-[80px]">
                    <label class="text-sm font-bold" for="tipoItem">Tipo:</label>
                    <div class="relative w-full" data-tippy-content="Classifique o item como 'Serviço' (mão de obra) ou 'Material' (produto). Isso ajuda a organizar o orçamento e os cálculos.">
                        <div id="tipoItemIcon" class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none"></div>
                        <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none tipoItemSeta">                           
                        </div>
                        <select class="h-10 w-full ps-9 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400 appearance-none" id="tipoItem" name="tipoItem">
                            <option value="default">Seleção</option>
                            <option value="servico">Serviço</option>
                            <option value="material">Material</option>
                        </select>
                    </div>
                </div>
            </div>
                <div class="flex items-center justify-start gap-6 mb-4">
            
                        <!-- Esquerda: Toggle para Salvar no Catálogo -->
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleSalvar" class="sr-only peer" data-tippy-content="Se ativado, salva este item no seu catálogo de Serviços ou Materiais para uso rápido em futuros orçamentos.">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            <span class="ms-3 text-sm font-medium text-gray-900">Salvar item?</span>
                        </label>

                        <!-- Direita: Campo do Número do Orçamento -->
                        <div class="flex items-center gap-2">
                            <label for="numero_orcamento" class="text-sm font-medium text-gray-700">Nº:</label>
                            <input type="text" id="numero_orcamento" name="numero_orcamento" 
                                data-tippy-content="Número sequencial do orçamento. O sistema sugere o próximo número disponível."
                                class="w-20 h-6 text-center font-semibold border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400" value="">
                                
                        </div>

                        <button
                            type="button"
                            id="btn-abrir-modal-info"
                            data-tippy-content="Adicionar Condições de Pagamento, Prazo de Entrega, Garantia e Observações"
                            class="flex items-center justify-center h-10 w-10 rounded-full bg-white shadow-md border border-emerald-200 text-emerald-600 hover:bg-emerald-50 hover:scale-105 active:scale-95 active:shadow-sm transition-all duration-150 group"
                        
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-6 group-hover:scale-110 transition-transform duration-200">
                                <circle cx="10" cy="10" r="8" fill="none" stroke="currentColor" stroke-width="1.5"/>
                                <path fill-rule="evenodd" d="M10 14a1 1 0 0 1-1-1V9a1 1 0 1 1 2 0v4a1 1 0 0 1-1 1zm0-6a1 1 0 1 1 0-2 1 1 0 0 1 0 2z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
            
            <div class="flex flex-col gap-2">
                <button id="adicionarItemBtn" data-tippy-content="Adiciona o item preenchido à lista abaixo. Se um item com o mesmo nome já existir, as quantidades serão somadas." class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold uppercase tracking-wide rounded-2xl shadow-lg transform hover:-translate-y-0.5 transition-all duration-200" type="button">Adicionar Item</button>
                <button id="gerarOrcamentoBtn" class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold uppercase tracking-wide rounded-xl shadow-md transform hover:-translate-y-0.5 transition-all duration-200" type="submit">Salvar Orçamento</button>
            </div>
            
            <div class="relative overflow-x-auto shadow-md sm:rounded-lg hidden" id="tableContainer">
                <table class="w-full text-sm text-left rtl:text-right">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3">Item / Tipo</th>
                            <th scope="col" class="px-4 py-3 text-center">Qtd</th>
                            <th scope="col" class="px-4 py-3 text-right">Valor Unit</th>
                            <th scope="col" class="px-4 py-3 text-right">Total</th>
                            <th scope="col" class="px-4 py-3 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="itensContainer">
                    </tbody>
                </table>
            </div>
        <input type="hidden" name="itens" id="hiddenItens" />
        <input type="hidden" name="condicao_pagamento" id="hidden_condicao_pagamento" />
        <input type="hidden" name="prazo_entrega" id="hidden_prazo_entrega" />
        <input type="hidden" name="garantia" id="hidden_garantia" />
        <input type="hidden" name="observacoes" id="hidden_observacoes" />
        
        {% if show_fechamento %}

        <input type="hidden" name="fechamento_json" id="fechamento_json">

        <div id="fechamento-bloco" class="mt-8 p-4 border rounded-xl bg-gray-50">
        <h2 class="text-lg font-semibold mb-3">Fechamento da Nota</h2>

        <div class="grid sm:grid-cols-2 gap-3">
            <div>
            <label class="text-sm font-medium">Valor da Nota/Contrato (R$)</label>
            <input id="fn-valor-nota" type="text" inputmode="decimal"
                    class="mt-1 w-full h-10 px-3 border rounded"
                    placeholder="0,00">
            </div>
            <div>
            <label class="text-sm font-medium">Regime / Preset</label>
            <select id="fn-preset" class="mt-1 w-full h-10 px-3 border rounded">
                <option value="personalizado">Personalizado</option>
                <option value="simples">Simples (alíquota única)</option>
                <option value="presumido">Presumido (exemplo)</option>
                <option value="mei">MEI (exemplo)</option>
            </select>
            </div>
        </div>

        <div class="grid sm:grid-cols-3 gap-3 mt-3">
            <div><label class="text-xs text-gray-600">ISS (%)</label><input id="fn-iss" type="number" step="0.01" class="w-full h-10 px-3 border rounded" value="5"></div>
            <div><label class="text-xs text-gray-600">INSS retido (%)</label><input id="fn-inss" type="number" step="0.01" class="w-full h-10 px-3 border rounded" value="0"></div>
            <div><label class="text-xs text-gray-600">IRRF (%)</label><input id="fn-irrf" type="number" step="0.01" class="w-full h-10 px-3 border rounded" value="0"></div>
            <div><label class="text-xs text-gray-600">PIS (%)</label><input id="fn-pis" type="number" step="0.01" class="w-full h-10 px-3 border rounded" value="0"></div>
            <div><label class="text-xs text-gray-600">COFINS (%)</label><input id="fn-cofins" type="number" step="0.01" class="w-full h-10 px-3 border rounded" value="0"></div>
            <div><label class="text-xs text-gray-600">CSLL (%)</label><input id="fn-csll" type="number" step="0.01" class="w-full h-10 px-3 border rounded" value="0"></div>
            <div class="sm:col-span-3">
            <label class="text-xs text-gray-600">Outros (R$)</label>
            <input id="fn-outros" type="text" inputmode="decimal" class="w-full h-10 px-3 border rounded" value="0,00">
            </div>
        </div>

        <div class="mt-3">
            <label class="text-sm font-medium">Outras despesas (R$) — opcional</label>
            <input id="fn-outras-despesas" type="text" inputmode="decimal" class="mt-1 w-full h-10 px-3 border rounded" value="0,00">
        </div>

        <div class="grid md:grid-cols-3 gap-3 mt-4">
            <div class="p-3 bg-white border rounded">
            <div class="text-xs text-gray-500">Líquido da Nota</div>
            <div id="fn-res-liquido" class="text-lg font-bold">R$ 0,00</div>
            <div class="text-xs text-gray-500">Impostos: <span id="fn-res-impostos">R$ 0,00</span></div>
            </div>
            <div class="p-3 bg-white border rounded">
            <div class="text-xs text-gray-500">Custos</div>
            <div class="text-xs">Mão de obra: <span id="fn-res-mo">R$ 0,00</span></div>
            <div class="text-xs">Materiais: <span id="fn-res-mat">R$ 0,00</span></div>
            <div class="text-xs">Outras: <span id="fn-res-outras">R$ 0,00</span></div>
            </div>
            <div class="p-3 bg-white border rounded">
            <div class="text-xs text-gray-500">Lucro</div>
            <div id="fn-res-lucro" class="text-lg font-bold">R$ 0,00</div>
            <div class="text-xs">Dízimo (10%): <span id="fn-res-dizimo">R$ 0,00</span></div>
            <div class="text-xs">Lucro final: <span id="fn-res-lucro-final">R$ 0,00</span></div>
            </div>
        </div>
        </div>
        {% endif %}
        
        </form>
    </div>

    <!-- O Modal de Clientes (começa escondido) -->
            <div id="modalClientes" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
            <div id="modalClientesBox" class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
                <div class="flex items-center justify-between p-4 border-b">
                    <div class="flex items-center gap-3">
                        <div class="flex-shrink-0 bg-gray-100 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-600">
                                <path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.25 1.25 0 0 1 2.228-1.567l.11-.128a5 5 0 0 1 7.4-2.228l.11.128a1.25 1.25 0 0 1 2.228 1.567l-.11.128a3.5 3.5 0 0 1-5.18 1.567l-.255.255a.75.75 0 0 1-1.06 0l-.255-.255a3.5 3.5 0 0 1-5.18-1.567l-.11-.128Z" />
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Selecione um Cliente</h3>
                    </div>
                    <button id="btnFecharModalClientes" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
                </div>
                <div class="p-1">
                    <input type="text" id="filtroCliente" class="w-full h-10 px-3 my-2 border border-zinc-200 rounded-md" placeholder="Buscar por nome...">
                </div>
                <div id="listaClientesModal" class="p-2 max-h-80 overflow-y-auto">
                    <!-- A lista de clientes será inserida aqui pelo JavaScript -->
                </div>
            </div>
        </div>
        <div id="modal-info" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-info-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Informações Adicionais do Orçamento</h3>
                <button id="btn-fechar-modal-info" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            <div class="mt-4 space-y-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Condição de Pagamento:</label>
                    <div class="mt-1 flex items-center gap-2">
                        <!-- Campo para exibir o resultado -->
                        <div id="display-condicao-pagamento" class="flex-grow h-10 px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-600 truncate">
                            A definir...
                        </div>
                        <!-- Botão que abrirá o novo modal -->
                        <button type="button" id="btn-abrir-modal-pagamento" class="flex-shrink-0 h-10 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition-colors">
                            Definir
                        </button>
                    </div>
                </div>

                <div>
                    <label for="info-prazo-entrega" class="block text-sm font-medium text-gray-700">Prazo de Entrega/Execução:</label>
                    <input type="text" id="info-prazo-entrega" placeholder="Ex: 7 dias úteis após aprovação" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>

                <div>
                    <label for="info-garantia" class="block text-sm font-medium text-gray-700">Garantia:</label>
                    <input type="text" id="info-garantia" placeholder="Ex: 90 dias para o serviço prestado" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="info-observacoes" class="block text-sm font-medium text-gray-700">Observações Adicionais:</label>
                    <textarea id="info-observacoes" rows="3" placeholder="Informações extras, detalhes específicos, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500"></textarea>
                </div>

            </div>
            <div class="mt-6 text-right">
                <button id="btn-salvar-info" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
      <div id="modal-contato" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="modal-contato-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            <div class="flex items-center justify-between pb-3 border-b">
                <h3 class="text-xl font-semibold text-gray-800">Adicionar Novo Contato</h3>
                <button id="btn-fechar-modal-contato" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            <div class="mt-4 space-y-4">
                
                <div>
                    <label for="modal-contato-nome" class="block text-sm font-medium text-gray-700">Nome do Contato:</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.25 1.25 0 0 1 2.228-1.567l.11-.128a5 5 0 0 1 7.4-2.228l.11.128a1.25 1.25 0 0 1 2.228 1.567l-.11.128a3.5 3.5 0 0 1-5.18 1.567l-.255.255a.75.75 0 0 1-1.06 0l-.255-.255a3.5 3.5 0 0 1-5.18-1.567l-.11-.128Z" /></svg>
                        </div>
                        <input type="text" id="modal-contato-nome" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400">
                    </div>
                </div>

                <div>
                    <label for="modal-contato-telefone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                    <div class="relative mt-1">
                        <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400"><path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 0 0 6.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 0 1 1.767-1.052l3.223.716A1.5 1.5 0 0 1 18 15.352V16.5a1.5 1.5 0 0 1-1.5 1.5H15c-1.149 0-2.263-.15-3.326-.43A13.022 13.022 0 0 1 2.43 8.326 13.019 13.019 0 0 1 2 5V3.5Z" clip-rule="evenodd" /></svg>
                        </div>
                        <input type="tel" id="modal-contato-telefone" placeholder="(99) 99999-9999" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400" maxlength="15" oninput="mascara(event, '(##) #####-####')">
                    </div>
                </div>

                <div>
                <label for="modal-contato-email" class="block text-sm font-medium text-gray-700">E-mail (Opcional):</label>
                <div class="relative mt-1">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">
                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-gray-400">
                           <path d="M3 4a2 2 0 0 0-2 2v1.161l8.441 4.221a1.25 1.25 0 0 0 1.118 0L19 7.162V6a2 2 0 0 0-2-2H3Z" />
                           <path d="M19 8.839l-7.77 3.885a2.75 2.75 0 0 1-2.46 0L1 8.839V14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8.839Z" />
                       </svg>
                    </div>
                    <input type="email" id="modal-contato-email" placeholder="email@exemplo.com" class="h-10 w-full ps-10 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400">
                </div>
            </div>

            </div>
            <div class="mt-6 text-right">
                <button id="btn-salvar-contato-modal" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Adicionar
                </button>
            </div>
        </div>
    </div>
        <div id="modal-catalogo" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] transition-opacity duration-300">
        <div id="modal-catalogo-box" class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh] transform transition-all -translate-y-10 opacity-0 duration-300">
            <!-- Cabeçalho do Modal -->
            <div class="flex items-center justify-between p-4 border-b">
                <h3 id="modal-catalogo-titulo" class="text-xl font-semibold text-gray-800">Buscar no Catálogo</h3>
                <button id="btn-fechar-modal-catalogo" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
            </div>
            
            <!-- Campo de Busca -->
            <div class="p-4 border-b">
                <input type="text" id="filtro-catalogo-input" class="w-full h-10 px-3 border border-zinc-300 rounded-md shadow-sm" placeholder="Digite para buscar...">
            </div>
            
            <!-- Lista de Itens (com rolagem) -->
            <div id="lista-catalogo-modal" class="p-2 overflow-y-auto">
                <!-- A lista de itens do catálogo será inserida aqui pelo JavaScript -->
            </div>
        </div>
    </div>

    <div id="modal-pagamento" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60] transition-opacity duration-300">
    <div id="modal-pagamento-box" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl mx-4 flex flex-col max-h-[90vh] transform transition-all -translate-y-10 opacity-0 duration-300">
        
        <div class="flex items-center justify-between p-4 border-b sticky top-0 bg-white">
            <h3 class="text-xl font-semibold text-gray-800">Definir Condições de Pagamento</h3>
            <button id="btn-fechar-modal-pagamento" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
        </div>

        <!-- Corpo do Modal -->
        <div class="p-6 space-y-5 overflow-y-auto">

            <!-- Indicadores de Valor (sem mudanças na estrutura) -->
            <div class="bg-gray-50 p-4 rounded-lg border sticky top-0">
                <!-- ... (o conteúdo dos indicadores de valor continua o mesmo) ... -->
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-gray-600">Total com Desconto:</span>
                    <span id="pagamento-valor-total" class="font-bold text-emerald-600 text-xl">R$ 0,00</span>
                </div>
                <div class="flex justify-between items-center text-sm mb-3">
                    <span class="font-medium text-amber-600">Desconto aplicado:</span>
                    <span id="pagamento-valor-desconto" class="font-bold text-amber-700">- R$ 0,00</span>
                </div>
                <div class="flex justify-between items-center text-lg mb-2">
                    <span class="font-medium text-gray-600">Restante a alocar (nesta opção):</span>
                    <span id="pagamento-valor-restante" class="font-bold text-blue-600">R$ 0,00</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="pagamento-progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
                <!-- Formulário para Adicionar Parcelas -->
                <div class="space-y-4 pt-2">
                    <!-- Linha 1: Descrição da Parcela -->
                    <div>
                        <label for="pagamento-descricao-select" class="block text-sm font-medium text-gray-700">Descrição</label>
                        <select id="pagamento-descricao-select" class="mt-1 block w-full h-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="">-- Selecione --</option>
                            <option value="Entrada">Entrada</option>
                            <option value="Sinal">Sinal</option>
                            <option value="À vista">À vista</option>
                            <option value="Pix">Pix</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="outro">Outro (especificar)</option>
                        </select>
                        <input type="text" id="pagamento-descricao-input-outro" placeholder="Especifique a descrição" class="hidden mt-2 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <div class="flex items-end gap-2">
                        <!-- Tipo (R$ / %) -->
                        <div class="flex-none">
                            <label for="pagamento-tipo-valor-input" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="pagamento-tipo-valor-input" class="mt-1 block w-full h-10 px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="percent">%</option>
                                <option value="valor">R$</option>
                            </select>
                        </div>
                        <!-- Valor -->
                        <div class="flex-grow">
                            <label for="pagamento-valor-input" class="block text-sm font-medium text-gray-700">Valor</label>
                            <input type="text" id="pagamento-valor-input" inputmode="decimal" placeholder="Ex: 50" class="mt-1 block w-full h-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <!-- Desconto na Parcela (%) -->
                        <div class="flex-none">
                            <label for="pagamento-desconto-parcela" class="block text-sm font-medium text-gray-700">Desc. (%)</label>
                            <input type="text" id="pagamento-desconto-parcela" inputmode="decimal" placeholder="0" class="mt-1 block w-20 h-10 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500">
                        </div>
                    </div>
                    
                    <!-- Linha 4: Botão de Adicionar -->
                        <button id="btn-add-parcela" class="w-full h-11 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
                            <span>Adicionar Parcela a esta Opção</span>
                        </button>
                    </div>
                                
                <div id="grupo-atual-container" class="border-t pt-4 mt-4 hidden">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Opção em construção:</h4>
                    <div id="lista-parcelas-grupo-atual" class="space-y-2 p-2 bg-blue-50/50 rounded-lg border-l-4 border-blue-400">
                        <!-- As parcelas do grupo atual aparecerão aqui -->
                    </div>
                    <button id="btn-salvar-grupo" class="w-full mt-3 h-11 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>
                        <span>Finalizar e Adicionar Opção</span>
                    </button>
                </div>

                <!-- **** NOVA SEÇÃO: OPÇÕES JÁ SALVAS **** -->
                <div class="border-t pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-700 mb-2">Opções de Pagamento Salvas:</h4>
                    <div id="grupos-salvos-container" class="space-y-2">
                        <p id="grupos-placeholder" class="text-center text-gray-400 py-4">Nenhuma opção de pagamento definida.</p>
                    </div>
                </div>

            </div>

            <!-- Rodapé -->
            <div class="flex items-center justify-end p-4 bg-gray-50 border-t sticky bottom-0">
                <button id="btn-salvar-pagamento" class="bg-emerald-600 text-white font-semibold py-2 px-6 rounded-lg shadow hover:bg-emerald-700 transition-colors">
                    Confirmar Todas as Condições
                </button>
            </div>
        </div>
    </div>
    <div id="modal-aviso" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[100] transition-opacity duration-300">
        <div id="modal-aviso-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
            
            <div id="aviso-header" class="text-center mb-4">
                <!-- Conteúdo dinâmico aqui (ícone e título) -->
            </div>

            <div id="aviso-mensagem" class="text-center text-gray-600 mb-6">
                <!-- Mensagem dinâmica da API aqui -->
            </div>

            <div class="mt-5 sm:mt-6">
                <button id="btn-fechar-modal-aviso" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">
                    Entendi
                </button>
            </div>
        </div>
    </div>

<script>

document.addEventListener("DOMContentLoaded", function() {
    
    // --- CONFIGURAÇÃO E VARIÁVEIS GLOBAIS ---
    const API_BASE_URL = window.location.origin;
    let itens = [];
    let contatosExtras = [];
    let servicosCatalogo = [];
    let materiaisCatalogo = [];

    // --- ELEMENTOS DO DOM ---
    const modalAviso = document.getElementById('modal-aviso');
    const modalAvisoBox = document.getElementById('modal-aviso-box');
    const avisoHeader = document.getElementById('aviso-header');
    const avisoMensagem = document.getElementById('aviso-mensagem');
    const btnFecharModalAviso = document.getElementById('btn-fechar-modal-aviso');
    const form = document.getElementById("orcamentoForm");
    const tableContainer = document.getElementById("tableContainer");
    const itensContainer = document.getElementById("itensContainer");
    const tipoItemSelect = document.getElementById("tipoItem");
    const tipoItemIconDiv = document.getElementById("tipoItemIcon");
    const itemInput = document.getElementById("item");
    const itemQtdInput = document.getElementById("itemQtd");
    const itemValorInput = document.getElementById("itemValor");
    const cepInput = document.getElementById("cep");
    const telefoneInput = document.getElementById("telefone");
    const adicionarItemBtn = document.getElementById("adicionarItemBtn");
    const gerarOrcamentoBtn = document.getElementById("gerarOrcamentoBtn");
    const nomeInput = document.getElementById("nome");
    const clienteIdInput = document.getElementById("cliente_id"); 
    const btnAbrirModalClientes = document.getElementById("btnAbrirModalClientes");
    const modalClientes = document.getElementById("modalClientes");
    const btnFecharModalClientes = document.getElementById("btnFecharModalClientes");
    const listaClientesModal = document.getElementById("listaClientesModal");
    const toggleSalvarCliente = document.getElementById("toggleSalvarCliente");
    const modalInfo = document.getElementById('modal-info');
    const modalInfoBox = document.getElementById('modal-info-box');
    const btnAbrirModalInfo = document.getElementById('btn-abrir-modal-info');
    const btnFecharModalInfo = document.getElementById('btn-fechar-modal-info');
    const btnSalvarInfo = document.getElementById('btn-salvar-info');
    const modalClientesBox = document.getElementById("modalClientesBox");
    const filtroClienteInput = document.getElementById("filtroCliente");
    const btnAdicionarContato = document.getElementById("btnAdicionarContato");
    const modalContato = document.getElementById('modal-contato');
    const modalContatoBox = document.getElementById('modal-contato-box');
    const btnFecharModalContato = document.getElementById('btn-fechar-modal-contato');
    const btnSalvarContatoModal = document.getElementById('btn-salvar-contato-modal');
    const listaContatosVisivel = document.getElementById('lista-contatos-visivel');
    const modalCatalogo = document.getElementById('modal-catalogo');
    const modalCatalogoBox = document.getElementById('modal-catalogo-box');
    const modalCatalogoTitulo = document.getElementById('modal-catalogo-titulo');
    const btnFecharModalCatalogo = document.getElementById('btn-fechar-modal-catalogo');
    const filtroCatalogoInput = document.getElementById('filtro-catalogo-input');
    const listaCatalogoModal = document.getElementById('lista-catalogo-modal');

    const modalPagamento = document.getElementById('modal-pagamento');
    const modalPagamentoBox = document.getElementById('modal-pagamento-box');
    const btnAbrirModalPagamento = document.getElementById('btn-abrir-modal-pagamento');
    const btnFecharModalPagamento = document.getElementById('btn-fechar-modal-pagamento');
    const btnSalvarPagamento = document.getElementById('btn-salvar-pagamento');

    // Elementos de exibição de valores (NOVOS)
    const pagamentoValorDescontoEl = document.getElementById('pagamento-valor-desconto');
    const pagamentoValorTotalEl = document.getElementById('pagamento-valor-total'); // Agora é o total líquido
    const pagamentoValorRestanteEl = document.getElementById('pagamento-valor-restante');
    const pagamentoProgressBar = document.getElementById('pagamento-progress-bar');

    // Inputs do formulário de parcela (NOVOS)
    const pagamentoDescricaoSelect = document.getElementById('pagamento-descricao-select');
    const pagamentoDescricaoInputOutro = document.getElementById('pagamento-descricao-input-outro');
    const pagamentoTipoValorInput = document.getElementById('pagamento-tipo-valor-input');
    const pagamentoValorInput = document.getElementById('pagamento-valor-input');
    const pagamentoDescontoParcelaInput = document.getElementById('pagamento-desconto-parcela');
    const btnAddParcela = document.getElementById('btn-add-parcela');
    const grupoAtualContainer = document.getElementById('grupo-atual-container');
    const listaParcelasGrupoAtual = document.getElementById('lista-parcelas-grupo-atual');
    const btnSalvarGrupo = document.getElementById('btn-salvar-grupo');
    const gruposSalvosContainer = document.getElementById('grupos-salvos-container');
    const gruposPlaceholder = document.getElementById('grupos-placeholder');

    // Container da lista e placeholder
    const listaParcelasContainer = document.getElementById('lista-parcelas-container');
    const parcelasPlaceholder = document.getElementById('parcelas-placeholder');

    // Display no modal de informações
    const displayCondicaoPagamento = document.getElementById('display-condicao-pagamento');

    // --- VARIÁVEIS DE ESTADO (MODAL DE PAGAMENTO) ---
    let gruposDePagamento = []; // Lista principal que conterá os grupos
    let grupoAtual = [];         // Lista temporária para o grupo que está sendo montado no modal
    let idGrupoEmEdicao = null;  // Para saber se estamos editando um grupo existente
    let valorOrcamentoBruto = 0;
    let descontoTotalEmValor = 0;
    
    
    const icons = {
        servico: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M14.5 10a4.5 4.5 0 004.284-5.882c-.105-.324-.51-.391-.752-.15L15.34 6.66a.454.454 0 01-.493.11 3.01 3.01 0 01-1.618-1.616.455.455 0 01.11-.494l2.694-2.692c.24-.241.174-.647-.15-.752a4.5 4.5 0 00-5.873 4.575c.055.873-.128 1.808-.8 2.368l-7.23 6.024a2.724 2.724 0 103.837 3.837l6.024-7.23c.56-.672 1.495-.855 2.368-.8.096.007.193.01.291.01ZM5 16a1 1 0 10-2 0 1 1 0 002 0Z" clip-rule="evenodd" /><path d="M14.5 11.5c.173 0 .345-.007.514-.022l3.754 3.754a2.5 2.5 0 01-3.536 3.536l-4.41-4.41 2.172-2.607c.052-.063.147-.138.342-.196.202-.06.469-.087.777-.067.128.008.257.012.387.012ZM6 4.586l2.33 2.33a.452.452 0 01-.08.09L6.8 8.214 4.586 6H3.309a.5.5 0 01-.447-.276l-1.7-3.402a.5.5 0 01.093-.577l.49-.49a.5.5 0 01.577-.094l3.402 1.7A.5.5 0 016 3.31v1.277Z" /></svg>`,
        material: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M7.84 1.804A1 1 0 0 1 8.82 1h2.36a1 1 0 0 1 .98.804l.331 1.652a6.993 6.993 0 0 1 1.929 1.115l1.598-.54a1 1 0 0 1 1.186.447l1.18 2.044a1 1 0 0 1-.205 1.251l-1.267 1.113a7.047 7.047 0 0 1 0 2.228l1.267 1.113a1 1 0 0 1 .206 1.25l-1.18 2.045a1 1 0 0 1-1.187.447l-1.598-.54a6.993 6.993 0 0 1-1.929 1.115l-.33 1.652a1 1 0 0 1-.98.804H8.82a1 1 0 0 1-.98-.804l-.331-1.652a6.993 6.993 0 0 1-1.929-1.115l-1.598.54a1 1 0 0 1-1.186-.447l-1.18-2.044a1 1 0 0 1 .205-1.251l1.267-1.114a7.05 7.05 0 0 1 0-2.227L1.821 7.773a1 1 0 0 1-.206-1.25l1.18-2.045a1 1 0 0 1 1.187-.447l1.598.54A6.992 6.992 0 0 1 7.51 3.456l.33-1.652ZM10 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" clip-rule="evenodd" /></svg>`,
        default: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>`
    };

    function calcularValorTotalOrcamento() {
        return itens.reduce((total, item) => total + (item.quantidade * item.valor), 0);
    }

    function formatarMoedaLocal(valor) {
        return valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function abrirModalPagamento() {
        valorOrcamentoBruto = calcularValorTotalOrcamento();
        if (valorOrcamentoBruto <= 0) {
            alert("Adicione itens ao orçamento primeiro para definir as condições de pagamento.");
            return;
        }

        // Zera o grupo de trabalho atual ao abrir
        grupoAtual = [];
        idGrupoEmEdicao = null;

        // A lógica para carregar grupos salvos do `orcamentoData` virá depois.
        // Por enquanto, começamos com a lista de grupos vazia.
        gruposDePagamento = []; 

        renderizarGruposEParcelasUI(); // Renderiza o estado inicial do modal
        atualizarCabecalhoPagamentoUI(); // Calcula os totais do grupo atual

        modalPagamento.classList.remove('hidden');
        modalPagamento.classList.add('flex');
        setTimeout(() => { modalPagamentoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
    }

    function fecharModalPagamento() {
        modalPagamentoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalPagamento.classList.add('hidden'); modalPagamento.classList.remove('flex'); }, 300);
    }

    function adicionarParcela() {
        // Esta função agora adiciona ao `grupoAtual`
        let descricao = pagamentoDescricaoSelect.value === 'outro' ? pagamentoDescricaoInputOutro.value.trim() : pagamentoDescricaoSelect.value;
        if (!descricao || !pagamentoValorInput.value) { alert("Preencha a descrição e o valor."); return; }

        const valorNumerico = parseFloat(pagamentoValorInput.value.replace(/\./g, "").replace(",", "."));
        const descontoNumerico = parseFloat(pagamentoDescontoParcelaInput.value.replace(/\./g, "").replace(",", ".") || '0');
        if (isNaN(valorNumerico) || valorNumerico <= 0) { alert("Insira um valor válido."); return; }

        const valorTotalGrupoLiquido = valorOrcamentoBruto - grupoAtual.reduce((acc, p) => acc + p.desconto, 0);
        const valorAlocadoGrupo = grupoAtual.reduce((acc, p) => acc + p.valor, 0);
        const valorRestanteGrupo = valorTotalGrupoLiquido - valorAlocadoGrupo;

        let valorBrutoParcela = pagamentoTipoValorInput.value === 'valor' ? valorNumerico : (valorOrcamentoBruto * valorNumerico) / 100;
        let descontoDaParcela = (valorBrutoParcela * descontoNumerico) / 100;
        let valorLiquidoParcela = valorBrutoParcela - descontoDaParcela;
        
        if (valorLiquidoParcela > valorRestanteGrupo + 0.01) {
            alert(`O valor da parcela (${formatarMoedaLocal(valorLiquidoParcela)}) excede o restante a pagar nesta opção (${formatarMoedaLocal(valorRestanteGrupo)}).`);
            return;
        }

        grupoAtual.push({ id: Date.now(), descricao, valor: valorLiquidoParcela, desconto: descontoDaParcela });
        
        // Limpa os campos do formulário
        pagamentoDescricaoSelect.value = '';
        pagamentoDescricaoInputOutro.value = '';
        pagamentoDescricaoInputOutro.classList.add('hidden');
        pagamentoValorInput.value = '';
        pagamentoDescontoParcelaInput.value = '';
        
        renderizarGruposEParcelasUI(); // Atualiza a lista "em construção"
        atualizarCabecalhoPagamentoUI(); // Recalcula os totais
    }

    function salvarGrupoAtual() {
        if (grupoAtual.length === 0) {
            alert("Adicione pelo menos uma parcela para criar uma opção de pagamento.");
            return;
        }
        
        // Validação final do grupo
        const descontoTotalGrupo = grupoAtual.reduce((acc, p) => acc + p.desconto, 0);
        const valorTotalGrupo = grupoAtual.reduce((acc, p) => acc + p.valor, 0);
        const valorAlvo = valorOrcamentoBruto - descontoTotalGrupo;

        if (Math.abs(valorTotalGrupo - valorAlvo) > 0.01) {
            if (!confirm("O total desta opção de pagamento não corresponde ao valor total do orçamento com desconto. Deseja adicionar mesmo assim?")) {
                return;
            }
        }
        
        // Adiciona uma cópia do grupo atual à lista principal
        gruposDePagamento.push([...grupoAtual]);
        
        // Limpa o grupo de trabalho para começar uma nova opção
        grupoAtual = [];
        
        renderizarGruposEParcelasUI();
        atualizarCabecalhoPagamentoUI();
    }

    function removerParcelaDoGrupoAtual(parcelaId) {
        grupoAtual = grupoAtual.filter(p => p.id !== parcelaId);
        renderizarGruposEParcelasUI();
        atualizarCabecalhoPagamentoUI();
    }

    function atualizarCabecalhoPagamentoUI() {
        const descontoTotalGrupo = grupoAtual.reduce((acc, p) => acc + p.desconto, 0);
        const valorTotalLiquido = valorOrcamentoBruto - descontoTotalGrupo;
        const valorAlocado = grupoAtual.reduce((acc, p) => acc + p.valor, 0);
        const valorRestante = valorTotalLiquido - valorAlocado;

        pagamentoValorTotalEl.textContent = formatarMoedaLocal(valorTotalLiquido);
        pagamentoValorDescontoEl.textContent = `- ${formatarMoedaLocal(descontoTotalGrupo)}`;
        pagamentoValorRestanteEl.textContent = formatarMoedaLocal(valorRestante);
        
        const progressoPercent = valorTotalLiquido > 0 ? (valorAlocado / valorTotalLiquido) * 100 : 0;
        pagamentoProgressBar.style.width = `${Math.min(progressoPercent, 100)}%`;
    }

    function renderizarGruposEParcelasUI() {
        // Renderiza o grupo que está sendo construído
        grupoAtualContainer.classList.toggle('hidden', grupoAtual.length === 0);
        listaParcelasGrupoAtual.innerHTML = '';
        grupoAtual.forEach(p => {
            let textoParcela = `${p.descricao}: ${formatarMoedaLocal(p.valor)}`;
            if (p.desconto > 0) textoParcela += ` (Desc. ${formatarMoedaLocal(p.desconto)})`;
            listaParcelasGrupoAtual.innerHTML += `<div class="flex justify-between items-center text-sm"><span>${textoParcela}</span><button onclick="removerParcelaDoGrupoAtual(${p.id})" class="text-red-500 font-bold">×</button></div>`;
        });
        
        // Renderiza os grupos já salvos
        gruposSalvosContainer.innerHTML = '';
        if (gruposDePagamento.length > 0) {
            gruposPlaceholder.classList.add('hidden');
            gruposDePagamento.forEach((grupo, index) => {
                const resumoGrupo = grupo.map(p => p.descricao).join(' + ');
                gruposSalvosContainer.innerHTML += `<div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center"><span>Opção ${index + 1}: ${resumoGrupo}</span><button onclick="removerGrupo(${index})" class="p-1 text-red-500 rounded-full hover:bg-red-100">Remover</button></div>`;
            });
        } else {
            gruposPlaceholder.classList.remove('hidden');
        }
    }

    // Funções para manipular os grupos salvos (serão adicionados os eventos depois)
    window.removerParcelaDoGrupoAtual = removerParcelaDoGrupoAtual;
    window.removerGrupo = function(index) {
        gruposDePagamento.splice(index, 1);
        renderizarGruposEParcelasUI();
    }

    function salvarPagamento() {
        if (grupoAtual.length > 0) {
            if (confirm("Você tem uma opção em construção. Deseja adicioná-la antes de confirmar?")) {
                salvarGrupoAtual();
            } else {
                grupoAtual = []; 
            }
        }
        
        // 1. Salva os DADOS COMPLETOS E ESTRUTURADOS no campo oculto para o backend
        document.getElementById('hidden_condicao_pagamento').value = JSON.stringify(gruposDePagamento);

        // 2. Cria o RESUMO VISUAL para o usuário
        if (gruposDePagamento.length > 0) {
            // Gera um resumo visual simples e funcional. Ex: "Opção 1: Entrada + Pix / Opção 2: À Vista"
            const resumoVisual = gruposDePagamento.map((grupo, i) => 
                `Opção ${i + 1}: ${grupo.map(p => p.descricao).join(' + ')}`
            ).join(' / ');
            
            displayCondicaoPagamento.textContent = resumoVisual;
            btnAbrirModalPagamento.textContent = "Editar";
        } else {
            displayCondicaoPagamento.textContent = 'A definir...';
            btnAbrirModalPagamento.textContent = "Definir";
            document.getElementById('hidden_condicao_pagamento').value = '[]'; // Garante que, ao limpar, salve um array vazio
        }
        
        fecharModalPagamento();
    }

    function updateTipoItemIcon() {
    // Mostra a seta só para "Seleção"
    tipoItemIconDiv.innerHTML = icons[tipoItemSelect.value] || icons.default;
    }
    tipoItemSelect.addEventListener("change", updateTipoItemIcon);
    updateTipoItemIcon(); // inicial

    const tipoItemSeta = document.querySelector(".tipoItemSeta");

    function atualizarVisibilidadeSeta() {
        tipoItemSeta.style.display = tipoItemSelect.value === "default" ? "flex" : "none";
    }

    // Atualiza na carga inicial
    atualizarVisibilidadeSeta();

    // Atualiza quando o select mudar
    tipoItemSelect.addEventListener("change", atualizarVisibilidadeSeta);

    // --- FUNÇÕES AUXILIARES E DE UI ---
    
    function formatarMoeda(e ) {
        let value = e.target.value.replace(/\D/g, "");
        if (!value) { e.target.value = ""; return; }
        const numericValue = parseFloat(value) / 100;
        e.target.value = numericValue.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
    }
    function limparEFormatarMoeda(e) {
        let value = e.target.value.replace(/\D/g, "");
        if (!value) { e.target.value = ""; return; }
        const numericValue = parseFloat(value) / 100;
        e.target.value = numericValue.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
    }
    window.mascara = function(e, pattern) {
        let i = 0;
        const v = e.target.value.replace(/\D/g, "");
        e.target.value = pattern.replace(/#/g, () => v[i++] || "");
    }
    window.mascaraNCM = function(event) {
        const input = event.target;
        // Pega o valor atual e remove tudo que não for número.
        let value = input.value.replace(/\D/g, '');

        // Limita o valor a 8 dígitos para garantir que não ultrapasse o tamanho do NCM.
        value = value.substring(0, 8);

        // Formata a string de dígitos com os pontos.
        let formattedValue = '';
        if (value.length > 0) {
            // Pega os primeiros 4 dígitos.
            formattedValue = value.substring(0, 4);
        }
        if (value.length > 4) {
            // Adiciona o primeiro ponto e os próximos 2 dígitos.
            formattedValue += '.' + value.substring(4, 6);
        }
        if (value.length > 6) {
            // Adiciona o segundo ponto e os últimos 2 dígitos.
            formattedValue += '.' + value.substring(6, 8);
        }

        // Atualiza o valor do campo de input com a string formatada.
        input.value = formattedValue;
    }
    function updateTipoItemIcon() {
        tipoItemIconDiv.innerHTML = icons[tipoItemSelect.value] || icons.default;
    }
    function updateTableVisibility() {
        tableContainer.classList.toggle("hidden", itens.length === 0);
    }
    function limparCamposItem() {
        itemInput.value = "";
        itemQtdInput.value = "1";
        itemValorInput.value = "";
        tipoItemSelect.value = "default";
        document.getElementById("toggleSalvar").checked = false;
        const ncmInput = document.getElementById("itemNCM");
        if (ncmInput) ncmInput.value = "";
        updateTipoItemIcon();
        atualizarVisibilidadeNCM();
    }
    function renderizarTabelaCompleta() {
        const thead = tableContainer.querySelector('thead tr');
        
        // Limpa o conteúdo atual do cabeçalho e do corpo
        thead.innerHTML = '';
        itensContainer.innerHTML = '';

        // 1. Verifica se ALGUM item na lista atual tem um NCM
        const temNcmNaLista = itens.some(item => item.ncm && item.ncm.trim() !== '');

        // 2. Define os cabeçalhos dinamicamente
        let headers = ['Item / Tipo', 'Qtd', 'Valor Unit', 'Total', 'Ação'];
        if (temNcmNaLista) {
            // Insere 'NCM' na segunda posição do array de cabeçalhos
            headers.splice(1, 0, 'NCM');
        }

        // 3. Desenha o cabeçalho (thead) com base nos headers definidos
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.scope = 'col';
            th.className = 'px-4 py-3';
            // >>> MUDANÇA AQUI: Adicionamos 'NCM' à lista <<<
            if (['Qtd', 'Ação', 'NCM'].includes(headerText)) th.classList.add('text-center');
            if (['Valor Unit', 'Total'].includes(headerText)) th.classList.add('text-right');
            th.textContent = headerText;
            thead.appendChild(th);
        });

        // 4. Desenha as linhas do corpo da tabela (tbody)
        itens.forEach(item => {
            const total = item.quantidade * item.valor;
            const tr = document.createElement("tr");
            tr.className = "bg-white border-b border-gray-200 hover:bg-gray-50";
            tr.dataset.id = item.id;

            // Monta o HTML da linha dinamicamente
            let rowHTML = `
                <th scope="row" class="px-4 py-4 font-medium text-gray-900 capitalize align-middle">${item.nome} (${item.tipo})</th>
            `;

            if (temNcmNaLista) {
                // Se a coluna NCM existe, adiciona a célula (vazia ou com valor)
                rowHTML += `<td class="px-4 py-4 text-center align-middle">${item.ncm || ''}</td>`;
            }

            rowHTML += `
                <td class="px-4 py-4 text-center align-middle">${item.quantidade}</td>
                <td class="px-4 py-4 text-right align-middle">${item.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
                <td class="px-4 py-4 text-right align-middle">${total.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
                <td class="px-4 py-4 text-center align-middle">
                    <button type="button" class="text-red-500 hover:text-red-700 p-1 action-remover-item" data-id="${item.id}" title="Excluir item do orçamento">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 pointer-events-none">
                            <path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM6.05 6a.75.75 0 0 1 .787.71l.5 5a.75.75 0 1 1-1.474.14l-.5-5A.75.75 0 0 1 6.05 6Zm3.9 0a.75.75 0 0 1 .71.787l-.5 5a.75.75 0 1 1-1.474-.14l.5-5a.75.75 0 0 1 .764-.647Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;
            
            tr.innerHTML = rowHTML;
            itensContainer.appendChild(tr);
        });

        // 5. Adiciona os eventos de clique aos novos botões de remoção
        document.querySelectorAll('.action-remover-item').forEach(button => {
            button.addEventListener('click', (e) => {
                removerItem(e.currentTarget.dataset.id);
            });
        });

        // 6. Atualiza a visibilidade geral da tabela
        updateTableVisibility();
    }
    function limparFormularioCompleto() {
        form.reset();
        itens = [];
        contatosExtras = [];
        itensContainer.innerHTML = "";
        renderizarTagsDeContato();
        updateTableVisibility();
        updateTipoItemIcon();
        renderizarSeletor("servico");
        renderizarSeletor("material");
        preencherNumeroSugerido();
    }
    function atualizarVisibilidadeNCM() {
        // Pega a variável que o backend enviou. `tojson` garante que True/False funcionem.
        const temPermissao = JSON.parse('{{ tem_funcao_analise_custo | tojson }}');
        const ncmContainer = document.getElementById('ncm-field-container');

        // Se o elemento não existir na página, não faz nada para evitar erros.
        if (!ncmContainer) {
            return;
        }

        // A condição principal: o usuário tem permissão E o tipo é "material"?
        if (temPermissao === true && tipoItemSelect.value === 'material') {
            ncmContainer.classList.remove('hidden');
            ncmContainer.classList.add('flex'); // 'flex' para corresponder ao estilo dos outros campos
        } else {
            ncmContainer.classList.add('hidden');
            ncmContainer.classList.remove('flex');
        }
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO DINÂMICA ---
    
    function renderizarSeletor(tipo) {
        const container = document.getElementById(tipo === "servico" ? "containerServico" : "containerMaterial");
        const catalogo = tipo === "servico" ? servicosCatalogo : materiaisCatalogo;
        const placeholder = tipo === "servico" ? "-- Selecione um Serviço --" : "-- Selecione um Material --";
        const icon = icons[tipo];
        
        // O HTML agora inclui o botão de busca (a lupa)
        container.innerHTML = `
            <div class="absolute inset-y-0 start-0 flex items-center ps-3.5 pointer-events-none">${icon}</div>
            <select class="select-catalogo h-10 w-full ps-10 pe-20 border border-zinc-300 rounded-lg shadow-xs focus:outline-zinc-400 appearance-none">
                <option value="">${placeholder}</option>
                ${catalogo.map(item => `<option value="${item.id}">${item.nome}</option>`).join("")}
            </select>
            <button type="button" data-tipo-catalogo="${tipo}" class="btn-abrir-modal-catalogo absolute inset-y-0 end-0 flex items-center justify-center px-3 border-l border-zinc-300 text-zinc-600 hover:bg-zinc-100 transition-colors rounded-e-lg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
            </button>
        `;

        // Listener de evento para o <select> (como antes)
        container.querySelector("select").addEventListener("change", (e) => handleSelecaoCatalogo(e, tipo));
        
        // NOVO: Listener de evento para o botão da LUPA
        container.querySelector(".btn-abrir-modal-catalogo").addEventListener("click", (e) => {
            const tipoCatalogo = e.currentTarget.dataset.tipoCatalogo;
            abrirModalCatalogo(tipoCatalogo);
        });
    }


    function removerItem(itemId) {
        itens = itens.filter(item => String(item.id) !== String(itemId));
        const row = itensContainer.querySelector(`tr[data-id=\'${itemId}\']`);
        if (row) row.remove();
        renderizarTabelaCompleta();
        updateTableVisibility();
        if(window.recalcularFechamento) window.recalcularFechamento();
    }

    function abrirModalInfo() {
        modalInfo.classList.remove('hidden');
        modalInfo.classList.add('flex');
        setTimeout(() => { 
            modalInfoBox.classList.remove('-translate-y-10', 'opacity-0'); 
        }, 50); // Uma pequena espera para a animação
    }

    function fecharModalInfo() {
        modalInfoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { 
            modalInfo.classList.add('hidden');
            modalInfo.classList.remove('flex');
        }, 300); // Espera a animação de saída terminar
    }

    function salvarInfoModal() {
        // Pega os valores dos campos que ainda estão neste modal
        const prazoEntrega = document.getElementById('info-prazo-entrega').value;
        const garantia = document.getElementById('info-garantia').value;
        const observacoes = document.getElementById('info-observacoes').value;

        // Salva APENAS esses valores nos inputs ocultos correspondentes
        document.getElementById('hidden_prazo_entrega').value = prazoEntrega;
        document.getElementById('hidden_garantia').value = garantia;
        document.getElementById('hidden_observacoes').value = observacoes;
        
        // Mostra um feedback visual no ícone para indicar que os dados foram salvos
        const btnAbrir = document.getElementById('btn-abrir-modal-info');
        btnAbrir.classList.add('border-emerald-500', 'ring-2', 'ring-emerald-200');
        btnAbrir.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5 text-emerald-600"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.052-.143Z" clip-rule="evenodd" /></svg>`;

        // Fecha o modal de informações
        fecharModalInfo();
    }

    
    function abrirModalContato() {
        // Limpa os campos do modal antes de abrir
        document.getElementById('modal-contato-nome').value = '';
        document.getElementById('modal-contato-telefone').value = '';
        document.getElementById('modal-contato-email').value = ''; 
        
        modalContato.classList.remove('hidden');
        modalContato.classList.add('flex');
        setTimeout(() => { 
            modalContatoBox.classList.remove('-translate-y-10', 'opacity-0');
            document.getElementById('modal-contato-nome').focus();
        }, 50);
    }

    function fecharModalContato() {
        modalContatoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { 
            modalContato.classList.add('hidden');
            modalContato.classList.remove('flex');
        }, 300);
    }

    function salvarContatoDoModal() {
        const nome = document.getElementById('modal-contato-nome').value.trim();
        const telefone = document.getElementById('modal-contato-telefone').value.trim();
        const email = document.getElementById('modal-contato-email').value.trim(); 

        if (!nome || !telefone) {
            alert("Por favor, preencha o nome e o telefone do contato.");
            return;
        }

        const novoTelefoneNormalizado = telefone.replace(/\D/g, '');
        const telefonePrincipal = document.getElementById('telefone').value.trim();
        const telefonePrincipalNormalizado = telefonePrincipal.replace(/\D/g, '');
        
        
        const contatoExistente = contatosExtras.find(
        c => c.telefone.replace(/\D/g, '') === novoTelefoneNormalizado
    );

        // 2. AVALIA o que foi encontrado
        if (contatoExistente) {
            // CASO 1: O NÚMERO EXISTE NA LISTA DE CONTATOS EXTRAS
            const querAtualizar = confirm(
                `Este telefone já pertence ao contato "${contatoExistente.nome}".\n\nDeseja atualizar as informações dele com os novos dados?`
            );

            if (querAtualizar) {
                // Se o usuário confirmar, atualizamos o nome e o e-mail do objeto existente
                contatoExistente.nome = nome;
                contatoExistente.email = email;
            } else {
                // Se o usuário cancelar, não fazemos nada
                return;
            }

        } else if (novoTelefoneNormalizado === telefonePrincipalNormalizado && telefonePrincipalNormalizado !== '') {
            // CASO 2: O NÚMERO É IGUAL AO TELEFONE PRINCIPAL
            alert("Este telefone já está definido como o contato principal do cliente e não pode ser adicionado como um contato extra.");
            return; // Bloqueia a adição

        } else {
            // CASO 3: É UM NÚMERO TOTALMENTE NOVO
            contatosExtras.push({ nome: nome, telefone: telefone, email: email });
        }
        renderizarTagsDeContato();
        fecharModalContato();
    }

    function adicionarContato(contato) {
        if (!contato || !contato.nome || !contato.telefone) return;

        const tagDiv = document.createElement('div');
        tagDiv.className = "flex items-center gap-2 bg-emerald-100 text-emerald-800 text-sm font-semibold px-3 py-1 rounded-full";
        
        // Usa os dados do objeto 'contato' recebido para criar a tag
        tagDiv.innerHTML = `
            <span>${contato.nome} - ${contato.telefone}</span>
            <button type="button" class="text-emerald-600 hover:text-emerald-900 contact-remove-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4 pointer-events-none"><path d="M2.22 2.22a.75.75 0 0 1 1.06 0L8 6.94l4.72-4.72a.75.75 0 1 1 1.06 1.06L9.06 8l4.72 4.72a.75.75 0 1 1-1.06 1.06L8 9.06l-4.72 4.72a.75.75 0 0 1-1.06-1.06L6.94 8 2.22 3.28a.75.75 0 0 1 0-1.06Z" /></svg>
            </button>
        `;

        // Adiciona o evento para o botão de remover desta tag específica
        tagDiv.querySelector('.contact-remove-btn').addEventListener('click', function() {
            // Encontra o contato correspondente na lista e o remove
            const index = contatosExtras.findIndex(c => c.nome === contato.nome && c.telefone === contato.telefone);
            if (index > -1) {
                removerContatoExtra(index);
            }
        });
        
        listaContatosVisivel.appendChild(tagDiv);
    }
    
    // ESTA FUNÇÃO DESENHA AS TAGS VISÍVEIS NO FORMULÁRIO
    function renderizarTagsDeContato() {
        listaContatosVisivel.innerHTML = ''; // Limpa a lista antes de redesenhar
        contatosExtras.forEach((contato, index) => {
            const tagDiv = document.createElement('div');
            tagDiv.className = "flex items-center gap-2 bg-emerald-100 text-emerald-800 text-sm font-semibold px-3 py-1 rounded-full";
            let infoContato = `${contato.nome} - ${contato.telefone}`;

            if (contato.email) {
            infoContato += ` (${contato.email})`; // Adiciona o e-mail se ele existir
            }
            tagDiv.innerHTML = `
                <span>${contato.nome} - ${contato.telefone} </span>
                <button type="button" onclick="removerContatoExtra(${index})" class="text-emerald-600 hover:text-emerald-900">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4"><path d="M2.22 2.22a.75.75 0 0 1 1.06 0L8 6.94l4.72-4.72a.75.75 0 1 1 1.06 1.06L9.06 8l4.72 4.72a.75.75 0 1 1-1.06 1.06L8 9.06l-4.72 4.72a.75.75 0 0 1-1.06-1.06L6.94 8 2.22 3.28a.75.75 0 0 1 0-1.06Z" /></svg>
                </button>
            `;
            listaContatosVisivel.appendChild(tagDiv);
        });
    }

    // A sua função 'removerContatoExtra' precisa chamar a nova função de renderização
    window.removerContatoExtra = (index) => {
        contatosExtras.splice(index, 1);
        renderizarTagsDeContato(); // Atualiza as tags visíveis
    };
    
    function abrirModalCatalogo(tipo) {
        // Define o título do modal dinamicamente
        modalCatalogoTitulo.textContent = `Buscar em ${tipo === 'servico' ? 'Serviços' : 'Materiais'}`;
        
        // Guarda o tipo de catálogo que estamos buscando (para saber onde procurar)
        modalCatalogo.dataset.tipoAtual = tipo;
        
        // Carrega a lista de itens no modal
        popularListaModalCatalogo(tipo, '');
        
        // Abre o modal
        modalCatalogo.classList.remove('hidden');
        modalCatalogo.classList.add('flex');
        setTimeout(() => { 
            modalCatalogoBox.classList.remove('-translate-y-10', 'opacity-0');
            filtroCatalogoInput.focus(); // Foca no campo de busca
        }, 50);
    }

    function fecharModalCatalogo() {
        modalCatalogoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { 
            modalCatalogo.classList.add('hidden'); 
            modalCatalogo.classList.remove('flex');
            filtroCatalogoInput.value = ''; // Limpa a busca ao fechar
        }, 300);
    }

    function popularListaModalCatalogo(tipo, filtro) {
        const catalogo = tipo === 'servico' ? servicosCatalogo : materiaisCatalogo;
        const termoBusca = filtro.toLowerCase();
        
        // Filtra o catálogo com base no termo de busca
        const itensFiltrados = catalogo.filter(item => item.nome.toLowerCase().includes(termoBusca));
        
        listaCatalogoModal.innerHTML = ''; // Limpa a lista
        
        if (itensFiltrados.length === 0) {
            listaCatalogoModal.innerHTML = '<p class="p-4 text-center text-gray-400">Nenhum item encontrado.</p>';
            return;
        }
        
        itensFiltrados.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'p-3 flex justify-between items-center rounded-lg hover:bg-emerald-50 cursor-pointer border-b last:border-b-0';
            itemDiv.innerHTML = `
                <div class="flex flex-col flex-grow cursor-pointer">
                    <span class="font-semibold text-gray-800">${item.nome}</span>
                    <span class="text-sm text-gray-500">${item.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</span>
                </div>
                <button type="button" class="btn-excluir-item-catalogo p-2 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600">
                    <svg class="size-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM6.05 6a.75.75 0 0 1 .787.71l.5 5a.75.75 0 1 1-1.474.14l-.5-5A.75.75 0 0 1 6.05 6Zm3.9 0a.75.75 0 0 1 .71.787l-.5 5a.75.75 0 1 1-1.474-.14l.5-5a.75.75 0 0 1 .764-.647Z" clip-rule="evenodd" /></svg>
                </button>
            `;
            // Adiciona o evento de clique que seleciona o item e fecha o modal
            itemDiv.querySelector(".flex-grow").addEventListener('click', () => selecionarItemDoModal(item.id, tipo));
            // Clique no BOTÃO LIXEIRA para excluir
            itemDiv.querySelector(".btn-excluir-item-catalogo").addEventListener('click', (e) => {
                e.stopPropagation(); // Impede que o clique na lixeira selecione o item
                confirmarExclusao(item.id, item.nome);
            });
            listaCatalogoModal.appendChild(itemDiv);
        });
    }

    function selecionarItemDoModal(itemId, tipo) {
        // Simula a seleção no dropdown original
        const selectId = tipo === 'servico' ? 'containerServico' : 'containerMaterial';
        const select = document.querySelector(`#${selectId} select`);
        select.value = itemId;
        
        // Dispara o evento 'change' manualmente para que a função handleSelecaoCatalogo seja chamada
        // e preencha os campos (Item, Valor, etc.)
        select.dispatchEvent(new Event('change'));
        
        fecharModalCatalogo();
    }

    // --- FUNÇÕES DE LÓGICA E EVENTOS ---

    async function carregarCatalogosAPI() {
        try {
            const [respServ, respMat] = await Promise.all([
                fetch(`${API_BASE_URL}/api/servico/`),
                fetch(`${API_BASE_URL}/api/materiais/`)
            ]);
            if (!respServ.ok || !respMat.ok) throw new Error("Falha ao carregar catálogos do servidor.");
            servicosCatalogo = await respServ.json();
            materiaisCatalogo = await respMat.json();
            renderizarSeletor("servico");
            renderizarSeletor("material");
        } catch (error) {
            console.error(error);
            document.getElementById("containerServico").innerHTML = `<div class="text-red-500 p-2">Erro ao carregar serviços.</div>`;
            document.getElementById("containerMaterial").innerHTML = `<div class="text-red-500 p-2">Erro ao carregar materiais.</div>`;
        }
    }

    function handleSelecaoCatalogo(e, tipo) {
        const selectElement = e.target;
        const id = selectElement.value;

        if (!id) { // Se o usuário selecionou "-- Selecione --"
            itemInput.value = '';
            itemValorInput.value = '';
            return;
        }
        
        const catalogo = tipo === "servico" ? servicosCatalogo : materiaisCatalogo;
        const itemSelecionado = catalogo.find(item => String(item.id) === id);
        
        if (!itemSelecionado) return;

        // 1. Preenche os campos do formulário com os dados do item escolhido
        itemInput.value = itemSelecionado.nome;
        itemValorInput.value = itemSelecionado.valor.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
        tipoItemSelect.value = tipo;

        const ncmInput = document.getElementById("itemNCM");
        if (ncmInput) {
            // Se o item do catálogo tiver um NCM, preenche. Senão, limpa.
            ncmInput.value = itemSelecionado.ncm || '';
        }

        updateTipoItemIcon();
        atualizarVisibilidadeNCM();
        itemQtdInput.focus();
        
        
    }


    async function handleVerificacaoCliente() {
        const nome = nomeInput.value.trim();
        // Só faz a verificação se o campo tiver pelo menos 3 caracteres e se nenhum cliente já foi selecionado (ID está vazio)
        if (nome.length < 3 || clienteIdInput.value !== '') {
            return;
        }

        try {
            // Chama nossa nova API, passando o nome do cliente como parâmetro de busca
            const response = await fetch(`/api/cliente/verificar/?nome=${encodeURIComponent(nome)}`);
            const clienteEncontrado = await response.json();

            // Se o objeto retornado NÃO estiver vazio (ou seja, a API encontrou um cliente)
            if (Object.keys(clienteEncontrado).length > 0) {
                
                // Pergunta ao usuário o que ele deseja fazer
                const querCarregar = confirm(
                    `Um cliente chamado "${clienteEncontrado.nome}" já existe.\n\nDeseja carregar os dados dele para editar ou adicionar informações?`
                );

                if (querCarregar) {
                    // Se o usuário clicar "OK", nós usamos a função que já existe para popular o formulário!
                    selecionarCliente(clienteEncontrado.id);
                }
            }
        } catch (error) {
            console.error('Erro ao verificar cliente:', error);
            // Não mostramos um alert para não atrapalhar, mas registramos o erro no console.
        }
    }

        
    
    async function confirmarExclusao(itemId, itemName) {
        if (!confirm(`Tem certeza que deseja excluir "${itemName}" do catálogo?`)) {
            return;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/item/${itemId}`, { method: 'DELETE' });

            if (response.status !== 204) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || "Falha ao excluir o item.");
            }
            
            // --- ATUALIZAÇÃO AUTOMÁTICA ---
            // 1. Limpa os campos de item caso o item excluído esteja neles
            if(itemInput.value === itemName) {
                limparCamposItem();
            }
            
            // 2. Recarrega os catálogos da API para atualizar a lista de dados
            await carregarCatalogosAPI(); 
            
            // 3. Redesenha a lista DENTRO DO MODAL com a lista atualizada
            // (ele pega o termo de busca atual e o tipo de catálogo para se redesenhar)
            const tipoAtual = modalCatalogo.dataset.tipoAtual;
            const filtroAtual = filtroCatalogoInput.value;
            popularListaModalCatalogo(tipoAtual, filtroAtual);
            
            // 4. (Opcional, mas recomendado) Envia um alerta de sucesso
            // alert(`Item "${itemName}" removido com sucesso.`);
            
        } catch (error) {
            console.error("Erro ao excluir item:", error);
            alert(`Ocorreu um erro: ${error.message}`);
        }
    }
        
    async function consultarCep(e) {
        const cep = e.target.value.replace(/\D/g, "");
        if (cep.length === 8) {
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/` );
                const data = await response.json();
                if (data.erro) {
                    alert("CEP não encontrado.");
                } else {
                    document.getElementById("logradouro").value = data.logradouro || "";
                    document.getElementById("bairro").value = data.bairro || "";
                    document.getElementById("cidade_uf").value = `${data.localidade || ""}/${data.uf || ""}`;
                    document.getElementById("numero_casa").focus();
                }
            } catch (error) {
                alert("Erro ao consultar o CEP.");
            }
        }
    }


    async function adicionarItem() {
        const nomeVal = itemInput.value.trim();
        const qtdVal = parseInt(itemQtdInput.value, 10);
        const valStr = itemValorInput.value;
        const tipo = tipoItemSelect.value;
        const salvar = document.getElementById("toggleSalvar").checked;

        if (tipo === "default" || !nomeVal || isNaN(qtdVal) || qtdVal <= 0 || !valStr) {
            alert("Para adicionar um item, preencha: Item, Quantidade, Valor e selecione um Tipo válido.");
            return;
        }
        
        const valVal = parseFloat(valStr.replace(/\./g, "").replace(",", "."));
        
        // --- NOVA LÓGICA DE VERIFICAÇÃO ---
        const nomeNormalizado = nomeVal.toLowerCase();
        const itemExistente = itens.find(item => item.nome.toLowerCase() === nomeNormalizado);

        if (itemExistente) {
            // Se o item já existe, apenas somamos a quantidade e atualizamos o valor
            itemExistente.quantidade += qtdVal;
            itemExistente.valor = valVal;

            // Como o item já existe, não precisamos salvá-lo de novo no catálogo
            // então limpamos a flag, se estiver marcada, para evitar erros.
            document.getElementById("toggleSalvar").checked = false;

        } else {
            // Se o item não existe, continuamos com a lógica original de adicionar um novo item
            let itemParaAdicionar = { 
                nome: nomeVal, 
                quantidade: qtdVal,
                valor: valVal, 
                tipo: tipo,
                id: `temp-${Date.now()}`
            };

            const ncmInput = document.getElementById("itemNCM");
            if (ncmInput && tipo === 'material' && ncmInput.value.trim()) {
                itemParaAdicionar.ncm = ncmInput.value.trim();
            }

            if (salvar) {
                try {
                    const resp = await fetch(`${API_BASE_URL}/api/item/`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ nome: nomeVal, valor: valVal, tipo: tipo, ncm: (tipo === 'material' && document.getElementById("itemNCM")?.value.trim()) || null })
                    });

                    if (!resp.ok) {
                        const errorData = await resp.json();
                        if (resp.status === 409) {
                            alert(errorData.detail);
                            return;
                        }
                        throw new Error(errorData.detail || "Erro desconhecido do servidor.");
                    }

                    const itemSalvo = await resp.json();
                    itemParaAdicionar.id = itemSalvo.id;
                    await carregarCatalogosAPI();
                } catch (error) {
                    alert(`Erro ao tentar salvar item no catálogo: ${error.message}`);
                    return;
                }
            }
            
            itens.push(itemParaAdicionar);
        }

        renderizarTabelaCompleta();
        

        if(window.recalcularFechamento) window.recalcularFechamento();
        limparCamposItem();
    }

    function fecharModalDeClientes() {
        modalClientesBox.classList.add('opacity-0', '-translate-y-10');
        setTimeout(() => { modalClientes.classList.add('hidden'); }, 300);
    }
    
    async function deletarCliente(clienteId, clienteDiv) {
        if (!confirm("Tem certeza que deseja apagar este cliente? Esta ação não pode ser desfeita.")) return;
        clienteDiv.style.opacity = '0.5';
        try {
            const res = await fetch(`/api/clientes/${clienteId}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('Falha ao excluir o cliente.');
            clienteDiv.remove();
        } catch (e) {
            alert(e.message);
            clienteDiv.style.opacity = '1';
        }
    }

    async function selecionarCliente(id) {
        try {
            const res = await fetch(`/api/clientes/${id}`);
            if (!res.ok) {
                throw new Error('Não foi possível carregar os dados completos do cliente.');
            }
            const cliente = await res.json();
            
            // 1. Limpa contatos extras anteriores
            contatosExtras = [];
            renderizarTagsDeContato();

            // 2. Preenche TODOS os campos do formulário, com segurança para valores nulos
            nomeInput.value = cliente.nome || '';
            telefoneInput.value = cliente.telefone || '';
            cepInput.value = cliente.cep || '';
            document.getElementById('logradouro').value = cliente.logradouro || '';
            document.getElementById('numero_casa').value = cliente.numero_casa || '';
            document.getElementById('bairro').value = cliente.bairro || '';
            document.getElementById('cidade_uf').value = cliente.cidade_uf || '';
            document.getElementById('complemento').value = cliente.complemento || '';
            clienteIdInput.value = cliente.id;

            // 3. Força a aplicação das máscaras de CEP e Telefone
            if (telefoneInput.oninput) telefoneInput.dispatchEvent(new Event('input'));
            if (cepInput.oninput) cepInput.dispatchEvent(new Event('input'));
            
            // 4. Popula a lista de contatos EXTRAS com os novos dados
            if (cliente.contatos && cliente.contatos.length > 0) {
                contatosExtras = cliente.contatos.map(c => ({
                    nome: c.nome || '',
                    telefone: c.telefone || '',
                    email: c.email || ''
                }));
                renderizarTagsDeContato(); // Desenha as tags dos contatos na tela
            }
            
            // 5. Ajusta o toggle e fecha o modal
            toggleSalvarCliente.checked = false;
            fecharModalDeClientes();
        } catch (e) {
            console.error("Erro ao selecionar cliente:", e);
            alert(e.message);
        }
    }


    async function abrirModalDeClientes() {
        modalClientes.classList.remove('hidden');
        modalClientesBox.classList.remove('-translate-y-10', 'opacity-0');
        
        listaClientesModal.innerHTML = '<p class="p-4 text-center text-gray-500">Carregando...</p>';
        try {
            const response = await fetch('/api/clientes/');
            if (!response.ok) throw new Error('Falha ao carregar clientes');
            
            const clientes = await response.json();
            listaClientesModal.innerHTML = '';
            
            if (clientes.length === 0) {
                listaClientesModal.innerHTML = '<p class="p-4 text-center text-gray-400">Nenhum cliente salvo.</p>';
                return;
            }
            
            clientes.forEach(cliente => {
                const clienteDiv = document.createElement('div');
                clienteDiv.className = 'p-3 flex justify-between items-center rounded-lg hover:bg-gray-100 cursor-pointer border-b last:border-b-0';
                
                clienteDiv.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-800">${cliente.nome}</span>
                        <span class="text-sm text-gray-500">${cliente.telefone || ''}</span>
                    </div>
                    <button type="button" class="p-2 rounded-full text-gray-400 hover:bg-red-100 hover:text-red-600" title="Excluir ${cliente.nome}">
                        <svg class="size-4 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M5 3.25V4H2.75a.75.75 0 0 0 0 1.5h.3l.815 8.15A1.5 1.5 0 0 0 5.357 15h5.285a1.5 1.5 0 0 0 1.493-1.35l.815-8.15h.3a.75.75 0 0 0 0-1.5H11v-.75A2.25 2.25 0 0 0 8.75 1h-1.5A2.25 2.25 0 0 0 5 3.25Zm2.25-.75a.75.75 0 0 0-.75.75V4h3v-.75a.75.75 0 0 0-.75-.75h-1.5ZM6.05 6a.75.75 0 0 1 .787.71l.5 5a.75.75 0 1 1-1.474.14l-.5-5A.75.75 0 0 1 6.05 6Zm3.9 0a.75.75 0 0 1 .71.787l-.5 5a.75.75 0 1 1-1.474-.14l.5-5a.75.75 0 0 1 .764-.647Z" clip-rule="evenodd" /></svg>
                    </button>
                `;
                
                clienteDiv.onclick = () => selecionarCliente(cliente.id);
                clienteDiv.querySelector('button').onclick = (e) => { 
                    e.stopPropagation();
                    deletarCliente(cliente.id, clienteDiv);
                };
                listaClientesModal.appendChild(clienteDiv);
            });
        } catch (error) {
            listaClientesModal.innerHTML = `<p class="p-4 text-center text-red-500">${error.message}</p>`;
        }
    }
    
    // Configura o filtro para funcionar
    filtroClienteInput.addEventListener('input', e => {
        const filtro = e.target.value.toLowerCase();
        listaClientesModal.querySelectorAll('.p-3').forEach(linha => {
            const nome = linha.querySelector('span.font-semibold').textContent.toLowerCase();
            linha.style.display = nome.includes(filtro) ? 'flex' : 'none';
        });
    });

    function exibirAviso(status, mensagem) {
        if (status === 'warning') {
            avisoHeader.innerHTML = `
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                </div>
                <h3 class="mt-4 text-lg font-semibold text-gray-900">Atenção!</h3>`;
        } else if (status === 'blocked') {
            avisoHeader.innerHTML = `
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                </div>
                <h3 class="mt-4 text-lg font-semibold text-gray-900">Acesso Bloqueado</h3>`;
        }
        
        avisoMensagem.textContent = mensagem;
        
        modalAviso.classList.remove('hidden');
        setTimeout(() => { modalAvisoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
    }

    function fecharAviso() {
        modalAvisoBox.classList.add('-translate-y-10', 'opacity-0');
        setTimeout(() => { modalAviso.classList.add('hidden'); }, 300);
    }

    async function handleFormSubmit(event) {
        event.preventDefault();
        if (itens.length === 0) {
            alert("Adicione pelo menos um item ao orçamento.");
            return;
        }
        document.getElementById("hiddenItens").value = JSON.stringify(itens);
        document.getElementById("hiddenContatos").value = JSON.stringify(contatosExtras.filter(c => c.nome && c.telefone));

        const formData = new FormData(form);
        const submitButton = document.getElementById('gerarOrcamentoBtn');
        submitButton.disabled = true;
        submitButton.textContent = 'Salvando...';
        
        try {
            const response = await fetch('/salvar-orcamento/', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (!response.ok) {
                exibirAviso('blocked', result.detail || "Você está bloqueado e não pode salvar.");
            } else {
                if (result.status === 'success') {
                    window.location.href = '/orcamentos';
                } else if (result.status === 'warning') {
                    exibirAviso('warning', result.message);
                    // Quando o usuário fechar o aviso, ele será redirecionado
                    btnFecharModalAviso.onclick = () => {
                        fecharAviso();
                        window.location.href = '/orcamentos';
                    };
                }
            }
        } catch (error) {
            console.error('Erro ao enviar formulário:', error);
            alert('Ocorreu um erro inesperado.');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Salvar Orçamento';
        }
    }
    
    function inicializar() {
        itemValorInput.addEventListener("input", formatarMoeda);
        itemValorInput.addEventListener("blur", limparEFormatarMoeda);
        tipoItemSelect.addEventListener("change", updateTipoItemIcon);
        tipoItemSelect.addEventListener("change", atualizarVisibilidadeSeta);
        tipoItemSelect.addEventListener("change", atualizarVisibilidadeNCM);
        document.getElementById("telefone").addEventListener("input", (e) => mascara(e, "(##) #####-####"));
        document.getElementById("cep").addEventListener("input", (e) => mascara(e, "#####-###"));
        document.getElementById("cep").addEventListener("blur", consultarCep);
        adicionarItemBtn.addEventListener("click", adicionarItem);
        btnAdicionarContato.addEventListener("click", abrirModalContato);
        btnFecharModalContato.addEventListener('click', fecharModalContato);
        btnSalvarContatoModal.addEventListener('click', salvarContatoDoModal);
        nomeInput.addEventListener("blur", handleVerificacaoCliente);
        btnAbrirModalPagamento.addEventListener('click', abrirModalPagamento);
        btnFecharModalPagamento.addEventListener('click', fecharModalPagamento);
        btnAddParcela.addEventListener('click', adicionarParcela);
        btnSalvarGrupo.addEventListener('click', salvarGrupoAtual); // <<< Adiciona o evento para o novo botão
        btnSalvarPagamento.addEventListener('click', salvarPagamento);
        pagamentoValorInput.addEventListener('input', formatarMoeda); // Esta é para o valor da parcela
        pagamentoDescontoParcelaInput.addEventListener('input', formatarMoeda);
        btnFecharModalAviso.addEventListener('click', fecharAviso);
        
        pagamentoDescricaoSelect.addEventListener('change', () => {
            if (pagamentoDescricaoSelect.value === 'outro') {
                pagamentoDescricaoInputOutro.classList.remove('hidden');
                pagamentoDescricaoInputOutro.focus();
            } else {
                pagamentoDescricaoInputOutro.classList.add('hidden');
            }
        }); 
        
        modalPagamento.addEventListener('click', (event) => {
            if (event.target === modalPagamento) {
                fecharModalPagamento();
            }
        }); 

        btnAbrirModalClientes.addEventListener('click', abrirModalDeClientes);
        btnFecharModalClientes.addEventListener('click', fecharModalDeClientes);
        btnAbrirModalInfo.addEventListener('click', abrirModalInfo);
        btnFecharModalInfo.addEventListener('click', fecharModalInfo);
        btnSalvarInfo.addEventListener('click', salvarInfoModal);
        btnFecharModalCatalogo.addEventListener('click', fecharModalCatalogo);
        modalCatalogo.addEventListener('click', (event) => { if (event.target === modalCatalogo) fecharModalCatalogo(); });
        filtroCatalogoInput.addEventListener('input', (e) => {
            const tipoAtual = modalCatalogo.dataset.tipoAtual;
            popularListaModalCatalogo(tipoAtual, e.target.value);
        });    

        modalInfo.addEventListener('click', (event) => {
            if (event.target === modalInfo) {
                fecharModalInfo();
            }
        });

        nomeInput.addEventListener('input', () => {
            clienteIdInput.value = '';
            toggleSalvarCliente.checked = true;
        });
        
        preencherNumeroSugerido();
        carregarCatalogosAPI();
        updateTableVisibility();
        updateTipoItemIcon();
        atualizarVisibilidadeSeta();
        atualizarVisibilidadeNCM();

        const fechamentoBloco = document.getElementById('fechamento-bloco');
        if (fechamentoBloco) { // Só executa se o bloco realmente existir na página
            // helpers
            const toNumberBR = v => Number(String(v).replace(/\./g,'').replace(',','.')) || 0;
            const toBR = n => n.toLocaleString('pt-BR',{minimumFractionDigits:2});
            const moneyFields = ['fn-valor-nota','fn-outros','fn-outras-despesas'].map(id=>document.getElementById(id));
            function maskMoney(el){ el.addEventListener('input', () => {
                const raw = el.value.replace(/[^\d,]/g,'');
                const parts = raw.split(',');
                let int = parts[0].replace(/\D/g,'');
                if(!int) { el.value=''; return; }
                int = int.replace(/^0+(?=\d)/,'');
                const formatted = (int.length>2? int.slice(0,-2)+','+int.slice(-2): int);
                el.value = formatted;
            });}
            moneyFields.forEach(el => el && maskMoney(el));

            // Atalho para elementos
            const $ = id => document.getElementById(id);

            // presets
            function applyPreset() {
                const regime = $('fn-preset').value;
                const map = { iss:0, inss:0, irrf:0, pis:0, cofins:0, csll:0 };
                if (regime==='simples') map.iss = 3;
                if (regime==='presumido'){ map.iss=5; map.pis=0.65; map.cofins=3; map.csll=1; }
                ['iss','inss','irrf','pis','cofins','csll'].forEach(k => $('fn-'+k).value = map[k] || 0);
                calcularFechamento();
            }

            // Lê a tabela (usando a variável 'itens' global que já existe)
            function lerTotaisPorTipo(){
                let mo=0, mat=0;
                // AQUI ESTÁ A CORREÇÃO PRINCIPAL: USAR A VARIÁVEL 'itens' JÁ EXISTENTE
                itens.forEach(item => {
                    const total = item.quantidade * item.valor;
                    if (item.tipo === 'servico') mo += total;
                    if (item.tipo === 'material') mat += total;
                });
                return {mo, mat};
            }

            function calcularFechamento(){
                const bruto = toNumberBR($('fn-valor-nota').value);
                const outrosImpostos = toNumberBR($('fn-outros').value);
                const perc = ['iss','inss','irrf','pis','cofins','csll'].map(k => Number($('fn-'+k).value||0)).reduce((a,b)=>a+b,0);
                const impostosTotal = bruto * (perc/100) + outrosImpostos;
                const liquido = Math.max(0, bruto - impostosTotal);

                const {mo, mat} = lerTotaisPorTipo();
                const outras = toNumberBR($('fn-outras-despesas').value);
                const custos = mo + mat + outras;

                const lucro = liquido - custos;
                const dizimo = lucro > 0 ? lucro * 0.10 : 0;
                const lucroFinal = lucro - dizimo;

                $('fn-res-impostos').textContent = 'R$ ' + toBR(impostosTotal);
                $('fn-res-liquido').textContent  = 'R$ ' + toBR(liquido);
                $('fn-res-mo').textContent       = 'R$ ' + toBR(mo);
                $('fn-res-mat').textContent      = 'R$ ' + toBR(mat);
                $('fn-res-outras').textContent   = 'R$ ' + toBR(outras);
                $('fn-res-lucro').textContent    = 'R$ ' + toBR(lucro);
                $('fn-res-dizimo').textContent   = 'R$ ' + toBR(dizimo);
                $('fn-res-lucro-final').textContent = 'R$ ' + toBR(lucroFinal);

                const payload = { bruto, impostosTotal, liquido, mo, mat, outras, custos, lucro, dizimo, lucroFinal,
                                aliquotas:{iss:Number($('fn-iss').value||0),inss:Number($('fn-inss').value||0),irrf:Number($('fn-irrf').value||0),pis:Number($('fn-pis').value||0),cofins:Number($('fn-cofins').value||0),csll:Number($('fn-csll').value||0)}, outrosImpostos };
                $('fechamento_json').value = JSON.stringify(payload);
            }

            // Adiciona listeners aos inputs do bloco de fechamento
            ['fn-valor-nota','fn-iss','fn-inss','fn-irrf','fn-pis','fn-cofins','fn-csll','fn-outros','fn-outras-despesas']
                .forEach(id => $(id).addEventListener('input', calcularFechamento));
            $('fn-preset').addEventListener('change', applyPreset);
            
            // CORREÇÃO: Observa a variável 'itens' em vez da DOM diretamente
            // Nós chamaremos 'calcularFechamento' manualmente quando a lista 'itens' for modificada
            
            applyPreset();
            calcularFechamento();

            // Expõe a função para ser chamada de fora
            window.recalcularFechamento = calcularFechamento;
        } 


    }

    async function preencherNumeroSugerido() {
        try {
            const response = await fetch('/api/proximo-numero/');
            if (!response.ok) {
                console.error('Falha ao buscar próximo número.');
                document.getElementById('numero_orcamento').value = "0001"; // Fallback
                return;
            }
            const data = await response.json();
            document.getElementById('numero_orcamento').value = data.proximo_numero;
        } catch (error) {
            console.error("Erro ao buscar próximo número:", error);
            document.getElementById('numero_orcamento').placeholder = "Erro"; 
        }
    }

    inicializar();

    form.addEventListener("submit", handleFormSubmit);
    tippy('[data-tippy-content]');


});


</script>

</body>
</html>