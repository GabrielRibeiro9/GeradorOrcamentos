<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Meus Orçamentos</title>
  <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
    <link rel="shortcut icon" href="/static/icons/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- HEADER -->
  <header class="bg-gradient-to-r from-emerald-500 to-teal-600 shadow-lg px-4 sm:px-6 py-3 flex items-center justify-between text-white sticky top-0 z-50">
    <div class="flex items-center gap-3 min-w-0">
      <div class="w-10 h-10 rounded-full bg-white/20 ring-2 ring-white/50 flex items-center justify-center text-white font-bold text-xl shadow-md flex-shrink-0">
        {{ user.username[0]|upper }}
      </div>
      <span class="font-semibold text-base sm:text-lg truncate">
        Olá, <span class="font-bold">{{ user.username }}</span>
      </span>
    </div>
    <h1 class="hidden sm:block text-white font-bold text-xl sm:text-2xl text-center flex-1 mx-4">
        Meus Orçamentos
    </h1>
    <div class="flex items-center gap-2">
        <a href="/" data-tippy-content="Criar um novo orçamento do zero" class="flex items-center gap-2 px-4 py-2 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20 font-semibold text-sm sm:text-base whitespace-nowrap">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
            <span class="hidden sm:inline">Novo Orçamento</span>
        </a>
        <button onclick="abrirModalConfig()" data-tippy-content="Acessar configurações do sistema e gerenciamento" class="flex items-center justify-center h-10 w-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-lg shadow-sm transition-all duration-200 border border-white/20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        </button>
    </div>
  </header>

  <!-- CONTAINER PRINCIPAL -->
  <main class="max-w-4xl mx-auto mt-8 px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between mb-4 mt-2">
      <h2 class="text-xl font-semibold text-gray-800">Últimos Orçamentos</h2>
      <button onclick="carregarOrcamentos()" data-tippy-content="Recarregar a lista de orçamentos do servidor" class="flex items-center gap-2 bg-emerald-600 text-white rounded-lg px-4 py-2 hover:bg-emerald-700 transition-all text-sm font-semibold shadow-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
        Atualizar
      </button>
    </div>
    <div id="lista" class="space-y-3"></div>
  </main>

  <!-- MODAL DE CONFIGURAÇÕES -->
  <div id="modal-config" class="fixed inset-0 bg-opacity-0 hidden z-50 transition-opacity duration-300 ease-in-out">
       <div id="sidebar-panel" class="absolute top-0 right-0 h-full w-full max-w-sm bg-white shadow-xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
          <div class="flex items-center justify-between p-4 border-b bg-gray-50 flex-shrink-0">
              <h3 id="sidebar-title" class="text-xl font-semibold text-gray-800">Configurações</h3>
              <button onclick="fecharModalConfig()" class="text-gray-500 hover:text-gray-800 p-1 rounded-full transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
          </div>
          <div id="sidebar-content" class="overflow-y-auto flex-grow">
              <div id="config-menu" class="p-4">
                <ul class="space-y-2">
                  <li>
                    <a href="#" data-target="panel-reset-counter" class="sidebar-link group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors">
                      <span class="font-medium text-gray-700">Reiniciar Contagem</span>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  </li>
                  <li>
                    <a href="#" data-target="panel-manage-clients" class="sidebar-link group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-medium text-gray-700">Gerenciar Clientes</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                      </svg>
                    </a>
                  </li>

                  {% if user.username == admin_username_from_env %}
                  <li>
                     <a href="#" data-target="panel-change-template" class="sidebar-link group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors">
                          <span class="font-medium text-gray-700">Mudar Modelo de PDF</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                          </svg>  
                      </a>
                  </li>
                  <li>
                    <a href="#" data-target="panel-add-user" class="sidebar-link group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-medium text-gray-700">Cadastrar Novo Usuário</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                  </li>
                  <li>
                    <a href="#" data-target="panel-manage-users" class="sidebar-link group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-medium text-gray-700">Gerenciar Usuários</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                  </li>
                  <li>
                    <a href="#" data-target="panel-access-control" class="sidebar-link group flex items-center justify-between p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <span class="font-medium text-gray-700">Controle de Acesso</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 group-hover:text-gray-600 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                        </svg>
                    </a>
                  </li>
                  {% endif %}
                </ul>
              </div>
              <div id="panel-reset-counter" class="config-panel hidden">
                <div class="flex items-center gap-2 p-4 border-b">
                  <button class="back-to-menu p-1 text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                      </svg>
                  </button>    
                  <h4 class="text-lg font-semibold text-gray-800">Reiniciar Contagem</h4>
                </div>
                <div class="p-6 space-y-4">
                  <p class="text-sm text-gray-600">Para definir a próxima numeração, digite qual será o **próximo** número. Ex: Se digitar '51', o próximo orçamento criado será o Nº 0051.</p>
                    <label for="novo_numero_inicial" class="text-sm font-medium text-gray-700 whitespace-nowrap">Último Nº gerado:</label>
                  <div class="flex items-center gap-3">  
                    <label for="novo_numero_inicial" class="text-sm font-medium text-gray-700 whitespace-nowrap">Iniciar em:</label>
                    <input type="number" id="novo_numero_inicial" value="0" class="w-full h-10 text-center font-semibold border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400">
                  </div>  
                  <button onclick="resetarContador()" class="w-full h-10 px-4 bg-orange-500 text-white font-semibold rounded-lg shadow hover:bg-orange-600 transition">Resetar Contagem</button>
                </div>  
              </div>
              <div id="panel-change-template" class="config-panel hidden">
                <div class="flex items-center gap-2 p-4 border-b">
                  <button class="back-to-menu p-1 text-gray-500 hover:text-gray-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                  </button>
                  <h4 class="text-lg font-semibold text-gray-800">Mudar Modelo de PDF</h4>
                </div>
                <div class="p-6 space-y-4">
                  <p class="text-sm text-gray-600">Como administrador, você pode definir qual modelo de PDF será usado para gerar seus documentos.</p>
                  <div class="space-y-2">
                    <label for="admin-template-select" class="block text-sm font-medium text-gray-700">Seu modelo atual:</label>
                    <select id="admin-template-select" class="w-full h-10 px-3 border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400">
                      {% for key, name in pdf_templates.items() %}
                        <option value="{{ key }}" {% if key == user.pdf_template_name %}selected{% endif %}>Modelo {{ name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <button onclick="atualizarModeloPDF()" class="w-full h-10 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition">Aplicar Novo Modelo</button>
                </div>
              </div>
              <div id="panel-add-user" class="config-panel hidden">
                <div class="flex items-center gap-2 p-4 border-b">
                    <button class="back-to-menu p-1 text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                    <h4 class="text-lg font-semibold text-gray-800">Cadastrar Novo Usuário</h4>
                </div>
                <div class="p-6 space-y-4">
                    <div class="space-y-3">
                        <div>
                            <label for="new-username" class="text-sm font-medium text-gray-700">Nome de Usuário:</label>
                            <input type="text" id="new-username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label for="new-password" class="text-sm font-medium text-gray-700">Senha:</label>
                            <input type="password" id="new-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                          <label for="new-template" class="text-sm font-medium text-gray-700">Modelo de PDF Padrão:</label>
                          <select id="new-template" class="mt-1 block w-full h-10 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                              {% for key, name in pdf_templates.items() %}
                                <option value="{{ key }}">Modelo {{ name }}</option>
                              {% endfor %}
                          </select>
                        </div>
                        <button onclick="cadastrarNovoUsuario()" class="w-full h-10 px-4 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition !mt-6">Cadastrar Usuário</button>
                    </div>
                </div>
              </div>
              <div id="panel-manage-users" class="config-panel hidden">
                <div class="flex items-center gap-2 p-4 border-b">
                    <button class="back-to-menu p-1 text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                    <h4 class="text-lg font-semibold text-gray-800">Gerenciar Usuários</h4>
                </div>
                <div class="p-6 space-y-4">
                    <p class="text-sm text-gray-600">Abaixo estão listados todos os usuários cadastrados no sistema. Lembre-se que apagar um usuário é uma ação permanente e irreversível.</p>
                    <div id="lista-usuarios" class="mt-2 space-y-2 max-h-60 overflow-y-auto border-t border-b py-2"><p class="text-gray-500 text-sm">Carregando usuários...</p></div>
                </div>
              </div>  
              <div id="panel-manage-clients" class="config-panel hidden">
                <div class="flex items-center gap-2 p-4 border-b">
                    <button class="back-to-menu p-1 text-gray-500 hover:text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg></button>
                    <h4 class="text-lg font-semibold text-gray-800">Gerenciar Clientes</h4>
                </div>
                <div class="p-4">
                    <div class="relative mb-4">
                        <input type="text" id="client-search-input" placeholder="Buscar cliente por nome..." class="w-full h-10 pl-10 pr-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-400">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <div id="client-list-container" class="space-y-3 max-h-[calc(100vh-200px)] overflow-y-auto pr-2"><p class="text-gray-500 text-center py-4">Carregando clientes...</p></div>
                </div>
              </div> <!-- FIM DO PAINEL GERENCIAR CLIENTES -->

              <!-- ESTRUTURA CORRETA: O painel de acesso fica DEPOIS do painel de clientes -->
              <div id="panel-access-control" class="config-panel hidden">
                  <div class="flex items-center gap-2 p-4 border-b">
                      <button class="back-to-menu p-1 text-gray-500 hover:text-gray-800">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                      </button>
                      <h4 class="text-lg font-semibold text-gray-800">Controle de Acesso de Usuários</h4>
                  </div>
                  <div class="p-6 space-y-4">
                      <div>
                          <label for="access-control-user-select" class="block text-sm font-medium text-gray-700">Selecione o Usuário</label>
                          <select id="access-control-user-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm rounded-md">
                              <option>Carregando...</option>
                          </select>
                      </div>
                      <div id="user-status-details" class="hidden p-4 bg-gray-100 rounded-lg border border-gray-200 space-y-2 text-sm">
                          <p class="font-semibold text-gray-800">Status Atual do Usuário</p>
                          <p><strong>Acesso:</strong> <span id="status-acesso" class="font-mono p-1 bg-gray-200 rounded text-xs">--</span></p>
                      </div>
                      <div id="user-access-actions" class="hidden border-t pt-4 space-y-3">
                        <h5 class="font-semibold text-gray-700">Gerenciar Acesso</h5>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="concederAcessoVitalicio()" class="w-full px-3 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-emerald-700 transition">Acesso Vitalício</button>
                            <button onclick="concederAcessoMensal()" class="w-full px-3 py-2 bg-sky-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-sky-700 transition">Liberar 30 Dias</button>
                        </div>
                        <button onclick="reverterParaPadrao()" class="w-full px-3 py-2 bg-gray-500 text-white text-sm font-semibold rounded-lg shadow hover:bg-gray-600 transition">Bloquear</button>
                        
                        <!-- === BLOCO ADICIONADO ABAIXO === -->
                        <h5 class="font-semibold text-gray-700 pt-3 border-t mt-4">Definir Data de Expiração Manual</h5>
                        <div class="flex items-center gap-2">
                          <input type="date" id="custom-date-input" class="w-full h-10 px-3 border border-zinc-300 rounded-md shadow-sm focus:outline-zinc-400">
                          <button onclick="definirDataPersonalizada()" class="h-10 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition whitespace-nowrap">Definir Data</button>
                        </div>
                      </div>
                  </div>
              </div>

          </div> <!-- FECHA #sidebar-content -->
       </div> <!-- FECHA #sidebar-panel -->
  </div> <!-- FECHA #modal-config -->

  <div id="modal-email" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
    <div id="modal-email-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300">
        <div class="flex items-center justify-between pb-3 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Enviar Orçamento por E-mail</h3>
            <button onclick="fecharModalEmail()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
        </div>
        <div class="mt-4 space-y-4">
            <p class="text-sm"> Selecione ou adicione os destinatários para o envio: <strong id="email-cliente-nome"></strong></p>
            <div class="relative">
              <input type="email" id="email-manual-input" placeholder="Ou digite um novo e-mail aqui" class="h-10 w-full rounded-md border border-gray-300 bg-gray-50 px-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div id="lista-contatos-email" class="space-y-2 border-t border-b py-3 max-h-48 overflow-y-auto"></div>
            <input type="hidden" id="email-orcamento-id">
            <input type="hidden" id="email-tipo-documento">
            <button id="btn-enviar-email-final" class="w-full h-10 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" /></svg>
              Enviar para Selecionados
            </button>
        </div>
    </div>
  </div>

  <div id="modal-status-pdf" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
    <div id="modal-status-pdf-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300">
        <div class="text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h3 class="mt-4 text-lg leading-6 font-medium text-gray-900">Tipo de Documento</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">O serviço deste documento já foi realizado? Escolha o tipo de documento que deseja gerar.</p>
            </div>
        </div>
        <div class="mt-5 sm:mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <button id="btn-gerar-orcamento" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700">Gerar Orçamento</button>
            <button id="btn-gerar-nota" type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">Gerar Nota de Serviço</button>
        </div>
        <input type="hidden" id="pdf-orcamento-id">
    </div>
  </div>

  <div id="modal-whatsapp" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
    <div id="modal-whatsapp-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md transform transition-all -translate-y-10 opacity-0 duration-300">
        <div class="flex items-center justify-between pb-3 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Enviar por WhatsApp</h3>
            <button onclick="fecharModalWhatsApp()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">×</button>
        </div>
        <div class="mt-4 space-y-4">
            <p class="text-sm">Selecione ou adicione os contatos para enviar:</p>
            <div class="relative">
              <input type="tel" id="whatsapp-manual-input" oninput="mascara(event, '(##) #####-####')" maxlength="15" placeholder="Ou digite um novo número aqui" class="h-10 w-full rounded-md border border-gray-300 bg-gray-50 px-3 text-base focus:outline-none focus:ring-2 focus:ring-emerald-400">
            </div>
            <div id="lista-contatos-whatsapp" class="space-y-2 border-t border-b py-3 max-h-48 overflow-y-auto"></div>
            <input type="hidden" id="whatsapp-orcamento-id">
            <button id="btn-enviar-whatsapp-final" class="w-full h-10 px-4 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.789 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                Enviar para Selecionados
            </button>
        </div>
    </div>
  </div>

  <div id="modal-tipo-documento" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[60]">
    <div id="modal-tipo-documento-box" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm mx-4 transform transition-all -translate-y-10 opacity-0 duration-300">
        <h3 class="text-lg font-medium text-gray-900 text-center">Qual documento deseja enviar?</h3>
        <div class="mt-4 space-y-3">
            <p class="text-sm text-center text-gray-500">Selecione o tipo de documento que será gerado para o compartilhamento.</p>
            <div class="pt-2">
                <label class="flex items-center p-3 w-full bg-white border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo_documento_escolha" value="Orçamento" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>
                    <span class="ml-3 text-sm font-medium text-gray-800">Enviar como Orçamento</span>
                </label>
            </div>
            <div>
                <label class="flex items-center p-3 w-full bg-white border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                    <input type="radio" name="tipo_documento_escolha" value="Nota de Serviço" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                    <span class="ml-3 text-sm font-medium text-gray-800">Enviar como Nota de Serviço</span>
                </label>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button type="button" class="btn-fechar-modal-tipo-documento px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
            <button type="button" id="btn-confirmar-tipo-documento" class="px-4 py-2 bg-emerald-600 text-white font-semibold rounded-md hover:bg-emerald-700">Confirmar</button>
        </div>
        <input type="hidden" id="tipo-documento-orcamento-id">
    </div>
  </div>

  <div id="modal-edit-client" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
    <div id="modal-edit-client-box" class="bg-gray-50 rounded-xl shadow-2xl w-full sm:max-w-2xl transform transition-all -translate-y-10 opacity-0 duration-300 flex flex-col max-h-[90vh] sm:max-h-[95vh]">
        <div class="flex items-center justify-between p-4 border-b bg-white rounded-t-xl">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></div>
                <h3 class="text-xl font-semibold text-gray-800">Editar Cliente</h3>
            </div>
            <button onclick="fecharModalEditarCliente()" class="text-gray-400 hover:text-gray-600 text-3xl">×</button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
            <div class="bg-white p-4 rounded-lg border shadow-sm">
                <h4 class="font-semibold text-gray-700 mb-3">Informações Principais</h4>
                <div class="grid grid-cols-1 gap-4">
                    <input type="hidden" id="edit-cliente-id">
                    <div>
                        <label for="edit-cliente-nome" class="text-sm font-medium text-gray-600">Nome do Cliente / Empresa</label>
                        <input type="text" id="edit-cliente-nome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="edit-cliente-telefone" class="text-sm font-medium text-gray-600">Telefone Principal</label>
                        <input type="text" id="edit-cliente-telefone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500" oninput="mascara(event, '(##) #####-####')" maxlength="15">
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg border shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-gray-700">Contatos Adicionais</h4>
                    <button onclick="adicionarNovoContatoForm()" class="px-3 py-1 bg-emerald-600 text-white text-sm font-semibold rounded-md hover:bg-emerald-700 flex items-center gap-1">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        Adicionar
                    </button>
                </div>
                <div id="contatos-container" class="space-y-3">
                    <p id="sem-contatos-msg" class="text-gray-400 text-sm text-center py-4">Nenhum contato adicional.</p>
                </div>
            </div>
        </div>
        <div class="flex items-center justify-end gap-3 p-4 border-t bg-gray-100 rounded-b-xl">
            <div class="grid grid-cols-2 gap-3 w-full sm:w-auto">
                <button onclick="fecharModalEditarCliente()" class="px-5 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors justify-center">Cancelar</button>
                <button onclick="salvarClienteAtualizado()" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                    <svg id="save-icon" class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6.293a2 2 0 011.414.586l2.828 2.828A2 2 0 0118 6.707V16a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V5a1 1 0 00-1-1H8z" /></svg>
                    <div id="save-spinner" class="hidden h-5 w-5 border-2 border-t-blue-200 border-white rounded-full animate-spin"></div>
                    <span>Salvar Alterações</span>
                </button>
            </div>
        </div>
    </div>
  </div>

  <template id="contato-form-template">
      <div class="grid grid-cols-1 sm:grid-cols-6 gap-3 p-3 border rounded-md bg-gray-50/50 relative contact-form-row">
          <div class="sm:col-span-2">
              <input type="text" placeholder="Nome do Contato" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 contato-nome">
          </div>
          <div class="sm:col-span-2">
              <input type="text" placeholder="Telefone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 contato-telefone" oninput="mascara(event, '(##) #####-####')" maxlength="15">
          </div>
          <div class="sm:col-span-2">
              <input type="email" placeholder="E-mail (opcional)" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 contato-email">
          </div>
          <button onclick="this.closest('.contact-form-row').remove()" class="absolute -top-2 -right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600" title="Remover Contato">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>
          </button>
      </div>
  </template>

  <template id="despesa-dinamica-template">
    <div class="flex items-center gap-2 despesa-dinamica-row">
        <input type="text" placeholder="Descrição (ex: Deslocamento)" class="despesa-descricao w-2/3 px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-400">
        <input type="text" inputmode="decimal" placeholder="R$ 0,00" class="despesa-valor w-1/3 px-2 py-1.5 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-400 text-right">
        <button type="button" onclick="removerLinhaDespesa(this)" class="p-1 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full" title="Remover Despesa">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
        </button>
    </div>
  </template>

  <div id="modal-analise-custo" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div id="modal-analise-custo-box" class="bg-gray-50 rounded-xl shadow-2xl w-full max-w-2xl transform transition-all -translate-y-10 opacity-0 duration-300 flex flex-col max-h-[90vh]">
        
        <!-- Cabeçalho -->
        <div class="flex items-center justify-between p-4 border-b bg-white rounded-t-xl sticky top-0 z-10">
            <div class="flex items-center gap-3 min-w-0">
                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                </div>
                <div class="min-w-0">
                    <h3 class="text-lg font-semibold text-gray-800 truncate">Análise de Lucratividade</h3>
                    <p id="analise-custo-titulo-orcamento" class="text-sm text-gray-500">Orçamento #0000</p>
                </div>
            </div>
            <button onclick="fecharModalAnaliseCusto()" class="text-gray-400 hover:text-gray-600 text-3xl flex-shrink-0 ml-4">×</button>
            <input type="hidden" id="analise-custo-orcamento-id">
        </div>

        <!-- Novo corpo do modal com seções claras -->
          <div class="p-4 sm:p-6 space-y-6 overflow-y-auto overscroll-contain">
            <!-- Seção de Entradas do Usuário -->
            <div class="space-y-4">

                <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM10 8c0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267v-1.7c.22.07.409.164.567.267C9.93 7.66 10 7.886 10 8z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v1.077a4.602 4.602 0 00-1.74.885c-.41.254-.74.634-.908 1.1a1 1 0 101.817.81c.046-.1.1-.184.17-.253a2.305 2.305 0 011.66- .594V11a1 1 0 102 0v-1.077a4.602 4.602 0 001.74-.885c.41-.254.74-.634.908-1.1a1 1 0 10-1.817-.81c-.046.1-.1.184-.17.253a2.305 2.305 0 01-1.66.594V5z" clip-rule="evenodd" /></svg>
                        Receita Bruta do Orçamento
                      <span class="ml-auto" data-tippy-content="Este é o valor total do orçamento, servindo como ponto de partida para a análise de custos.">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-gray-600 cursor-help" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                          </svg>
                      </span>
                    </h4>
                    <input type="text" id="ac-valor-obra" readonly class="analise-custo-input mt-1 w-full p-3 text-lg font-bold border border-gray-200 bg-gray-100 rounded-md shadow-inner" placeholder="R$ 0,00">
                </div>

                <!-- Card 2: Todas as Deduções e Custos -->
                <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                        Deduções & Custos da Obra
                    </h4>
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label for="ac-mao-de-obra" class="text-sm font-medium text-gray-600 flex items-center">
                              Custo Mão de Obra (R$)
                              <span class="ml-1" data-tippy-content="Insira o custo real pago pela mão de obra, não o valor cobrado no orçamento.">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-gray-600 cursor-help" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                              </span>
                            </label>
                            <input type="text" id="ac-mao-de-obra" inputmode="decimal" class="analise-custo-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="R$ 0,00">
                        </div>
                        <div>
                            <label for="ac-materiais" class="text-sm font-medium text-gray-600">Custo Materiais (R$)</label>
                            <input type="text" id="ac-materiais" inputmode="decimal" class="analise-custo-input mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="R$ 0,00">
                        </div>
                        <div>
                            <label for="ac-imposto-servico" class="text-sm font-medium text-gray-600">Imposto Serviço (%)</label>
                        <input type="text" id="ac-imposto-servico" inputmode="decimal" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="0,00 %">
                    </div>
                    <div>
                        <label for="ac-imposto-material" class="text-sm font-medium text-gray-600">Imposto Material (%)</label>
                        <input type="text" id="ac-imposto-material" inputmode="decimal" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="0,00 %">
                        </div>
                        <div class="sm:col-span-2 space-y-2" id="dynamic-expenses-area">
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-gray-600">Outras Despesas</label>
                                <button type="button" onclick="adicionarLinhaDespesa()" class="px-2 py-1 text-xs font-semibold text-white bg-indigo-500 rounded-md hover:bg-indigo-600 flex items-center gap-1">
                                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                                    Adicionar
                                </button>
                            </div>
                            <div id="despesas-dinamicas-container" class="space-y-2 border-t pt-2">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Seção de Resultados (Calculados) -->
            <div class="space-y-3">
                <h4 class="font-semibold text-gray-700 pt-4 border-t">Resultado da Análise</h4>

                <!-- Custo Total -->
                <div class="flex justify-between items-center text-sm p-3 bg-white rounded-md border">
                    <span class="font-medium text-gray-600 flex items-center">
                      Soma de custos/impostos
                      <span class="ml-1" data-tippy-content="Este é o resultado da soma de todos os campos do card 'Deduções & Custos da Obra'.">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 hover:text-gray-600 cursor-help" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                      </span>
                    </span>
                    <span id="ac-resultado-custo-total" class="font-semibold text-lg text-red-600">R$ 0,00</span>
                </div>

                <!-- Card de Lucro com ID para mudança de cor -->
                <div id="ac-lucro-card" class="p-4 bg-green-600 text-white rounded-lg shadow-lg flex items-center justify-between mt-2 transition-colors duration-300">
                    <span class="font-bold text-xl flex items-center">
                      Lucro Líquido
                      <span class="ml-1" data-tippy-content="Resultado final: Receita Bruta - Soma de todos os custos e impostos.">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white/70 hover:text-white cursor-help" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>
                      </span>
                      :
                    </span>
                    <span id="ac-resultado-lucro" class="font-extrabold text-2xl whitespace-nowrap">R$ 0,00</span>
                </div>
                
                <!-- Card Opcional do Dízimo -->
                <div class="p-3 bg-gray-100 rounded-lg flex items-center justify-between border">
                    <span class="text-sm font-medium text-gray-800">Valor Sugerido para Dízimo (10%)</span>
                    <span id="ac-resultado-dizimo" class="font-bold text-lg text-gray-700">R$ 0,00</span>
                </div>
            </div>

        <!-- Rodapé com Botões -->
        <div class="flex flex-col-reverse sm:flex-row items-center justify-between gap-3 p-4 border-t bg-gray-100 rounded-b-xl sticky bottom-0 z-10">
            <!-- Botão Secundário (Relatório) -->
            <button onclick="gerarRelatorioCusto()" type="button" class="flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" />
                </svg>
                <span>Gerar PDF</span>
            </button>
            
            <!-- Botão Principal (Salvar) -->
            <button id="btn-salvar-analise" onclick="salvarAnaliseCusto()" type="button" class="flex items-center justify-center gap-2 w-full sm:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 shadow-md transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <svg id="btn-salvar-analise-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5 4a2 2 0 012-2h6.293a2 2 0 011.414.586l2.828 2.828A2 2 0 0118 6.707V16a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V5a1 1 0 00-1-1H8z" />
              </svg>
              <div id="btn-salvar-analise-spinner" class="hidden h-5 w-5 border-2 border-t-indigo-200 border-white rounded-full animate-spin"></div>
              <span id="btn-salvar-analise-text">Salvar Análise</span>
            </button>
        </div>
    </div>
</div>

<script>
const modalAnaliseCusto = document.getElementById('modal-analise-custo');
const modalAnaliseCustoBox = document.getElementById('modal-analise-custo-box');
let orcamentosCarregados = [];  
const modalEmail = document.getElementById('modal-email');
const modalEmailBox = document.getElementById('modal-email-box');
const sidebarPanel = document.getElementById('sidebar-panel');
const modal = document.getElementById('modal-config');
const modalStatusPdf = document.getElementById('modal-status-pdf');
const modalStatusPdfBox = document.getElementById('modal-status-pdf-box');
const pdfOrcamentoIdInput = document.getElementById('pdf-orcamento-id');
const modalWhatsApp = document.getElementById('modal-whatsapp');
const modalWhatsAppBox = document.getElementById('modal-whatsapp-box');
const whatsappOrcamentoIdInput = document.getElementById('whatsapp-orcamento-id');
const btnEnviarWhatsAppFinal = document.getElementById('btn-enviar-whatsapp-final');
const modalTipoDocumento = document.getElementById('modal-tipo-documento');
const modalTipoDocumentoBox = document.getElementById('modal-tipo-documento-box');
const tipoDocumentoOrcamentoIdInput = document.getElementById('tipo-documento-orcamento-id');
const btnConfirmarTipoDocumento = document.getElementById('btn-confirmar-tipo-documento');
const btnsFecharModalTipoDocumento = document.querySelectorAll('.btn-fechar-modal-tipo-documento');
const modalEditClient = document.getElementById('modal-edit-client');
const modalEditClientBox = document.getElementById('modal-edit-client-box');
const contatosContainer = document.getElementById('contatos-container');
const contatoFormTemplate = document.getElementById('contato-form-template');
const userSelect = document.getElementById('access-control-user-select');
const userStatusDetails = document.getElementById('user-status-details');
const userAccessActions = document.getElementById('user-access-actions');
const statusAcessoEl = document.getElementById('status-acesso');
let analiseJaFoiSalva = false;
let totalServicosBruto = 0;  
let totalMateriaisBruto = 0;

// Funções para Despesas Dinâmicas
window.adicionarLinhaDespesa = function() {
    const template = document.getElementById('despesa-dinamica-template');
    const container = document.getElementById('despesas-dinamicas-container');
    const clone = template.content.cloneNode(true);
    const valorInput = clone.querySelector('.despesa-valor');
    
    // Adiciona os mesmos listeners de formatação e cálculo aos novos inputs
    valorInput.addEventListener('input', () => {
        let value = valorInput.value.replace(/\D/g, "");
        if (value) {
            value = (parseFloat(value) / 100).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            valorInput.value = "R$ " + value;
        } else {
            valorInput.value = '';
        }
        calcularAnaliseCusto(); // Recalcula tudo a cada digitação
    });

    valorInput.addEventListener('blur', () => {
        const numericValue = parseCurrency(valorInput.value);
        valorInput.value = formatCurrency(numericValue);
    });

    // Adiciona o listener para o input de descrição também recalcular
    const descricaoInput = clone.querySelector('.despesa-descricao');
    descricaoInput.addEventListener('input', calcularAnaliseCusto);

    container.appendChild(clone);
}

window.removerLinhaDespesa = function(button) {
    button.closest('.despesa-dinamica-row').remove();
    calcularAnaliseCusto(); // Recalcula tudo após remover uma linha
}

// --- LÓGICA DE CARREGAMENTO DOS ORÇAMENTOS ---
async function carregarOrcamentos() {
    const lista = document.getElementById('lista');
    lista.innerHTML = `<div class="py-8 text-center text-gray-400">Carregando...</div>`;
    try {
        const res = await fetch('/api/orcamentos/');
        if (!res.ok) throw new Error('Falha ao carregar os dados.');
        const orcamentos = await res.json();
        orcamentosCarregados = orcamentos;
        lista.innerHTML = "";
        if (!orcamentos.length) {
            lista.innerHTML = `<div class="py-8 text-center text-gray-400">Nenhum orçamento encontrado.</div>`;
            return;
        }
        orcamentos.forEach(orc => {
          const totalFormatado = parseFloat(orc.total_geral).toLocaleString('pt-BR', { minimumFractionDigits: 2 });

          // Mantemos a lógica para o botão de análise condicional
          const botaoAnalise = `
              {% if user.tem_funcao_analise_custo %}
              <button onclick="abrirModalAnaliseCusto(${orc.id})" title="Análise de Custo da Obra" class="p-2 rounded bg-yellow-400 text-yellow-900 hover:bg-yellow-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M2 3a1 1 0 011-1h14a1 1 0 011 1v1a1 1 0 01-1 1H3a1 1 0 01-1-1V3z" />
                      <path fill-rule="evenodd" d="M3 7h14v9a1 1 0 01-1 1H4a1 1 0 01-1-1V7zm2 2a1 1 0 011 1v4a1 1 0 11-2 0V10a1 1 0 011-1zm5 0a1 1 0 011 1v4a1 1 0 11-2 0V10a1 1 0 011-1zm4 1a1 1 0 10-2 0v4a1 1 0 102 0V11z" clip-rule="evenodd" />
                  </svg>
              </button>
              {% endif %}
          `;

          // ===== NOVO TEMPLATE HTML DO CARD =====
          lista.innerHTML += `
          <div id="orcamento-card-${orc.id}" class="bg-white shadow-md rounded-lg p-3 flex flex-col space-y-2 border border-gray-200">
              
              <!-- 1. LINHA SUPERIOR: Informações do Orçamento -->
              <div class="flex flex-wrap items-baseline gap-x-3 gap-y-1">
                  <span class="font-bold text-lg text-emerald-600">#${String(orc.numero).padStart(4, '0')}</span>
                  <span class="font-semibold text-gray-800 truncate">${orc.nome}</span>
                  <span class="text-xs text-gray-400 whitespace-nowrap">(${orc.data_emissao})</span>
              </div>

              <!-- 2. LINHA DO MEIO: Valor Total (Alinhado à Direita) -->
              <div class="flex justify-start items-baseline mt-1">
                <span class="text-xl font-bold text-emerald-600">R$ ${totalFormatado}</span>
              </div>

              <!-- 3. LINHA INFERIOR: Botões de Ação (Alinhados à Direita) -->
              <div class="flex items-center gap-2 justify-end border-t border-gray-200 mt-2 pt-2">
                  <button onclick="editarOrcamento(${orc.id})" data-tippy-content="Editar este orçamento" class="p-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                  <button onclick="abrirModalStatusPDF(${orc.id})" data-tippy-content="Visualizar ou gerar o PDF" class="p-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg></button>
                  <button onclick="abrirModalTipoDocumento(${orc.id}, 'email')" data-tippy-content="Enviar link do PDF por e-mail" class="p-2 rounded bg-blue-500 text-white hover:bg-blue-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" /></svg></button>
                  
                  ${botaoAnalise.trim().replace('title="Análise de Custo da Obra"', 'data-tippy-content="Analisar custos e lucratividade"')}

                  <button onclick="abrirModalTipoDocumento(${orc.id}, 'whatsapp')" data-tippy-content="Enviar link do PDF por WhatsApp" class="p-2 rounded bg-green-500 text-white hover:bg-green-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.789 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></button>
                  <button onclick="deletarOrcamento(${orc.id})" data-tippy-content="Excluir este orçamento permanentemente" class="p-2 rounded bg-red-500 text-white hover:bg-red-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
              </div>
          </div>
            </div>`;
        });

        tippy('[data-tippy-content]');
    } catch (e) {
        console.error("Erro ao carregar orçamentos:", e);
        lista.innerHTML = `<div class="py-8 text-center text-red-400">Erro ao carregar orçamentos.</div>`;
    }
}

// --- FUNÇÕES GERAIS ---

window.abrirModalAnaliseCusto = async function(orcamentoId) {
    // 1. ANTES DE TUDO: Buscamos os dados mais recentes do orçamento da nossa nova API
    let orcamento;
    try {
        const orcamentoRes = await fetch(`/api/orcamento-detalhes/${orcamentoId}`);
        if (!orcamentoRes.ok) {
            throw new Error('Falha ao buscar detalhes atualizados do orçamento.');
        }
        orcamento = await orcamentoRes.json();
        window.totalServicosBruto = orcamento.total_servicos || 0;
        window.totalMateriaisBruto = orcamento.total_materiais || 0;
    } catch (error) {
        console.error(error);
        alert("Não foi possível carregar os dados atualizados do orçamento. Tente atualizar a página.");
        return;
    }
    
    // Agora que temos os dados FRESCOS, o resto da função continua...

    document.getElementById('analise-custo-orcamento-id').value = orcamentoId;
    document.getElementById('analise-custo-titulo-orcamento').textContent = `Orçamento #${String(orcamento.numero).padStart(4, '0')}`;
    
    // Busca os dados da ANÁLISE (que pode ter sido salva antes)
    try {
      const response = await fetch(`/api/orcamento/${orcamentoId}/analise-custo`);
      if (!response.ok) { throw new Error('Não foi possível carregar a análise salva.'); }
      const dadosSalvos = await response.json();
      
      analiseJaFoiSalva = dadosSalvos.valor_obra_total !== null;
      // Limpa todos os campos antes de preencher
      document.getElementById('ac-mao-de-obra').value = '';
      document.getElementById('ac-materiais').value = '';
      document.getElementById('ac-imposto-servico').value = '';
      document.getElementById('ac-imposto-material').value = '';
      // Limpa o container de despesas antigas
      document.getElementById('despesas-dinamicas-container').innerHTML = '';
      
      // Preenche o VALOR BRUTO com o dado ATUALIZADO
      document.getElementById('ac-valor-obra').value = formatCurrency(orcamento.total_geral);
      
      // --- PREENCHIMENTO DOS CAMPOS DE CUSTO ---

      document.getElementById('ac-mao-de-obra').value = dadosSalvos.custo_mao_de_obra ? formatCurrency(dadosSalvos.custo_mao_de_obra) : '';

      if (dadosSalvos.custo_materiais != null) {
          document.getElementById('ac-materiais').value = formatCurrency(dadosSalvos.custo_materiais);
      } else {
          document.getElementById('ac-materiais').value = formatCurrency(orcamento.total_materiais);
      }

      document.getElementById('ac-imposto-servico').value = dadosSalvos.percentual_imposto_servico ? dadosSalvos.percentual_imposto_servico.toFixed(2).replace('.', ',') + ' %' : '';
      document.getElementById('ac-imposto-material').value = dadosSalvos.percentual_imposto_material ? dadosSalvos.percentual_imposto_material.toFixed(2).replace('.', ',') + ' %' : '';

      // --- LÓGICA DE PREENCHIMENTO DAS DESPESAS EXTRAS (NO LOCAL CORRETO) ---
      if (dadosSalvos.despesas_extras && dadosSalvos.despesas_extras.length > 0) {
          dadosSalvos.despesas_extras.forEach(despesa => {
              adicionarLinhaDespesa(); // Cria uma nova linha em branco
              const container = document.getElementById('despesas-dinamicas-container');
              const novaLinha = container.lastElementChild; // Pega a linha que acabamos de adicionar
              if (novaLinha) {
                  novaLinha.querySelector('.despesa-descricao').value = despesa.descricao;
                  novaLinha.querySelector('.despesa-valor').value = formatCurrency(despesa.valor);
              }
          });
      }
      
      // Abre o modal e calcula os resultados
      calcularAnaliseCusto(); 
      modalAnaliseCusto.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      setTimeout(() => {
          modalAnaliseCustoBox.classList.remove('-translate-y-10', 'opacity-0');
          document.getElementById('ac-mao-de-obra').focus();
      }, 50);

    } catch (error) {
        console.error("Erro ao buscar dados da análise:", error);
        alert("Ocorreu um erro ao carregar os dados da análise. Tente novamente.");
    }
}

function fecharModalAnaliseCusto() {
    modalAnaliseCustoBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => {
        modalAnaliseCusto.classList.add('hidden');
        document.body.classList.remove('overflow-hidden'); // <-- REMOVE A CLASSE
    }, 300);
}

// --- Funções Auxiliares para Cálculo e Formatação ---
function parseCurrency(value) {
    if (typeof value !== 'string' || value.trim() === '') return 0;
    // Remove "R$", pontos de milhar e substitui vírgula por ponto para conversão
    return parseFloat(value.replace("R$", "").trim().replace(/\./g, "").replace(",", ".")) || 0;
}

function formatCurrency(value) {
    if (isNaN(value) || value === null) value = 0;
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

// --- A Função Principal que faz a Mágica ---
function calcularAnaliseCusto() {
    // 1. Pega os valores dos inputs de CUSTO
    const custoMaoDeObra = parseCurrency(document.getElementById('ac-mao-de-obra').value);
    const custoMateriais = parseCurrency(document.getElementById('ac-materiais').value);
    let totalDespesasExtras = 0;
    document.querySelectorAll('.despesa-dinamica-row').forEach(row => {
        totalDespesasExtras += parseCurrency(row.querySelector('.despesa-valor').value);
    });

    // 2. Pega os valores de IMPOSTO
    const percImpostoServico = parseFloat(document.getElementById('ac-imposto-servico').value.replace(",", ".")) || 0;
    const percImpostoMaterial = parseFloat(document.getElementById('ac-imposto-material').value.replace(",", ".")) || 0;
    
    // 3. Pega a RECEITA BRUTA
    const receitaBrutaTotal = parseCurrency(document.getElementById('ac-valor-obra').value);
    
    // PRECISAMOS DOS VALORES BRUTOS SEPARADOS, QUE JÁ BUSCAMOS ANTES
    // Acessamos de uma variável global que será definida ao abrir o modal
    const valorImpostoServico = (window.totalServicosBruto || 0) * (percImpostoServico / 100);
    const valorImpostoMaterial = (window.totalMateriaisBruto || 0) * (percImpostoMaterial / 100);

    // 4. Calcula totais
    const receitaLiquida = receitaBrutaTotal - valorImpostoServico - valorImpostoMaterial;
    const custoTotal = custoMaoDeObra + custoMateriais + totalDespesasExtras;
    const lucroLiquido = receitaLiquida - custoTotal;
    const dizimo = lucroLiquido > 0 ? lucroLiquido * 0.10 : 0;
    
    // 5. Calcula o 'Soma de Todos os Custos e Impostos' para exibição
    const somaDeTodasAsSaidas = custoTotal + valorImpostoServico + valorImpostoMaterial;

    // 6. Atualiza a interface
    document.getElementById('ac-resultado-custo-total').textContent = formatCurrency(somaDeTodasAsSaidas);
    document.getElementById('ac-resultado-lucro').textContent = formatCurrency(lucroLiquido);
    document.getElementById('ac-resultado-dizimo').textContent = formatCurrency(dizimo);

    // 7. Feedback Visual (continua igual)
    const lucroCard = document.getElementById('ac-lucro-card');
    if (lucroLiquido >= 0) {
        lucroCard.classList.remove('bg-red-600');
        lucroCard.classList.add('bg-green-600');
    } else {
        lucroCard.classList.remove('bg-green-600');
        lucroCard.classList.add('bg-red-600');
    }
}

async function salvarAnaliseCusto() {
    const orcamentoId = document.getElementById('analise-custo-orcamento-id').value;
    
    // Elementos do botão
    const btn = document.getElementById('btn-salvar-analise');
    const icon = document.getElementById('btn-salvar-analise-icon');
    const spinner = document.getElementById('btn-salvar-analise-spinner');
    const text = document.getElementById('btn-salvar-analise-text');

    // Estado 1: "Salvando..."
    btn.disabled = true;
    icon.classList.add('hidden');
    spinner.classList.remove('hidden');
    text.textContent = 'Salvando...';
    // Remove cores de feedback anteriores para garantir que o botão volte a ser índigo
    btn.classList.remove('bg-emerald-500', 'bg-red-600');
    btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');

    const despesasExtrasList = [];
    document.querySelectorAll('.despesa-dinamica-row').forEach(row => {
        const descricao = row.querySelector('.despesa-descricao').value.trim();
        const valor = parseCurrency(row.querySelector('.despesa-valor').value);
        if (descricao && valor > 0) {
            despesasExtrasList.push({ descricao: descricao, valor: valor });
        }
    });

    const dadosParaSalvar = {
        valor_obra_total: parseCurrency(document.getElementById('ac-valor-obra').value),
        percentual_imposto_servico: parseFloat(document.getElementById('ac-imposto-servico').value.replace(',', '.')) || 0,
        percentual_imposto_material: parseFloat(document.getElementById('ac-imposto-material').value.replace(',', '.')) || 0,
        custo_mao_de_obra: parseCurrency(document.getElementById('ac-mao-de-obra').value),
        custo_materiais: parseCurrency(document.getElementById('ac-materiais').value),
        despesas_extras: despesasExtrasList
    };

    try {
        const response = await fetch(`/api/orcamento/${orcamentoId}/analise-custo`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dadosParaSalvar),
        });

        if (!response.ok) {
            const result = await response.json().catch(() => ({ detail: 'Erro de comunicação.' }));
            throw new Error(result.detail || 'Erro ao salvar os dados.');
        }
        
        // Estado 2: Sucesso
        analiseJaFoiSalva = true; // Atualiza a flag para o botão Gerar PDF
        
        spinner.classList.add('hidden');
        text.textContent = 'Salvo!';
        
        // Troca o SVG para o ícone de "check"
        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" stroke="currentColor" fill="none" stroke-width="2"/>`; 
        icon.classList.remove('hidden');
        
        // Muda a cor do botão para verde
        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        btn.classList.add('bg-emerald-500');

        // Volta ao estado normal após 1.5 segundos
        setTimeout(() => {
            btn.disabled = false;
            text.textContent = 'Salvar Análise';
            // Restaura o SVG original do ícone de disquete
            icon.innerHTML = `<path d="M5 4a2 2 0 012-2h6.293a2 2 0 011.414.586l2.828 2.828A2 2 0 0118 6.707V16a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V5a1 1 0 00-1-1H8z" />`;
            btn.classList.remove('bg-emerald-500');
            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        }, 1500);

    } catch (error) {
        console.error("Erro ao salvar análise de custo:", error);
        
        // Estado 3: Erro
        spinner.classList.add('hidden');
        text.textContent = 'Erro ao Salvar';

        // Troca o ícone para um "X" de erro
        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" stroke="currentColor" fill="none" stroke-width="2"/>`;
        icon.classList.remove('hidden');
        
        // Muda a cor do botão para vermelho
        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        btn.classList.add('bg-red-600');

        // Exibe o alerta com o erro
        alert(`Ocorreu um erro: ${error.message}`);
        
        // Restaura o botão ao estado normal IMEDIATAMENTE após o usuário fechar o alert
        btn.disabled = false;
        text.textContent = 'Salvar Análise';
        icon.innerHTML = `<path d="M5 4a2 2 0 012-2h6.293a2 2 0 011.414.586l2.828 2.828A2 2 0 0118 6.707V16a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V5a1 1 0 00-1-1H8z" />`;
        btn.classList.remove('bg-red-600');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
    }
}

function gerarRelatorioCusto() {
    const orcamentoId = document.getElementById('analise-custo-orcamento-id').value;
    if (!orcamentoId) {
        alert("ID do orçamento não encontrado.");
        return;
    }

    if (!analiseJaFoiSalva) {
        alert("Por favor, salve a análise pelo menos uma vez antes de gerar o relatório em PDF.");
        return;
    }

    // 1. Monta a URL do PDF do relatório de custo.
    const pdfUrl = `/orcamento/${orcamentoId}/relatorio-custo`;

    // 2. Navega para a nossa página de visualização, passando a URL do PDF como parâmetro.
    window.location.href = `/visualizar-pdf?url=${encodeURIComponent(pdfUrl)}`;

    // 3. (Opcional, mas recomendado) Fecha o modal de análise após iniciar a navegação.
    fecharModalAnaliseCusto();
}

window.editarOrcamento = function(id) { window.location.href = `/editar-orcamento/${id}`; }
function isMobile() { return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent); }
window.mascara = function(e, pattern) {
  let i = 0;
  const v = e.target.value.replace(/\D/g, "");
  e.target.value = pattern.replace(/#/g, () => v[i++] || "");
}
// --- MODAL DE SELEÇÃO DE DOCUMENTO (EMAIL/WHATSAPP) ---
window.abrirModalTipoDocumento = function(orcamentoId, acao) {
    tipoDocumentoOrcamentoIdInput.value = orcamentoId;
    modalTipoDocumento.dataset.acao = acao;
    btnConfirmarTipoDocumento.textContent = 'Confirmar';
    document.querySelector('input[name="tipo_documento_escolha"][value="Orçamento"]').checked = true;
    modalTipoDocumento.classList.remove('hidden');
    modalTipoDocumento.classList.add('flex');
    setTimeout(() => { modalTipoDocumentoBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
}

function fecharModalTipoDocumento() {
    modalTipoDocumentoBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => { modalTipoDocumento.classList.add('hidden'); modalTipoDocumento.classList.remove('flex'); }, 300);
}

// --- MODAL DE PDF (GERAR NOTA/ORÇAMENTO) ---
window.abrirModalStatusPDF = function(orcamentoId) {
    pdfOrcamentoIdInput.value = orcamentoId;
    modalStatusPdf.classList.remove('hidden');
    modalStatusPdf.classList.add('flex');
    setTimeout(() => { modalStatusPdfBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);
}

function fecharModalStatusPDF() {
    modalStatusPdfBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => { modalStatusPdf.classList.add('hidden'); modalStatusPdf.classList.remove('flex'); }, 300);
}

// --- MODAL DE E-MAIL (Nova lógica) ---
function abrirModalEmail(orcamentoId, tipoDocumento) {
    document.getElementById('email-orcamento-id').value = orcamentoId;
    document.getElementById('email-tipo-documento').value = tipoDocumento;
    document.getElementById('email-manual-input').value = ''; 
    
    const listaContatosDiv = document.getElementById('lista-contatos-email');
    listaContatosDiv.innerHTML = `<p class="text-gray-500 text-sm p-2">Carregando...</p>`;

    modalEmail.classList.remove('hidden');
    modalEmail.classList.add('flex');
    setTimeout(() => { modalEmailBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);

    fetch(`/api/orcamento/${orcamentoId}/emails`)
        .then(res => res.ok ? res.json() : Promise.reject('Falha na resposta da API'))
        .then(contatosComEmail => {
            listaContatosDiv.innerHTML = '';
            if (contatosComEmail.length === 0) {
                listaContatosDiv.innerHTML = `<p class="text-red-500 text-sm p-2">Nenhum e-mail encontrado para este cliente.</p>`;
                return;
            }
            contatosComEmail.forEach(contato => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer";
                label.innerHTML = `
                    <input type="checkbox" value="${contato.email}" class="h-4 w-4 rounded border-gray-300">
                    <span class="text-gray-700">${contato.nome} (${contato.email})</span>`;
                listaContatosDiv.appendChild(label);
            });
        })
        .catch(error => {
            console.error("Erro ao buscar e-mails:", error);
            listaContatosDiv.innerHTML = `<p class="text-red-500 text-sm p-2">Erro ao carregar lista de e-mails.</p>`;
        });
}

function fecharModalEmail() {
    modalEmailBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => { modalEmail.classList.add('hidden'); modalEmail.classList.remove('flex'); }, 300);
}

async function enviarEmailsSelecionados() {
    const orcamentoId = document.getElementById('email-orcamento-id').value;
    const tipoDocumento = document.getElementById('email-tipo-documento').value;
    const checkboxes = document.querySelectorAll('#lista-contatos-email input[type="checkbox"]:checked');
    
    const btn = document.getElementById('btn-enviar-email-final');
    const emailsSelecionados = Array.from(checkboxes).map(cb => cb.value);
    const emailManual = document.getElementById('email-manual-input').value.trim();

    let destinatariosFinais = [...emailsSelecionados];
    if (emailManual) { destinatariosFinais.push(emailManual); }
    if (destinatariosFinais.length === 0) { alert("Por favor, selecione ou digite pelo menos um e-mail para enviar."); return; }
    
    btn.disabled = true;
    btn.innerHTML = 'Gerando...';
    const destinatariosString = destinatariosFinais.join(',');

    try {
      await fetch(`/orcamento/${orcamentoId}/pdf?status=${encodeURIComponent(tipoDocumento)}`);
      const formData = new FormData();
      formData.append('destinatario', destinatariosString);
      const response = await fetch(`/orcamento/${orcamentoId}/email/link?status=${encodeURIComponent(tipoDocumento)}`, { method: 'POST', body: formData });
      if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Falha ao gerar o link de e-mail.");
      }
      const data = await response.json();
      window.location.href = data.mailto_link;
    } catch (error) {
        alert(`Ocorreu um erro: ${error.message}`);
    } finally {
        fecharModalEmail();
        btn.disabled = false;
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a2 2 0 00-2 2v1.161l8.441 4.221a1.25 1.25 0 001.118 0L19 7.162V6a2 2 0 00-2-2H3z" /><path d="M19 8.839l-7.77 3.885a2.75 2.75 0 01-2.46 0L1 8.839V14a2 2 0 002 2h14a2 2 0 002-2V8.839z" /></svg> Enviar para Selecionados`;
    }
}


// --- MODAL DE WHATSAPP ---
function abrirModalWhatsApp(orcamentoId, telefonePrincipal, tipoDeDocumento, nomeCliente) {
    document.getElementById('whatsapp-manual-input').value = ''; 
    whatsappOrcamentoIdInput.value = orcamentoId;
    let hiddenTipo = document.getElementById('whatsapp-tipo-documento');
    if (!hiddenTipo) {
        hiddenTipo = document.createElement('input');
        hiddenTipo.type = 'hidden';
        hiddenTipo.id = 'whatsapp-tipo-documento';
        modalWhatsAppBox.appendChild(hiddenTipo);
    }
    hiddenTipo.value = tipoDeDocumento;

    const listaContatosDiv = document.getElementById('lista-contatos-whatsapp');
    listaContatosDiv.innerHTML = `<p class="text-gray-500 text-sm p-2">Carregando...</p>`;
    modalWhatsApp.classList.remove('hidden');
    modalWhatsApp.classList.add('flex');
    setTimeout(() => { modalWhatsAppBox.classList.remove('-translate-y-10', 'opacity-0'); }, 50);

    fetch(`/api/orcamento/${orcamentoId}/contatos`)
      .then(res => res.ok ? res.json() : Promise.reject('Falha na API'))
      .then(contatosExtras => {
        listaContatosDiv.innerHTML = '';
        if (contatosExtras.length === 0) {
            listaContatosDiv.innerHTML = `<p class="text-red-500 text-sm p-2">Nenhum telefone encontrado.</p>`;
            return;
        }
        contatosExtras.forEach(contato => {
            const label = document.createElement('label');
            label.className = "flex items-center gap-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer";
            label.innerHTML = `
                <input type="checkbox" value="${contato.telefone}" class="h-4 w-4 rounded border-gray-300">
                <span class="text-gray-700">${contato.nome} - ${contato.telefone}</span>`;
            listaContatosDiv.appendChild(label);
        });
    });
}

function fecharModalWhatsApp() {
    modalWhatsAppBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => { modalWhatsApp.classList.add('hidden'); modalWhatsApp.classList.remove('flex'); }, 300);
}

function abrirModalEditarCliente() {
    modalEditClient.classList.remove('hidden');
    setTimeout(() => {
        modalEditClientBox.classList.remove('-translate-y-10', 'opacity-0');
    }, 50);
}

function fecharModalEditarCliente() {
    modalEditClientBox.classList.add('-translate-y-10', 'opacity-0');
    setTimeout(() => {
        modalEditClient.classList.add('hidden');
    }, 300);
}

async function deletarOrcamento(id) {
    if (!confirm(`Tem certeza que deseja excluir o orçamento?`)) return;

    try {
      const response = await fetch(`/api/orcamentos/${id}`, { method: 'DELETE' });
      if (response.status === 204) {
        const card = document.getElementById(`orcamento-card-${id}`);
        if (card) {
          card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.95)';
          setTimeout(() => card.remove(), 500);
        }
      } else {
        const errorData = await response.json();
        throw new Error(errorData.detail || "Falha ao excluir o orçamento.");
      }
    } catch (error) {
      console.error("Erro ao deletar orçamento:", error);
      alert("Ocorreu um erro: " + error.message);
    }
}

function abrirModalConfig() {
  document.querySelectorAll('.config-panel').forEach(panel => panel.classList.add('hidden'));
  document.getElementById('config-menu').classList.remove('hidden');
  modal.classList.remove('hidden');
  setTimeout(() => {
      modal.classList.add('backdrop-blur-sm');
      sidebarPanel.classList.remove('translate-x-full');
  }, 10);
}

function fecharModalConfig() {
  modal.classList.remove('backdrop-blur-sm');
  sidebarPanel.classList.add('translate-x-full');
  setTimeout(() => { modal.classList.add('hidden'); }, 300);
}

async function carregarListaUsuarios() {
  const container = document.getElementById('lista-usuarios');
  container.innerHTML = `<p class="text-gray-500 text-sm">Carregando...</p>`;
  try {
    const response = await fetch('/api/users/');
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || "Falha ao carregar usuários.");
    }
    const users = await response.json();
    container.innerHTML = '';
    if (users.length <= 1) {
        container.innerHTML = `<p class="text-gray-400 text-sm">Nenhum outro usuário cadastrado.</p>`;
        return;
    }
    users.forEach(user => {
      if (user.username === "{{ user.username }}") return;
      const userDiv = document.createElement('div');
      userDiv.className = 'flex items-center justify-between p-2 bg-white rounded-md border';
      userDiv.id = `user-row-${user.id}`;
      userDiv.innerHTML = `
          <span class="text-gray-700 font-medium">${user.username}</span>
          <button onclick="deletarUsuario(${user.id}, '${user.username}')" class="px-2 py-1 text-xs font-semibold text-red-700 bg-red-100 rounded-md hover:bg-red-200">Apagar</button>`;
      container.appendChild(userDiv);
    });
  } catch (error) {
    console.error("Erro ao carregar usuários:", error);
    container.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
  }
}

async function definirDataPersonalizada() {
  const userId = userSelect.value;
  const customDate = document.getElementById('custom-date-input').value;

  if (!userId || !customDate) {
      alert("Por favor, selecione um usuário e uma data de expiração válida.");
      return;
  }
  
  const username = userSelect.options[userSelect.selectedIndex].text;
  const formattedDate = new Date(customDate + 'T00:00:00').toLocaleDateString('pt-BR');
  
  if(!confirm(`Confirma a nova data de expiração de "${username}" para ${formattedDate}?`)) return;

  const formData = new FormData();
  formData.append('user_id', userId);
  formData.append('action', 'custom_date');
  formData.append('custom_date', customDate);

  try {
    const response = await fetch('/api/admin/user/update-access', { method: 'POST', body: formData });
    const result = await response.json();
    if (!response.ok) throw new Error(result.detail || 'Erro no servidor.');
    
    alert(result.message);
    document.getElementById('custom-date-input').value = ''; // Limpa o input
    await mostrarStatusUsuario(); // Atualiza a exibição do status
  } catch(error) {
    alert(`Erro: ${error.message}`);
  }
}

async function carregarListaClientes() {
  const container = document.getElementById('client-list-container');
  container.innerHTML = `<p class="text-gray-500 text-center py-4">Carregando clientes...</p>`;
  try {
    const response = await fetch('/api/clientes/');
    if (!response.ok) { throw new Error('Falha ao buscar os dados dos clientes.'); }
    const clientes = await response.json();
    if (clientes.length === 0) {
        container.innerHTML = `<p class="text-gray-400 text-center py-4">Nenhum cliente cadastrado ainda.</p>`;
        return;
    }
    container.innerHTML = ''; 
    clientes.forEach(cliente => {
        const clientCard = document.createElement('div');
        clientCard.className = 'bg-white border rounded-lg p-3 space-y-2';
        clientCard.id = `client-card-${cliente.id}`;
        let contatosInfo = '<span class="text-xs text-gray-400">Nenhum contato adicional.</span>';
        if (cliente.contatos.length > 0) {
            const nomesContatos = cliente.contatos.map(c => c.nome).join(', ');
            contatosInfo = `<span class="text-xs text-gray-500" title="${nomesContatos}">${cliente.contatos.length} contato(s): ${nomesContatos}</span>`;
        }
        clientCard.innerHTML = `
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-semibold text-gray-800">${cliente.nome}</p>
                    <p class="text-sm text-gray-500">${cliente.telefone || 'Sem telefone principal'}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="editarCliente(${cliente.id})" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full transition-colors" title="Editar Cliente"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                    <button onclick="deletarCliente(${cliente.id}, '${cliente.nome}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full transition-colors" title="Apagar Cliente"><svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                </div>
            </div>
            <div class="border-t pt-2 truncate">${contatosInfo}</div>`;
        container.appendChild(clientCard);
    });
  } catch (error) {
      console.error('Erro ao carregar clientes:', error);
      container.innerHTML = `<p class="text-red-500 text-center py-4">Não foi possível carregar os clientes.</p>`;
  }
}

async function deletarCliente(clienteId, nomeCliente) {
  if (!confirm(`Tem certeza que deseja apagar o cliente "${nomeCliente}" e todos os seus contatos?\n\nEsta ação é irreversível!`)) { return; }
  try {
      const response = await fetch(`/api/clientes/${clienteId}`, { method: 'DELETE' });
    if (response.ok) {
        const card = document.getElementById(`client-card-${clienteId}`);
        if (card) {
          card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.95)';
          setTimeout(() => {
              card.remove();
              const container = document.getElementById('client-list-container');
              if (container.children.length === 0) {
                  container.innerHTML = `<p class="text-gray-400 text-center py-4">Nenhum cliente cadastrado ainda.</p>`;
              }
          }, 300);
        }
    } else {
          const error = await response.json();
          throw new Error(error.detail || 'Falha ao apagar o cliente.');
    }
  } catch(error) { alert(`Erro: ${error.message}`); }
}

async function editarCliente(clienteId) {
  try {
    const response = await fetch(`/api/clientes/${clienteId}`);
    if (!response.ok) throw new Error('Não foi possível carregar os dados do cliente.');
    const cliente = await response.json();
    document.getElementById('edit-cliente-id').value = cliente.id;
    document.getElementById('edit-cliente-nome').value = cliente.nome;
    document.getElementById('edit-cliente-telefone').value = cliente.telefone || '';
    contatosContainer.innerHTML = '';
    if (cliente.contatos.length > 0) {
        cliente.contatos.forEach(contato => { adicionarNovoContatoForm(contato); });
    } else {
        contatosContainer.innerHTML = `<p id="sem-contatos-msg" class="text-gray-400 text-sm text-center py-4">Nenhum contato adicional.</p>`;
    }
    abrirModalEditarCliente();
  } catch(error) { alert(`Erro: ${error.message}`); }
}

function adicionarNovoContatoForm(contato = null) {
    const msg = document.getElementById('sem-contatos-msg');
    if (msg) msg.remove();
    const formClone = contatoFormTemplate.content.cloneNode(true);
    const formRow = formClone.querySelector('.contact-form-row');
    if (contato) {
        formRow.dataset.id = contato.id;
        formRow.querySelector('.contato-nome').value = contato.nome;
        formRow.querySelector('.contato-telefone').value = contato.telefone;
        formRow.querySelector('.contato-email').value = contato.email || '';
    }
    contatosContainer.appendChild(formClone);
}

async function salvarClienteAtualizado() {
  const clienteId = document.getElementById('edit-cliente-id').value;
  const saveButton = document.querySelector('#modal-edit-client-box button[onclick="salvarClienteAtualizado()"]');
  const saveIcon = document.getElementById('save-icon');
  const saveSpinner = document.getElementById('save-spinner');

  saveButton.disabled = true;
  saveIcon.classList.add('hidden');
  saveSpinner.classList.remove('hidden');

  const contatosRows = document.querySelectorAll('#contatos-container .contact-form-row');
  const contatosPayload = Array.from(contatosRows).map(row => ({
    id: row.dataset.id ? parseInt(row.dataset.id) : null,
    nome: row.querySelector('.contato-nome').value,
    telefone: row.querySelector('.contato-telefone').value,
    email: row.querySelector('.contato-email').value
  }));

  const payload = {
    nome: document.getElementById('edit-cliente-nome').value,
    telefone: document.getElementById('edit-cliente-telefone').value,
    contatos: contatosPayload
  };
    
  try {
    const response = await fetch(`/api/clientes/${clienteId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Falha ao salvar o cliente.');
    }
    fecharModalEditarCliente();
    await carregarListaClientes();
  } catch(error) {
      alert(`Erro: ${error.message}`);
  } finally {
      saveButton.disabled = false;
      saveIcon.classList.remove('hidden');
      saveSpinner.classList.add('hidden');
  }
}

async function deletarUsuario(userId, username) {
    if (!confirm(`Tem certeza que deseja apagar permanentemente o usuário "${username}"?\nTODOS os orçamentos e clientes deste usuário serão perdidos.`)) { return; }
    try {
        const response = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
        if (response.status === 204) {
            alert(`Usuário "${username}" apagado com sucesso!`);
            const userRow = document.getElementById(`user-row-${userId}`);
            if (userRow) userRow.remove();
        } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Falha ao apagar o usuário.");
        }
    } catch (error) {
        console.error("Erro ao apagar usuário:", error);
        alert(`Ocorreu um erro: ${error.message}`);
    }
}

async function resetarContador() {
    const inputNumero = document.getElementById('novo_numero_inicial');
    const novoValor = inputNumero.value;
    if (novoValor === "" || isNaN(parseInt(novoValor)) || parseInt(novoValor) < 1) { // Garante que o número seja pelo menos 1
        alert("Por favor, insira um número válido (1 ou maior)."); 
        return; 
    }

    // CORREÇÃO 1: Mensagem de confirmação mais clara.
    if (!confirm(`Tem certeza? O próximo orçamento a ser criado será o Nº ${String(parseInt(novoValor)).padStart(4, '0')}.`)) return;

    try {
        const formData = new FormData();
        // CORREÇÃO 2: Alterado o nome do campo para corresponder ao backend.
        formData.append('proximo_numero_desejado', novoValor); 
        
        const response = await fetch('/api/resetar-contador/', { method: 'POST', body: formData });
        const result = await response.json();
        
        if (!response.ok) {
            // Tenta extrair uma mensagem de erro mais legível.
            const errorMsg = result.detail || "Ocorreu um erro desconhecido.";
            throw new Error(errorMsg);
        }

        alert(result.message);
        fecharModalConfig();
        // Opcional: Recarregar a página para que o novo número apareça na página de criação.
        window.location.href = '/'; 

    } catch (error) {
        console.error("Erro ao resetar contador:", error);
        // Agora o alerta exibirá a mensagem de erro correta, e não [object Object].
        alert(`Ocorreu um erro: ${error.message}`);
    }
}

async function atualizarModeloPDF() {
    const select = document.getElementById('admin-template-select');
    const novoModelo = select.value;
    if (!confirm(`Tem certeza que deseja mudar seu modelo de PDF para '${novoModelo.charAt(0).toUpperCase() + novoModelo.slice(1)}'?`)) { return; }
    const formData = new FormData();
    formData.append('new_template', novoModelo);
    try {
        const response = await fetch('/api/user/update-template', { method: 'POST', body: formData });
        const result = await response.json();
        if (!response.ok) { throw new Error(result.detail || "Ocorreu um erro desconhecido."); }
        alert(result.message);
        fecharModalConfig();
    } catch (error) {
        console.error("Erro ao atualizar modelo de PDF:", error);
        alert(`Ocorreu um erro: ${error.message}`);
    }
}

async function cadastrarNovoUsuario() {
    const usernameInput = document.getElementById('new-username');
    const passwordInput = document.getElementById('new-password');
    const templateInput = document.getElementById('new-template');
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();
    const template = templateInput.value;
    if (!username || !password) { alert("Por favor, preencha o nome de usuário e a senha."); return; }
    const formData = new FormData();
    formData.append('username', username);
    formData.append('password', password);
    formData.append('pdf_template_name', template);
    try {
        const response = await fetch('/api/users/', { method: 'POST', body: formData });
        const result = await response.json();
        if (!response.ok) { throw new Error(result.detail || "Erro desconhecido ao cadastrar usuário."); }
        alert(result.message);
        usernameInput.value = '';
        passwordInput.value = '';
        carregarListaUsuarios();
    } catch (error) {
        console.error("Erro ao cadastrar usuário:", error);
        alert(`Ocorreu um erro: ${error.message}`);
    }
}

function setupSidebarNavigation() {
  const sidebarLinks = document.querySelectorAll('.sidebar-link');
  const configPanels = document.querySelectorAll('.config-panel');
  const backButtons = document.querySelectorAll('.back-to-menu');
  const menuPanel = document.getElementById('config-menu');

  sidebarLinks.forEach(link => {
    if (link.getAttribute('data-target')) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const targetPanelId = this.getAttribute('data-target');
          const targetPanel = document.getElementById(targetPanelId);
          if (targetPanel) {
            if (targetPanelId === 'panel-manage-users') { carregarListaUsuarios(); }
            if (targetPanelId === 'panel-manage-clients') { carregarListaClientes(); }
            if (targetPanelId === 'panel-access-control') { carregarUsuariosParaControle(); }
            menuPanel.classList.add('hidden');
            targetPanel.classList.remove('hidden');
          }
        });
    }
  });

  backButtons.forEach(button => {
      button.addEventListener('click', function(e) {
          e.preventDefault();
          this.closest('.config-panel').classList.add('hidden');
          menuPanel.classList.remove('hidden');
      });
  });
}

async function carregarUsuariosParaControle() {
  userSelect.innerHTML = '<option value="">Carregando...</option>';
  userStatusDetails.classList.add('hidden');
  userAccessActions.classList.add('hidden');
  
  try {
    const response = await fetch('/api/admin/users/');
    if (!response.ok) throw new Error('Falha ao carregar usuários.');
    const users = await response.json();
    
    userSelect.innerHTML = '<option value="">-- Selecione um usuário para gerenciar --</option>';
    if (users.length === 0) {
      userSelect.innerHTML = '<option value="">Nenhum outro usuário cadastrado.</option>';
      return;
    }

    users.forEach(user => {
      userSelect.innerHTML += `<option value="${user.id}">${user.username}</option>`;
    });
  } catch (error) {
    console.error(error);
    userSelect.innerHTML = `<option value="">Erro ao carregar</option>`;
  }
}

async function mostrarStatusUsuario() {
  const userId = userSelect.value;
  if (!userId) {
    userStatusDetails.classList.add('hidden');
    userAccessActions.classList.add('hidden');
    return;
  }

  try {
    const response = await fetch(`/api/admin/user/${userId}/status`);
    if (!response.ok) throw new Error('Falha ao obter status do usuário.');
    const user = await response.json(); 

    let statusTexto = 'Padrão (Acesso Expirado)';
    let statusClass = 'bg-red-200 text-red-800'; // Classe para status expirado

    if (user.plano_ilimitado) {
      statusTexto = 'Vitalício';
      statusClass = 'bg-emerald-200 text-emerald-800';
    } else if (user.data_expiracao) {
      const dataExp = new Date(user.data_expiracao);
      if (dataExp > new Date()) {
        statusTexto = `Válido até ${dataExp.toLocaleDateString('pt-BR')}`;
        statusClass = 'bg-blue-200 text-blue-800';
      }
    }

    statusAcessoEl.textContent = statusTexto;
    statusAcessoEl.className = `font-mono p-1 rounded text-xs ${statusClass}`; // Aplica a classe de cor
    
    userStatusDetails.classList.remove('hidden');
    userAccessActions.classList.remove('hidden');

  } catch (error) {
    console.error(error);
    alert('Erro ao carregar os dados do usuário.');
  }
}

async function handleAccessUpdate(action) {
  const userId = userSelect.value;
  if (!userId) return;

  const username = userSelect.options[userSelect.selectedIndex].text;
  const actionText = {
    'lifetime': `conceder acesso VITALÍCIO para "${username}"?`,
    'monthly': `liberar acesso por 30 dias para "${username}"?`,
    'default': `REVERTER o acesso de "${username}" para o padrão (EXPIRADO)? Esta ação bloqueará o usuário imediatamente.`
  }[action];
  
  if (!confirm(`Tem certeza que deseja ${actionText}`)) return;

  const formData = new FormData();
  formData.append('user_id', userId);
  formData.append('action', action);

  try {
    const response = await fetch('/api/admin/user/update-access', { method: 'POST', body: formData });
    const result = await response.json();
    if (!response.ok) throw new Error(result.detail || 'Erro no servidor.');
    
    alert(result.message);
    await mostrarStatusUsuario(); // Atualiza a exibição do status
  } catch (error) {
    alert(`Erro: ${error.message}`);
  }
}

async function ajustarTotens() {
  const userId = userSelect.value;
  const ajuste = parseInt(ajusteTotensInput.value, 10);
  if (!userId || isNaN(ajuste)) {
      alert("Selecione um usuário e digite um valor numérico para o ajuste (ex: 5 para adicionar, -2 para remover).");
      return;
  }
  
  const username = userSelect.options[userSelect.selectedIndex].text;
  if(!confirm(`Confirma o ajuste de ${ajuste} totens para o usuário "${username}"?`)) return;

  const formData = new FormData();
  formData.append('user_id', userId);
  formData.append('adjustment', ajuste);

  try {
    const response = await fetch('/api/admin/user/adjust-totens', { method: 'POST', body: formData });
    const result = await response.json();
    if (!response.ok) throw new Error(result.detail || 'Erro no servidor.');
    
    alert(result.message);
    ajusteTotensInput.value = ''; // Limpa o input
    await mostrarStatusUsuario(); // Atualiza a exibição
  } catch(error) {
    alert(`Erro: ${error.message}`);
  }
}

// Funções globais para serem chamadas pelos botões
window.concederAcessoVitalicio = () => handleAccessUpdate('lifetime');
window.concederAcessoMensal = () => handleAccessUpdate('monthly');
window.reverterParaPadrao = () => handleAccessUpdate('default');
window.definirDataPersonalizada = definirDataPersonalizada;

function inicializar() {
    modal.addEventListener('click', (e) => { if (e.target === modal) fecharModalConfig(); });
    modalStatusPdf.addEventListener('click', (e) => { if(e.target === modalStatusPdf) fecharModalStatusPDF(); });
    modalEmail.addEventListener('click', (e) => { if (e.target === modalEmail) fecharModalEmail(); });
    modalWhatsApp.addEventListener('click', (e) => { if (e.target === modalWhatsApp) fecharModalWhatsApp(); });
    btnsFecharModalTipoDocumento.forEach(btn => btn.addEventListener('click', fecharModalTipoDocumento));
    modalTipoDocumento.addEventListener('click', (e) => { if (e.target === modalTipoDocumento) fecharModalTipoDocumento(); });
    document.getElementById('whatsapp-manual-input').addEventListener('input', (e) => mascara(e, '(##) #####-####'));
    userSelect.addEventListener('change', mostrarStatusUsuario);

    modalAnaliseCusto.addEventListener('click', (e) => { 
        if (e.target === modalAnaliseCusto) fecharModalAnaliseCusto(); 
    });
    
    // Pega todos os inputs da nossa nova calculadora
    const inputsAnaliseCusto = document.querySelectorAll('.analise-custo-input');

    inputsAnaliseCusto.forEach(input => {
        // Quando o usuário DIGITA, recalcula tudo em tempo real
        input.addEventListener('input', () => {
            // Se o campo for de porcentagem, permite vírgula
            if (input.id !== 'ac-imposto') {
                 // Máscara de moeda simples
                let value = input.value.replace(/\D/g, "");
                if (value) {
                    value = (parseFloat(value) / 100).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    input.value = "R$ " + value;
                } else {
                    input.value = '';
                }
            }
            calcularAnaliseCusto();
        });
        
        // Quando o usuário CLICA FORA, garante a formatação
        input.addEventListener('blur', () => {
             if (input.id !== 'ac-imposto') {
                const numericValue = parseCurrency(input.value);
                input.value = formatCurrency(numericValue);
             } else {
                const percValue = parseFloat(input.value.replace(',','.')) || 0;
                input.value = percValue.toFixed(2).replace('.',',') + ' %';
             }
        });
    });

    const camposDePorcentagem = [
        document.getElementById('ac-imposto-servico'), 
        document.getElementById('ac-imposto-material')
    ];

    camposDePorcentagem.forEach(input => {
        if (!input) return; // Se o elemento não existir, ignora

        // Ao digitar, recalcula
        input.addEventListener('input', calcularAnaliseCusto);

        // Ao sair do campo (blur), garante a formatação com " %"
        input.addEventListener('blur', () => {
             // Pega o valor, substitui vírgula por ponto para o cálculo,
             // e define 0 se o campo estiver vazio ou inválido.
             const percValue = parseFloat(input.value.replace(',', '.')) || 0;
             // Formata de volta para o padrão brasileiro com duas casas decimais e o símbolo de porcentagem.
             input.value = percValue.toFixed(2).replace('.', ',') + ' %';
        });

        // Ao focar (entrar) no campo, remove o " %" para facilitar a edição.
        input.addEventListener('focus', () => {
            input.value = input.value.replace(' %', '').trim();
        });
    });

    btnConfirmarTipoDocumento.addEventListener('click', async () => {
        const orcamentoId = tipoDocumentoOrcamentoIdInput.value;
        const tipoDocumento = document.querySelector('input[name="tipo_documento_escolha"]:checked').value;
        const acao = modalTipoDocumento.dataset.acao;
        fecharModalTipoDocumento();
        try {
            await fetch(`/orcamento/${orcamentoId}/pdf?status=${encodeURIComponent(tipoDocumento)}`);
            const orcamentoRes = await fetch('/api/orcamentos/');
            if (!orcamentoRes.ok) throw new Error("Falha ao buscar dados.");
            const orcamentos = await orcamentoRes.json();
            const orcamentoAtual = orcamentos.find(o => o.id === parseInt(orcamentoId));
            if (acao === 'whatsapp') {
                abrirModalWhatsApp(orcamentoId, orcamentoAtual?.telefone || '', tipoDocumento, orcamentoAtual?.nome || '');
            } else if (acao === 'email') {
                abrirModalEmail(orcamentoId, tipoDocumento);
            }
        } catch(e) { alert(e.message); }
    });

    document.getElementById('btn-gerar-orcamento').addEventListener('click', () => {
        const id = pdfOrcamentoIdInput.value;
        // 1. Monta a URL do arquivo PDF
        const pdfUrl = `/orcamento/${id}/pdf?status=Orçamento`;
        // 2. Navega para o visualizador, passando a URL do PDF como parâmetro
        window.location.href = `/visualizar-pdf?url=${encodeURIComponent(pdfUrl)}`;
        fecharModalStatusPDF();
    });

    document.getElementById('btn-gerar-nota').addEventListener('click', () => {
        const id = pdfOrcamentoIdInput.value;
        // 1. Monta a URL do arquivo PDF
        const pdfUrl = `/orcamento/${id}/pdf?status=Nota de Serviço`;
        // 2. Navega para o visualizador, passando a URL do PDF como parâmetro
        window.location.href = `/visualizar-pdf?url=${encodeURIComponent(pdfUrl)}`;
        fecharModalStatusPDF();
    });

  btnEnviarWhatsAppFinal.addEventListener('click', async () => {
    const orcamentoId = whatsappOrcamentoIdInput.value;
    const checkboxes = document.querySelectorAll('#lista-contatos-whatsapp input[type="checkbox"]:checked');
    const telefonesSelecionados = Array.from(checkboxes).map(check => check.value);
    const telefoneManual = document.getElementById('whatsapp-manual-input').value.trim();
    let telefonesParaEnviar = [...telefonesSelecionados];
    if (telefoneManual) { telefonesParaEnviar.push(telefoneManual); }
    if (telefonesParaEnviar.length === 0) { alert("Por favor, selecione ou digite pelo menos um número para enviar."); return; }
    
    const tipoDocumento = document.getElementById('whatsapp-tipo-documento').value;

    try {
        const response = await fetch(`/orcamento/${orcamentoId}/whatsapp?status=${encodeURIComponent(tipoDocumento)}`);
        if (!response.ok) throw new Error("Não foi possível gerar a mensagem.");
        const data = await response.json();
        const mensagemBase = data.whatsapp_message;

        telefonesParaEnviar.forEach((telefone, index) => {
          const telefoneLimpo = telefone.replace(/\D/g, '');
          if (!telefoneLimpo) return;
          const telefoneFinal = telefoneLimpo.startsWith("55") ? telefoneLimpo : "55" + telefoneLimpo;
          const mensagemCodificada = encodeURIComponent(mensagemBase);
          const urlFinal = `https://wa.me/${telefoneFinal}?text=${mensagemCodificada}`;
          setTimeout(() => {
            if (isMobile()) {
              let win = window.open(`whatsapp://send?phone=${telefoneFinal}&text=${mensagemCodificada}`);
                setTimeout(() => {
                  if (!win || win.closed || typeof win.closed === 'undefined') { window.open(urlFinal, '_blank'); }
                }, 700);
            } else { window.open(urlFinal, '_blank'); }
          }, index * 400);
        });
        fecharModalWhatsApp();
    } catch (error) { alert("Ocorreu um erro: " + error.message); }
  });
    
    document.getElementById('btn-enviar-email-final').onclick = enviarEmailsSelecionados;

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('atualizado')) {
        const notificacao = document.createElement('div');
        notificacao.className = 'fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg';
        notificacao.innerText = 'Orçamento atualizado com sucesso!';
        document.body.appendChild(notificacao);
        setTimeout(() => { notificacao.remove(); window.history.replaceState({}, document.title, "/orcamentos"); }, 3000);
    }
    
    carregarOrcamentos();
    setupSidebarNavigation();
    tippy('[data-tippy-content]');
}

document.addEventListener('DOMContentLoaded', inicializar);

</script>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/static/sw.js').then(registration => {
                console.log('ServiceWorker registrado com sucesso:', registration.scope);
            }).catch(error => {
                console.log('Falha ao registrar o ServiceWorker:', error);
            });
        });
    }
</script>
</body>
</html>